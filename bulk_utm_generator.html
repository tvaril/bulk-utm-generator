<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üîó</text></svg>">
    <title>UTM Generator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }
        .container {
            max-width: 100%;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #1e88e5 0%, #1565c0 100%);
            color: white;
            padding: 20px 30px;
        }
        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }
        .header p {
            opacity: 0.9;
            font-size: 14px;
        }
        .version-badge {
            display: inline-block;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 14px;
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: 500;
            margin-left: 10px;
            vertical-align: middle;
        }
        .toolbar {
            background: #fafafa;
            padding: 15px 30px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            position: relative;
            z-index: 5;
            align-items: center;
        }
        button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }
         /* Smaller buttons for settings section */
        .settings-block button.btn-small {
            padding: 4px 8px;
            font-size: 12px;
        }

        .btn-primary {
            background: #1e88e5;
            color: white;
        }
        .btn-primary:hover {
            background: #1565c0;
        }
        .btn-success {
            background: #43a047;
            color: white;
        }
        .btn-success:hover {
            background: #2e7d32;
        }
        .btn-secondary {
            background: #757575;
            color: white;
        }
        .btn-secondary:hover {
            background: #616161;
        }
        .btn-danger {
            background: #e53935;
            color: white;
        }
        .btn-danger:hover {
            background: #c62828;
        }
        .btn-info {
            background: #00acc1;
            color: white;
        }
        .btn-info:hover {
            background: #00838f;
        }
         .btn-warning {
             background: #ffa726;
             color: white;
         }
         .btn-warning:hover {
             background: #fb8c00;
         }
        .table-container {
            overflow-x: auto;
            padding: 20px 30px;
            position: relative;
            z-index: 10;
        }
        table {
            border-collapse: collapse;
            table-layout: fixed;
        }
        th, td {
            white-space: nowrap;
        }
        th {
            background: #1e88e5;
            color: white;
            padding: 12px 8px;
            text-align: left;
            font-size: 12px;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 100;
            cursor: help;
        }
        th.required::after {
            content: ' *';
            color: #ffeb3b;
        }
        .tooltip-container {
            position: relative;
            display: inline-block;
        }
        .tooltip-icon {
            display: inline-block;
            width: 16px;
            height: 16px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            text-align: center;
            line-height: 16px;
            font-size: 11px;
            margin-left: 4px;
            cursor: help;
            vertical-align: middle;
        }
        .tooltip-text {
            visibility: hidden;
            width: 280px;
            background-color: #333;
            color: #fff;
            text-align: left;
            border-radius: 6px;
            padding: 12px;
            position: absolute;
            z-index: 9999;
            top: 100%;
            left: 50%;
            margin-left: -140px;
            margin-top: 10px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
            line-height: 1.5;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            white-space: normal; /* Allows text wrapping in tooltip */
        }
        .tooltip-text::before {
            content: "";
            position: absolute;
            bottom: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: transparent transparent #333 transparent;
        }
        th:hover .tooltip-text,
        .tooltip-icon:hover + .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        .tooltip-example {
            color: #90caf9;
            font-style: italic;
            display: block;
            margin-top: 6px;
            font-size: 11px;
        }
        td {
            padding: 4px;
            border-bottom: 1px solid #e0e0e0;
            position: relative;
        }
        /* Rules for hidden columns (default state) */
        .col-platform, .col-format, .col-tactic {
            display: none;
        }
        .quick-fill-item.col-platform,
        .quick-fill-item.col-format,
        .quick-fill-item.col-tactic {
            display: none;
        }
        /* Display when activated */
        body.show-platform th.col-platform,
        body.show-platform td.col-platform {
            display: table-cell;
        }
        body.show-platform .quick-fill-item.col-platform {
            display: flex;
        }
        body.show-format th.col-format,
        body.show-format td.col-format {
            display: table-cell;
        }
        body.show-format .quick-fill-item.col-format {
            display: flex;
        }
        body.show-tactic th.col-tactic,
        body.show-tactic td.col-tactic {
            display: table-cell;
        }
        body.show-tactic .quick-fill-item.col-tactic {
            display: flex;
        }

        tr:hover {
            background: #f5f5f5;
        }
        tr.generating {
            background: #e3f2fd;
            animation: pulse 0.3s;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        input[type="text"], input[type="url"], input[type="number"], select { /* Added select */
            width: 100%;
            box-sizing: border-box;
            min-width: 0;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 11px;
            font-family: inherit;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
         input[type="color"] { /* Style for color picker */
             padding: 0; /* Remove padding */
             border: 1px solid #ddd;
             width: 40px; /* Smaller width */
             height: 36px; /* Height alignment */
             cursor: pointer;
             vertical-align: middle; /* Better alignment with text field */
         }
         input[type="text"].hex-input { /* Style for text field with hex code */
            width: calc(100% - 50px); /* Width next to color picker */
            display: inline-block;
            vertical-align: middle;
            margin-left: 5px;
            font-family: monospace; /* Better for hex codes */
         }
        input:focus {
            outline: none;
            border-color: #1e88e5;
            box-shadow: 0 0 0 2px rgba(30, 136, 229, 0.1);
        }
        input[readonly] {
            background: #f5f5f5;
            cursor: not-allowed; /* Indicates field is not editable */
        }
        input[data-field="utmId"]:not([readonly]) { /* Style for editable utm_id */
             background: white;
             cursor: text;
        }

        .row-number {
            text-align: center;
            color: #757575;
            font-weight: 500;
            width: 40px;
            min-width: 40px; /* Ensures minimum width */
        }
        .action-btns {
            display: flex;
            gap: 4px;
        }
        .icon-btn {
            padding: 4px 8px;
            font-size: 16px;
            background: #1e88e5;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            line-height: 1;
        }
        .icon-btn:hover {
            background: #1565c0;
        }
        .icon-btn.duplicate {
            background: #00acc1;
        }
        .icon-btn.duplicate:hover {
            background: #00838f;
        }
        .icon-btn.delete {
            background: #e53935;
        }
        .icon-btn.delete:hover {
            background: #c62828;
        }
        .icon-btn.copy {
            background: #00acc1;
            font-size: 14px;
        }
        .icon-btn.copy:hover {
            background: #00838f;
        }
        .icon-btn.copy.copied {
            background: #43a047;
            animation: copySuccess 0.3s;
        }
        @keyframes copySuccess {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        .output-cell {
            font-size: 11px;
            color: #424242;
            max-width: 300px; /* Limits maximum width */
             min-width: 200px; /* Ensures minimum width */
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap; /* Keeps URL on one line */
        }
        .status-success {
            color: #43a047;
            font-weight: 600;
            font-size: 12px;
        }
        .status-error {
            color: #e53935;
            font-weight: 600;
            font-size: 12px;
        }
        .status-pending {
            color: #fb8c00;
            font-weight: 600;
            font-size: 12px;
        }
        .status-auto {
            color: #1e88e5;
            font-weight: 600;
            font-size: 12px;
        }
        .qr-link {
            color: #1e88e5;
            text-decoration: none;
            font-size: 12px;
        }
        .qr-link:hover {
            text-decoration: underline;
        }
        .stats {
            background: #fafafa;
            padding: 15px 30px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 30px;
        }
        .stat {
            display: flex;
            flex-direction: column;
        }
        .stat-label {
            font-size: 12px;
            color: #757575;
            margin-bottom: 4px;
        }
        .stat-value {
            font-size: 24px;
            font-weight: 600;
            color: #1e88e5;
        }
        .autocomplete-wrapper {
            position: relative;
        }
        .autocomplete-items {
            position: absolute;
            border: 1px solid #ddd;
            border-top: none;
            z-index: 999;
            background: white;
            max-height: 200px;
            overflow-y: auto;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            left: 4px; /* Alignment with input */
            right: 4px; /* Alignment with input */
            top: 100%; /* Below input */
        }
        
        /* Specific offset for autocomplete in Quick Fill */
        .quick-fill-item .autocomplete-items {
            left: 0; 
            right: 0;
        }
        .autocomplete-item {
            padding: 10px;
            cursor: pointer;
            font-size: 11px;
            border-bottom: 1px solid #f0f0f0;
        }
        .autocomplete-item:hover {
            background-color: #e3f2fd;
        }
        .autocomplete-item strong {
            color: #1e88e5;
        }
        .alert {
            padding: 12px 30px;
            margin: 0;
            display: none;
        }
        .alert.show {
            display: block;
        }
        .alert-success {
            background: #c8e6c9;
            color: #2e7d32;
        }
        .alert-error {
            background: #ffcdd2;
            color: #c62828;
        }
        .alert-info {
            background: #bbdefb;
            color: #1565c0;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 85vh; 
            overflow-y: auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        /* Specific styles for Help modal */
        .help-modal .modal-content {
            padding: 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .help-modal .modal-header {
            position: sticky;
            top: 0;
            background-color: white;
            z-index: 100;
            padding: 20px 30px 15px 30px;
            margin-bottom: 0;
            border-bottom: 1px solid #e0e0e0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            flex-shrink: 0;
        }
        .help-modal .help-content {
            padding: 20px 30px;
            overflow-y: auto;
            flex-grow: 1;
        }
        /* Help modal - anchor links */
        .help-content a {
            color: #1e88e5;
            text-decoration: none;
            transition: color 0.2s;
        }
        .help-content a:hover {
            color: #1565c0;
            text-decoration: underline;
        }
        .help-toc ol {
            padding-left: 20px;
        }
        .help-toc a {
            font-weight: 500;
        }
        .help-content h2 {
            scroll-margin-top: 20px; /* For smooth scroll */
        }
        .help-content section {
            scroll-margin-top: 20px;
        }
        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover {
            color: #000;
        }
        
         /* QR Modal specific styles */
         #qrImage {
             max-width: 100%;
             max-height: 300px; /* Height limit */
             margin: 10px auto;
             display: block;
             border: 1px solid #eee; /* Light border */
         }
         .qr-settings {
             display: grid;
             grid-template-columns: 45fr 21fr 17fr 17fr; /* Adjusted for wider modal */
             gap: 15px;
             margin-top: 20px;
             margin-bottom: 20px;
             padding-top: 15px;
             border-top: 1px solid #eee;
         }
         .qr-settings-item {
             display: flex;
             flex-direction: column; /* Label above inputs */
         }
         .qr-settings-item label {
             font-size: 12px;
             font-weight: 600;
             margin-bottom: 4px;
             color: #666;
         }
         .qr-settings-item select,
         .qr-settings-item input[type="number"] { /* Select and Number input full width */
              padding: 6px 8px;
              border: 1px solid #ddd;
              border-radius: 4px;
              font-size: 13px;
              width: 100%; /* Takes full width of grid cell */
         }
         .qr-settings-item .color-input-group { /* Group for color and text input */
             display: flex;
             align-items: center;
         }
         .qr-settings-item input[type="color"] { /* Smaller color picker */
              flex-shrink: 0; /* Won't shrink */
         }
         .qr-settings-item input[type="text"].hex-input { /* Text input for hex codes in QR modal */
            flex-grow: 0; /* Takes remainder */
            width: auto;
            max-width: 100px;
            min-width: 70px;
            margin-left: 5px;
            font-family: monospace;
         }

        .download-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr); /* Changed back to 2 columns for 4 buttons */
            gap: 10px;
            margin-top: 20px;
        }
        .download-buttons button {
            width: 100%;
            justify-content: center;
        }
        .settings-block {
            background: #fff3e0;
            padding: 15px 30px;
            border-bottom: 1px solid #e0e0e0;
            position: relative;
            z-index: 5;
        }
        .settings-block h3, .settings-block h4 {
            font-size: 14px;
            margin-bottom: 10px;
            color: #f57c00;
        }
        
        .quick-fill-block h3 { /* Only for quick fill heading */
             margin-top: 20px; /* Offset from settings */
             border-top: 1px solid #fbe9e7;
             padding-top: 15px;
        }
        .quick-fill-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }
        .quick-fill-item {
            display: flex;
            flex-direction: column;
             position: relative; /* For autocomplete positioning */
        }
        .quick-fill-item label {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 4px;
            color: #666;
        }
        .quick-fill-item input {
            padding: 6px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
        }
        .quick-fill-btn {
            grid-column: 1 / -1;
            margin-top: 10px;
        }
        
        .column-settings {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 10px;
            font-size: 14px;
        }
        
        .column-settings label {
            display: flex; 
            align-items: center; 
            gap: 5px; 
            cursor: pointer;
        }
        
        .data-management-settings {
             margin-top: 15px;
             padding-top: 15px;
             border-top: 1px solid #fbe9e7;
             display: flex;
             gap: 10px;
             flex-wrap: wrap; /* For responsiveness */
             align-items: center; /* Button alignment */
        }
         .data-management-settings h4 {
             width: 100%; /* Heading takes full width */
             margin-bottom: 5px;
         }

        .help-modal .modal-content {
            max-width: 700px;
        }
        .help-content {
            font-size: 14px;
            line-height: 1.6;
        }
        .help-content h3 {
            color: #1e88e5;
            margin-top: 20px;
            margin-bottom: 10px;
            font-size: 16px;
        }
        .help-content h3:first-child {
            margin-top: 0;
        }
        .help-content ul {
            margin-left: 20px;
            margin-bottom: 15px;
        }
        .help-content li {
            margin-bottom: 8px;
        }
        .help-content strong {
            color: #333;
        }
        .help-content code {
            background: #f5f5f5;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }
        .auto-badge {
            display: inline-block;
            background: #4caf50;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 5px;
            font-weight: 600;
        }
        @media (max-width: 768px) {
            .toolbar {
                flex-direction: column;
            }
            button {
                width: 100%;
            }
            .tooltip-text {
                width: 200px;
                margin-left: -100px;
            }
            .download-buttons {
                grid-template-columns: 1fr; 
            }
             .data-management-settings button { 
                 width: 100%;
             }
             .qr-settings { 
                  grid-template-columns: 1fr;
             }
        }
    </style>
</head>
<body class=""> <div class="container">
        <div class="header">
            <h1>üöÄ UTM Generator <span class="version-badge">v1.0.0</span></h1>
            <p>Quick UTM link generator with automatic update <span class="auto-badge">AUTO</span></p>
        </div>
        <div class="alert" id="alertBox"></div>
        <div class="settings-block">
            <h4>‚öôÔ∏è Application Settings</h4>
            <div class="column-settings">
                <label>
                    <input type="checkbox" id="toggleUtmId" checked onchange="toggleUtmIdGeneration()">
                    Automatically generate utm_id
                </label>
                <label>
                    <input type="checkbox" id="togglePlatform" onchange="updateColumnVisibility()">
                    Show utm_source_platform
                </label>
                <label>
                    <input type="checkbox" id="toggleFormat" onchange="updateColumnVisibility()">
                    Show utm_creative_format
                </label>
                <label>
                    <input type="checkbox" id="toggleTactic" onchange="updateColumnVisibility()">
                    Show utm_marketing_tactic
                </label>
            </div>
             <div class="data-management-settings">
                  <h4>üíæ Data Management</h4>
                 <button class="btn-success btn-small" onclick="backupData()">Backup data (JSON)</button>
                 <button class="btn-warning btn-small" onclick="restoreData()">Restore data (JSON)</button>
                 <button class="btn-danger btn-small" onclick="clearAutocompleteHistory()">Clear autocomplete history</button>
                 <button class="btn-danger btn-small" onclick="resetApplicationState()" title="Deletes ALL data and returns the application to its default state!">Reset application</button>
                 <button class="btn-secondary btn-small" onclick="openDevConsole()" title="Shows help for opening the console">üîß How to open console?</button>
             </div>            
            <div class="quick-fill-block">
                 <h3>‚ö° Quick Fill</h3>
                <div class="quick-fill-grid">
                     <div class="quick-fill-item autocomplete-wrapper"> 
                         <label>Base URL</label>
                         <input type="url" id="quickBaseUrl" placeholder="https://www.example.com">
                     </div>
                    <div class="quick-fill-item autocomplete-wrapper"> 
                        <label>utm_source</label>
                        <input type="text" id="quickSource" data-autocomplete="utm_source" placeholder="facebook" oninput="handleAutocomplete(this)">
                    </div>
                    <div class="quick-fill-item autocomplete-wrapper">
                        <label>utm_medium</label>
                        <input type="text" id="quickMedium" data-autocomplete="utm_medium" placeholder="social" oninput="handleAutocomplete(this)">
                    </div>
                    <div class="quick-fill-item autocomplete-wrapper">
                        <label>utm_campaign</label>
                        <input type="text" id="quickCampaign" data-autocomplete="utm_campaign" placeholder="summer_sale" oninput="handleAutocomplete(this)">
                    </div>
                    <div class="quick-fill-item autocomplete-wrapper">
                        <label>utm_term</label>
                        <input type="text" id="quickTerm" data-autocomplete="utm_term" placeholder="keyword" oninput="handleAutocomplete(this)">
                    </div>
                    <div class="quick-fill-item autocomplete-wrapper">
                        <label>utm_content</label>
                        <input type="text" id="quickContent" data-autocomplete="utm_content" placeholder="banner_01" oninput="handleAutocomplete(this)">
                    </div>
                    <div class="quick-fill-item col-platform autocomplete-wrapper">
                        <label>utm_source_platform</label>
                        <input type="text" id="quickPlatform" data-autocomplete="utm_source_platform" placeholder="facebook_ads" oninput="handleAutocomplete(this)">
                    </div>
                    <div class="quick-fill-item col-format autocomplete-wrapper">
                        <label>utm_creative_format</label>
                        <input type="text" id="quickFormat" data-autocomplete="utm_creative_format" placeholder="video" oninput="handleAutocomplete(this)">
                    </div>
                    <div class="quick-fill-item col-tactic autocomplete-wrapper">
                        <label>utm_marketing_tactic</label>
                        <input type="text" id="quickTactic" data-autocomplete="utm_marketing_tactic" placeholder="awareness" oninput="handleAutocomplete(this)">
                    </div>
                </div>
                <button class="btn-info quick-fill-btn" onclick="applyQuickFill()">‚ö° Apply to all empty rows</button>
            </div>
        </div>
        <div class="toolbar">
            <button class="btn-primary" onclick="addRow()">‚ûï Add row</button>
            <button class="btn-primary" onclick="exportToCSV()">üíæ Export CSV</button>
            <button class="btn-primary" onclick="exportToExcel()">üìä Export Excel</button>
            <button class="btn-secondary" onclick="clearAll()" title="Deletes all rows but preserves history and settings">üóëÔ∏è Clear rows</button>
            <button class="btn-secondary" onclick="showHelp()">‚ùì Help</button>
        </div>
        <div class="table-container">
            <table id="utmTable">
                <thead>
                    <tr>
                        <th style="width: 20px;">#</th>
                        <th style="width: 250px;" class="required"> Base URL
                            <span class="tooltip-icon">?</span>
                            <span class="tooltip-text">
                                <strong>Base URL address</strong><br>
                                Full address of the page where you want to bring users. If you don't specify a protocol (http:// or https://), https:// will be added automatically.
                                <span class="tooltip-example">Example: example.com ‚Üí https://example.com</span>
                                <span class="tooltip-example">https://www.example.com/products</span>
                                <span class="tooltip-example">www.example.com ‚Üí https://www.example.com</span>
                            </span>
                        </th>
                        <th style="width: 80px;" class="required"> utm_source
                            <span class="tooltip-icon">?</span>
                            <span class="tooltip-text">
                                <strong>Campaign source</strong><br>
                                Where the visitor comes from. Automatically converted to lowercase and spaces replaced with underscores.
                                <span class="tooltip-example">Example: facebook, google, newsletter</span>
                                <span class="tooltip-example">"Google Ads" ‚Üí google_ads</span>
                            </span>
                        </th>
                        <th style="width: 80px;" class="required"> utm_medium
                            <span class="tooltip-icon">?</span>
                            <span class="tooltip-text">
                                <strong>Campaign medium</strong><br>
                                Type of marketing channel. Automatically converted to lowercase and spaces replaced with underscores.
                                <span class="tooltip-example">Example: cpc, email, social, organic</span>
                                <span class="tooltip-example">"Social Media" ‚Üí social_media</span>
                            </span>
                        </th>
                        <th style="width: 80px;" class="required"> utm_campaign
                            <span class="tooltip-icon">?</span>
                            <span class="tooltip-text">
                                <strong>Campaign name</strong><br>
                                Specific name of your marketing campaign. Use consistent naming. Automatically converted to lowercase and spaces replaced with underscores.
                                <span class="tooltip-example">Example: summer_sale_2024, black_friday</span>
                                <span class="tooltip-example">"Summer Sale" ‚Üí summer_sale</span>
                            </span>
                        </th>
                        <th style="width: 100px;"> utm_term
                            <span class="tooltip-icon">?</span>
                            <span class="tooltip-text">
                                <strong>Keyword (optional)</strong><br>
                                Used mainly for paid advertising to identify keywords. Automatically converted to lowercase and spaces replaced with underscores.
                                <span class="tooltip-example">Example: running_shoes, best_laptop</span>
                                <span class="tooltip-example">"Running Shoes" ‚Üí running_shoes</span>
                            </span>
                        </th>
                        <th style="width: 80px;"> utm_content
                            <span class="tooltip-icon">?</span>
                            <span class="tooltip-text">
                                <strong>Content/variant (optional)</strong><br>
                                Distinguish similar links or ads within the same campaign. Automatically converted to lowercase and spaces replaced with underscores.
                                <span class="tooltip-example">Example: banner_01, text_link, button_blue</span>
                                <span class="tooltip-example">"Header CTA" ‚Üí header_cta</span>
                            </span>
                        </th>
                        <th style="width: 120px;"> utm_id
                            <span class="tooltip-icon">?</span>
                            <span class="tooltip-text">
                                <strong>Campaign ID (automatic/manual)</strong><br> 
                                Unique campaign identifier. Can be generated automatically (format: YYYYMMDD_XXX) or entered manually if automatic generation is disabled in Settings.
                                <span class="tooltip-example">Example (auto): 20240323_001</span>
                                <span class="tooltip-example">Example (manual): my_campaign_2024</span>
                            </span>
                        </th>
                        <th style="width: 80px;" class="col-platform"> utm_source_platform
                            <span class="tooltip-icon">?</span>
                            <span class="tooltip-text">
                                <strong>Source platform (optional)</strong><br>
                                Specific advertising platform within the source. Automatically converted to lowercase and spaces replaced with underscores.
                                <span class="tooltip-example">Example: facebook_ads, google_ads</span>
                                <span class="tooltip-example">"LinkedIn Ads" ‚Üí linkedin_ads</span>
                                <br><strong style='color: #fb8c00;'>Requires custom setup in GA.</strong>
                            </span>
                        </th>
                        <th style="width: 80px;" class="col-format"> utm_creative_format
                            <span class="tooltip-icon">?</span>
                            <span class="tooltip-text">
                                <strong>Creative format (optional)</strong><br>
                                Type of ad format. Automatically converted to lowercase and spaces replaced with underscores.
                                <span class="tooltip-example">Example: video, banner, carousel, story</span>
                                <span class="tooltip-example">"Single Image" ‚Üí single_image</span>
                                <br><strong style='color: #fb8c00;'>Requires custom setup in GA.</strong>
                            </span>
                        </th>
                        <th style="width: 80px;" class="col-tactic"> utm_marketing_tactic
                            <span class="tooltip-icon">?</span>
                            <span class="tooltip-text">
                                <strong>Marketing tactic (optional)</strong><br>
                                Marketing funnel stage. Automatically converted to lowercase and spaces replaced with underscores.
                                <span class="tooltip-example">Example: awareness, consideration, conversion</span>
                                <span class="tooltip-example">"Brand Awareness" ‚Üí brand_awareness</span>
                                <br><strong style='color: #fb8c00;'>Requires custom setup in GA.</strong>
                            </span>
                        </th>
                        <th style="width: 100px;"> Final UTM URL <span class="auto-badge">AUTO</span>
                            <span class="tooltip-icon">?</span>
                            <span class="tooltip-text">
                                <strong>Final UTM link</strong><br>
                                Complete URL address with added UTM parameters. Generated automatically when filling in. Use this link in your campaigns.
                            </span>
                        </th>
                        <th style="width: 60px;"> Status
                            <span class="tooltip-icon">?</span>
                            <span class="tooltip-text">
                                <strong>Generation status</strong><br>
                                üîÑ Auto = automatically generated<br>
                                ‚ùå Error = validation problem<br>
                                Waiting = waiting for required fields
                            </span>
                        </th>
                        <th style="width: 60px;"> QR Code
                            <span class="tooltip-icon">?</span>
                            <span class="tooltip-text">
                                <strong>QR code</strong><br>
                                Generates QR code for your UTM link. You can download it in various formats (PNG, JPEG, SVG, EPS). You can customize the code appearance in the window.
                            </span>
                        </th>
                        <th style="width: 60px; min-width: 80px;"> Actions
                            <span class="tooltip-icon">?</span>
                            <span class="tooltip-text">
                                <strong>Row actions</strong><br>
                                üìã = Duplicate row<br>
                                üóëÔ∏è = Delete row
                            </span>
                        </th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    </tbody>
            </table>
        </div>
        <div class="stats">
            <div class="stat">
                <span class="stat-label">Total Rows</span>
                <span class="stat-value" id="totalRows">0</span>
            </div>
            <div class="stat">
                <span class="stat-label">Generated</span>
                <span class="stat-value" id="generatedRows">0</span>
            </div>
            <div class="stat">
                <span class="stat-label">Errors</span>
                <span class="stat-value" id="errorRows" style="color: #e53935;">0</span>
            </div>
        </div>
    </div>
    <div id="qrModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>QR Code</h2>
                <span class="close" onclick="closeQRModal()">&times;</span>
            </div>
            <img id="qrImage" src="" alt="QR Code">
             <div class="qr-settings">
                 <div class="qr-settings-item">
                     <label for="qrEccLevel">Error correction level:</label>
                     <select id="qrEccLevel" onchange="updateQRPreview()">
                         <option value="L">Low (L ~7%)</option>
                         <option value="M">Medium (M ~15%)</option>
                         <option value="Q">Quartile (Q ~25%)</option>
                         <option value="H" selected>High (H ~30%)</option>
                     </select>
                 </div>
                 <div class="qr-settings-item">
                     <label for="qrMargin">Margin (px):</label>
                     <input type="number" id="qrMargin" value="10" min="0" max="50" step="1" onchange="updateQRPreview()">
                 </div>
                 <div class="qr-settings-item">
                     <label for="qrColorHex">Code color:</label> <div class="color-input-group">
                          <input type="color" id="qrColor" value="#000000" onchange="document.getElementById('qrColorHex').value = this.value; updateQRPreview()">
                          <input type="text" id="qrColorHex" class="hex-input" value="#000000" pattern="#?[0-9a-fA-F]{3,6}" maxlength="7" oninput="handleHexInput(this, 'qrColor')" onchange="updateQRPreview()" onblur="updateQRPreview()" onkeydown="handleHexEnter(event)"> </div>
                 </div>
                 <div class="qr-settings-item">
                     <label for="qrBgColorHex">Background color:</label> <div class="color-input-group">
                          <input type="color" id="qrBgColor" value="#ffffff" onchange="document.getElementById('qrBgColorHex').value = this.value; updateQRPreview()">
                          <input type="text" id="qrBgColorHex" class="hex-input" value="#ffffff" pattern="#?[0-9a-fA-F]{3,6}" maxlength="7" oninput="handleHexInput(this, 'qrBgColor')" onchange="updateQRPreview()" onblur="updateQRPreview()" onkeydown="handleHexEnter(event)"> </div>
                 </div>
             </div>
             <p id="qrUrl" style="word-break: break-all; font-size: 12px; color: #666; margin-top: 10px; text-align: center;"></p>
            <div class="download-buttons">
                <button class="btn-primary" onclick="downloadQR('png')">üíæ Download PNG</button>
                <button class="btn-primary" onclick="downloadQR('jpeg')">üíæ Download JPEG</button>
                <button class="btn-info" onclick="downloadQR('svg')">üíæ Download SVG</button>
                <button class="btn-info" onclick="downloadQR('eps')">üíæ Download EPS</button>
            </div>
        </div>
    </div>
    <div id="helpModal" class="modal help-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìñ Help</h2>
                <span class="close" onclick="closeHelpModal()">&times;</span>
            </div>
            <div class="help-content">
                
                <!-- TABLE OF CONTENTS -->
                <nav id="help-toc" class="help-toc" style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 30px; border-left: 4px solid #1e88e5;">
                    <h3 style="margin-top: 0; color: #1e88e5;">üìë Contents</h3>
                    <ol style="line-height: 2; margin: 10px 0;">
                        <li><a href="#help-version">Version and changelog</a></li>
                        <li><a href="#help-how-to-use">How to use UTM Generator</a></li>
                        <li><a href="#help-required-fields">Required fields</a></li>
                        <li><a href="#help-auto-formatting">Automatic text formatting</a></li>
                        <li><a href="#help-utm-id">Automatic utm_id generation</a></li>
                        <li><a href="#help-advanced-params">Optional advanced parameters</a></li>
                        <li><a href="#help-quick-fill">Quick fill</a></li>
                        <li><a href="#help-export">Export and backup</a></li>
                        <li><a href="#help-storage">Data storage</a></li>
                        <li><a href="#help-qr">QR codes</a></li>
                        <li><a href="#help-autocomplete">Autocomplete</a></li>
                        <li><a href="#help-data-management">Data management</a></li>
                        <li><a href="#help-compatibility">Compatibility and limitations</a></li>
                        <li><a href="#help-debugging">Troubleshooting and debugging</a></li>
                        <li><a href="#help-tips">Tips and recommendations</a></li>
                    </ol>
                </nav>
                <!-- 1. VERSION AND CHANGELOG -->
                <section id="help-version">
                    <h2 style="color: #1e88e5; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; margin-top: 30px;">üìã Version and changelog</h2>
                    <p><strong>Current version: <span style="color: #1e88e5;">1.0.0</span></strong> (January 31, 2025)</p>
                    <details style="margin-bottom: 20px; cursor: pointer;">
                        <summary style="font-weight: 600; padding: 10px; background: #f5f5f5; border-radius: 4px; user-select: none;">
                            üìú Show version history
                        </summary>
                        <div style="padding: 15px 10px; border-left: 3px solid #1e88e5; margin-top: 10px; background: #fafafa;">
                            <h4 style="margin-top: 0;">v1.0.0 (January 31, 2025) - Stable version</h4>
                            <ul>
                                <li>‚úÖ Automatic UTM link generation with live preview</li>
                                <li>‚úÖ Parameter sanitization (lowercase, spaces‚Üíunderscores)</li>
                                <li>‚úÖ URL validation with automatic protocol completion</li>
                                <li>‚úÖ Proper handling of anchors (#) and query parameters</li>
                                <li>‚úÖ Export to CSV and Excel</li>
                                <li>‚úÖ QR code generation with settings</li>
                                <li>‚úÖ Data backup and restore (JSON)</li>
                                <li>‚úÖ Automatic/manual utm_id generation</li>
                                <li>‚úÖ Autocomplete with history</li>
                                <li>‚úÖ Advanced UTM parameters (platform, format, tactic)</li>
                                <li>‚úÖ Quick fill for empty rows</li>
                                <li>‚úÖ LocalStorage with warning for issues</li>
                                <li>‚úÖ Browser compatibility check</li>
                                <li>‚úÖ Offline indicator</li>
                                <li>‚úÖ Complete help and tooltips</li>
                            </ul>
                        </div>
                    </details>
                    <p style="text-align: right;"><a href="#help-toc" style="font-size: 12px; color: #1e88e5;">‚¨ÜÔ∏è Back to contents</a></p>
                </section>
                <!-- 2. HOW TO USE -->
                <section id="help-how-to-use">
                    <h2 style="color: #1e88e5; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; margin-top: 30px;">üéØ How to use UTM Generator</h2>
                    <p>This tool helps you create tracked UTM links for your marketing campaigns. All data is stored locally in your browser.</p>
                    <p style="text-align: right;"><a href="#help-toc" style="font-size: 12px; color: #1e88e5;">‚¨ÜÔ∏è Back to contents</a></p>
                </section>
                <!-- 3. REQUIRED FIELDS -->
                <section id="help-required-fields">
                    <h2 style="color: #1e88e5; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; margin-top: 30px;">üìã Required fields</h2>
                    <ul>
                        <li><strong>Base URL:</strong> Enter the target address (e.g., <code>example.com</code> or <code>https://example.com/page</code>). The https:// protocol will be added automatically if not provided.</li>
                        <li><strong>utm_source:</strong> Traffic source (e.g., <code>facebook</code>, <code>google</code>, <code>newsletter</code>)</li>
                        <li><strong>utm_medium:</strong> Media type (e.g., <code>cpc</code>, <code>email</code>, <code>social</code>)</li>
                        <li><strong>utm_campaign:</strong> Campaign name (e.g., <code>summer_sale</code>, <code>black_friday</code>)</li>
                    </ul>
                    <p style="text-align: right;"><a href="#help-toc" style="font-size: 12px; color: #1e88e5;">‚¨ÜÔ∏è Back to contents</a></p>
                </section>
                <!-- 4. AUTOMATIC TEXT FORMATTING -->
                <section id="help-auto-formatting">
                    <h2 style="color: #1e88e5; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; margin-top: 30px;">‚úèÔ∏è Automatic text formatting</h2>
                    <p>All UTM parameters (except Base URL and utm_id) are automatically formatted:</p>
                    <ul>
                        <li>üî§ <strong>Convert to lowercase:</strong> "FaceBook" ‚Üí "facebook"</li>
                        <li>üîó <strong>Spaces ‚Üí underscores:</strong> "Summer Sale" ‚Üí "summer_sale"</li>
                        <li>üßπ <strong>Remove disallowed characters:</strong> Only letters, numbers, hyphens (-) and underscores (_) are allowed</li>
                    </ul>
                    <div style="background: #fff3e0; border-left: 4px solid #ff9800; padding: 12px; margin: 15px 0; border-radius: 4px;">
                        <strong>üí° Note:</strong> Changes take effect after you finish typing (Tab or Enter).
                    </div>
                    <p style="text-align: right;"><a href="#help-toc" style="font-size: 12px; color: #1e88e5;">‚¨ÜÔ∏è Back to contents</a></p>
                </section>
                <!-- 5. AUTOMATIC UTM_ID GENERATION -->
                <section id="help-utm-id">
                    <h2 style="color: #1e88e5; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; margin-top: 30px;">üî¢ Automatic utm_id generation</h2>
                    <p>In the ‚öôÔ∏è Settings section, you can enable/disable automatic <code>utm_id</code> generation:</p>
                    <ul>
                        <li><strong>‚úÖ Enabled (default):</strong> Generates ID in format <code>YYYYMMDD_XXX</code> (date + sequential number), e.g., <code>20240323_001</code></li>
                        <li><strong>‚úçÔ∏è Disabled:</strong> You can enter custom ID manually</li>
                    </ul>
                    <p style="text-align: right;"><a href="#help-toc" style="font-size: 12px; color: #1e88e5;">‚¨ÜÔ∏è Back to contents</a></p>
                </section>
                <!-- 6. ADVANCED PARAMETERS -->
                <section id="help-advanced-params">
                    <h2 style="color: #1e88e5; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; margin-top: 30px;">‚ûï Optional advanced parameters</h2>
                    <p>In the ‚öôÔ∏è Settings section, you can show additional columns:</p>
                    <ul>
                        <li><strong>utm_source_platform:</strong> Specific advertising platform (e.g., <code>facebook_ads</code>)</li>
                        <li><strong>utm_creative_format:</strong> Ad format (e.g., <code>video</code>, <code>banner</code>)</li>
                        <li><strong>utm_marketing_tactic:</strong> Campaign stage (e.g., <code>awareness</code>, <code>conversion</code>)</li>
                    </ul>
                    <div style="background: #fff3e0; border-left: 4px solid #fb8c00; padding: 12px; margin: 15px 0; border-radius: 4px;">
                        <strong>‚ö†Ô∏è Important:</strong> These parameters require custom setup in Google Analytics 4!
                    </div>
                    <p style="text-align: right;"><a href="#help-toc" style="font-size: 12px; color: #1e88e5;">‚¨ÜÔ∏è Back to contents</a></p>
                </section>
                <!-- 7. QUICK FILL -->
                <section id="help-quick-fill">
                    <h2 style="color: #1e88e5; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; margin-top: 30px;">‚ö° Quick fill</h2>
                    <p>Want to fill all empty rows with the same values? Use the <strong>‚ö° Quick fill</strong> section above the table.</p>
                    <p style="text-align: right;"><a href="#help-toc" style="font-size: 12px; color: #1e88e5;">‚¨ÜÔ∏è Back to contents</a></p>
                </section>
                <!-- 8. EXPORT AND BACKUP -->
                <section id="help-export">
                    <h2 style="color: #1e88e5; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; margin-top: 30px;">üì§ Export and backup</h2>
                    <ul>
                        <li><strong>üíæ Export CSV:</strong> Download your UTM links to CSV file <span style="color: #4caf50;">(works offline ‚úÖ)</span></li>
                        <li><strong>üìä Export Excel:</strong> Download to XLSX format <span style="color: #ff9800;">(‚ö†Ô∏è requires internet)</span></li>
                        <li><strong>üíº Backup data (JSON):</strong> Save complete backup including history <span style="color: #4caf50;">(works offline ‚úÖ)</span></li>
                        <li><strong>üì• Restore data (JSON):</strong> Load previously saved backup <span style="color: #4caf50;">(works offline ‚úÖ)</span></li>
                    </ul>
                    <div style="background: #e3f2fd; border-left: 4px solid #1e88e5; padding: 12px; margin: 15px 0; border-radius: 4px;">
                        <strong>üí° Tip:</strong> If working without connection, use CSV export or JSON backup instead of Excel.
                    </div>
                    <p style="text-align: right;"><a href="#help-toc" style="font-size: 12px; color: #1e88e5;">‚¨ÜÔ∏è Back to contents</a></p>
                </section>
                <!-- 9. DATA STORAGE -->
                <section id="help-storage">
                    <h2 style="color: #1e88e5; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; margin-top: 30px;">üóÇÔ∏è Data storage</h2>
                    <p>All data is automatically saved to your browser's <strong>localStorage</strong>:</p>
                    <ul>
                        <li>‚úÖ Data remains even after closing the browser</li>
                        <li>‚úÖ Works offline</li>
                        <li>‚ö†Ô∏è Data is stored only in this browser</li>
                        <li>üí° We recommend creating regular backups (JSON)</li>
                    </ul>
                    <p style="text-align: right;"><a href="#help-toc" style="font-size: 12px; color: #1e88e5;">‚¨ÜÔ∏è Back to contents</a></p>
                </section>
                <!-- 10. QR CODES -->
                <section id="help-qr">
                    <h2 style="color: #1e88e5; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; margin-top: 30px;">üì± QR codes</h2>
                    <p>For each generated UTM link, you can create a QR code with custom color settings, margin size, and error correction level. QR code can be downloaded in various formats (PNG, JPEG, SVG, EPS).</p>
                    <div style="background: #fff3e0; border-left: 4px solid #ff9800; padding: 12px; margin: 15px 0; border-radius: 4px;">
                        <strong>‚ö†Ô∏è Important:</strong> QR code generation requires internet connection (uses external API).
                    </div>
                    <p style="text-align: right;"><a href="#help-toc" style="font-size: 12px; color: #1e88e5;">‚¨ÜÔ∏è Back to contents</a></p>
                </section>
                <!-- 11. AUTOCOMPLETE -->
                <section id="help-autocomplete">
                    <h2 style="color: #1e88e5; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; margin-top: 30px;">üîç Autocomplete</h2>
                    <p>When typing into fields, a history of previously used values is displayed. History is saved automatically and can be cleared in ‚öôÔ∏è Settings ‚Üí üíæ Data Management.</p>
                    <p style="text-align: right;"><a href="#help-toc" style="font-size: 12px; color: #1e88e5;">‚¨ÜÔ∏è Back to contents</a></p>
                </section>
                <!-- 12. DATA MANAGEMENT -->
                <section id="help-data-management">
                    <h2 style="color: #1e88e5; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; margin-top: 30px;">üõ†Ô∏è Data management</h2>
                    <ul>
                        <li><strong>üóëÔ∏è Clear rows:</strong> Deletes all rows (preserves history and settings)</li>
                        <li><strong>üßπ Clear autocomplete history:</strong> Deletes only autocomplete history</li>
                        <li><strong>üîÑ Reset application:</strong> Returns application to completely clean state <span style="color: #e53935;">(‚ö†Ô∏è deletes EVERYTHING!)</span></li>
                    </ul>
                    <p style="text-align: right;"><a href="#help-toc" style="font-size: 12px; color: #1e88e5;">‚¨ÜÔ∏è Back to contents</a></p>
                </section>
                <!-- 13. COMPATIBILITY -->
                <section id="help-compatibility">
                    <h2 style="color: #1e88e5; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; margin-top: 30px;">‚ö†Ô∏è Compatibility and limitations</h2>
                    
                    <h3 style="color: #424242; margin-top: 20px;">üì± Supported browsers</h3>
                    <ul>
                        <li><strong>Recommended:</strong> Chrome 90+, Firefox 88+, Edge 90+, Safari 14+</li>
                        <li><strong>Minimum:</strong> Chrome 49+, Firefox 45+, Edge 14+, Safari 10+</li>
                        <li>‚ùå <strong>Not supported:</strong> Internet Explorer (any version)</li>
                    </ul>
                    <h3 style="color: #424242; margin-top: 20px;">üåê Features requiring internet</h3>
                    <ul>
                        <li><strong>üìä Excel export:</strong> Requires loading external SheetJS library from CDN</li>
                        <li><strong>üì± QR codes:</strong> Use online API for generation (api.qrserver.com)</li>
                    </ul>
                    <h3 style="color: #424242; margin-top: 20px;">üîí What happens with problems</h3>
                    <ul>
                        <li><strong>Old browser:</strong> Red warning at top with problem description</li>
                        <li><strong>Lost connection:</strong> Orange warning and notice about limited features</li>
                        <li><strong>Full localStorage:</strong> Warning and recommendation to create backup</li>
                        <li><strong>Unsupported localStorage:</strong> Data won't be saved between sessions</li>
                    </ul>
                    <h3 style="color: #424242; margin-top: 20px;">üõ°Ô∏è What always works (even offline)</h3>
                    <ul>
                        <li>‚úÖ UTM link generation</li>
                        <li>‚úÖ URL validation and cleaning</li>
                        <li>‚úÖ UTM parameter sanitization</li>
                        <li>‚úÖ CSV export</li>
                        <li>‚úÖ Saving to localStorage (if supported)</li>
                        <li>‚úÖ JSON backup and restore</li>
                        <li>‚úÖ Autocomplete and history</li>
                    </ul>
                    <p style="text-align: right;"><a href="#help-toc" style="font-size: 12px; color: #1e88e5;">‚¨ÜÔ∏è Back to contents</a></p>
                </section>
                <!-- 14. DEBUGGING -->
                <section id="help-debugging">
                    <h2 style="color: #1e88e5; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; margin-top: 30px;">üîß Troubleshooting and debugging</h2>
                    
                    <h3 style="color: #424242; margin-top: 20px;">üìä Developer Console</h3>
                    <p>All technical information, verifications, and error messages are logged to the <strong>browser console</strong>. This is useful for diagnosing problems.</p>
                    <h3 style="color: #424242; margin-top: 20px;">üñ•Ô∏è How to open console</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 15px 0;">
                        <div style="background: #f5f5f5; padding: 15px; border-radius: 4px;">
                            <strong>ü™ü Windows/Linux:</strong>
                            <ul style="margin: 10px 0 0 0; padding-left: 20px;">
                                <li><code>F12</code></li>
                                <li><code>Ctrl + Shift + I</code></li>
                                <li><code>Ctrl + Shift + J</code></li>
                                <li>Right-click ‚Üí Inspect ‚Üí Console</li>
                            </ul>
                        </div>
                        <div style="background: #f5f5f5; padding: 15px; border-radius: 4px;">
                            <strong>üçé macOS:</strong>
                            <ul style="margin: 10px 0 0 0; padding-left: 20px;">
                                <li><code>Cmd + Option + I</code></li>
                                <li><code>Cmd + Option + J</code></li>
                                <li>Right-click ‚Üí Inspect Element ‚Üí Console</li>
                            </ul>
                        </div>
                    </div>
                    <h3 style="color: #424242; margin-top: 20px;">üîç What you'll find in console</h3>
                    <ul>
                        <li>‚úÖ <strong>Version info:</strong> <code>üöÄ UTM Generator v1.0.0</code></li>
                        <li>‚úÖ <strong>Compatibility check:</strong> "Browser compatibility check passed!"</li>
                        <li>‚úÖ <strong>Backup info:</strong> "Restoring backup from version..."</li>
                        <li>‚ö†Ô∏è <strong>Warnings:</strong> localStorage issues, different backup versions, etc.</li>
                        <li>‚ùå <strong>Errors:</strong> Detailed information about URL parsing problems, validation, etc.</li>
                        <li>üìù <strong>Debug logs:</strong> Technical information about application operation</li>
                    </ul>
                    <h3 style="color: #424242; margin-top: 20px;">üõ†Ô∏è Common problems and solutions</h3>
                    
                    <details style="margin: 10px 0; cursor: pointer;">
                        <summary style="font-weight: 600; padding: 10px; background: #f5f5f5; border-radius: 4px; user-select: none;">
                            ‚ùå Data isn't saving or backup won't load
                        </summary>
                        <div style="padding: 15px; border-left: 3px solid #e53935; margin-top: 5px; background: #ffebee;">
                            <p><strong>Possible causes:</strong></p>
                            <ul>
                                <li>LocalStorage is full or blocked</li>
                                <li>Using private mode (Incognito)</li>
                                <li>Browser blocks localStorage for local files</li>
                            </ul>
                            <p><strong>Solutions:</strong></p>
                            <ul>
                                <li>Open console (F12) and look for red errors</li>
                                <li>Check if orange warning displays at top</li>
                                <li>Clear browser data or use different browser</li>
                                <li>Use JSON backups for data transfer</li>
                            </ul>
                        </div>
                    </details>
                    <details style="margin: 10px 0; cursor: pointer;">
                        <summary style="font-weight: 600; padding: 10px; background: #f5f5f5; border-radius: 4px; user-select: none;">
                            ‚ùå URL not generating or error message during validation
                        </summary>
                        <div style="padding: 15px; border-left: 3px solid #ff9800; margin-top: 5px; background: #fff3e0;">
                            <p><strong>Possible causes:</strong></p>
                            <ul>
                                <li>Invalid URL format (missing domain or TLD)</li>
                                <li>Disallowed protocol (ftp://, javascript:, etc.)</li>
                                <li>Special characters in URL</li>
                            </ul>
                            <p><strong>Solutions:</strong></p>
                            <ul>
                                <li>Open console and check warnings related to URL</li>
                                <li>Make sure URL contains domain with TLD (e.g., <code>example.com</code>)</li>
                                <li>Protocol https:// will be added automatically if missing</li>
                                <li>Console will show: "Could not parse URL for cleaning: ..."</li>
                            </ul>
                        </div>
                    </details>
                    <details style="margin: 10px 0; cursor: pointer;">
                        <summary style="font-weight: 600; padding: 10px; background: #f5f5f5; border-radius: 4px; user-select: none;">
                            ‚ùå QR code or Excel export not working
                        </summary>
                        <div style="padding: 15px; border-left: 3px solid #1e88e5; margin-top: 5px; background: #e3f2fd;">
                            <p><strong>Possible causes:</strong></p>
                            <ul>
                                <li>You are offline (no internet connection)</li>
                                <li>External API or library failed to load</li>
                                <li>Third-party blocking (AdBlock, firewall)</li>
                            </ul>
                            <p><strong>Solutions:</strong></p>
                            <ul>
                                <li>Check internet connection</li>
                                <li>Look for red errors in console (e.g., "Failed to load resource")</li>
                                <li>Temporarily disable AdBlock or other extensions</li>
                                <li>Use CSV export (works offline) instead of Excel</li>
                            </ul>
                        </div>
                    </details>
                    <details style="margin: 10px 0; cursor: pointer;">
                        <summary style="font-weight: 600; padding: 10px; background: #f5f5f5; border-radius: 4px; user-select: none;">
                            ‚ùå Application is slow or not responding
                        </summary>
                        <div style="padding: 15px; border-left: 3px solid #9c27b0; margin-top: 5px; background: #f3e5f5;">
                            <p><strong>Possible causes:</strong></p>
                            <ul>
                                <li>Too many rows (hundreds)</li>
                                <li>Large autocomplete history</li>
                                <li>Full localStorage</li>
                            </ul>
                            <p><strong>Solutions:</strong></p>
                            <ul>
                                <li>Export data and delete old rows</li>
                                <li>Clear autocomplete history (‚öôÔ∏è Settings ‚Üí Clear history)</li>
                                <li>Create backup and reset application</li>
                                <li>In console you can check data size: <code>localStorage</code></li>
                            </ul>
                        </div>
                    </details>
                    <h3 style="color: #424242; margin-top: 20px;">üí° Debugging tips</h3>
                    <ul>
                        <li>üî¥ <strong>Red messages</strong> = critical errors that stop function</li>
                        <li>üü° <strong>Yellow messages</strong> = warnings, application works but something isn't ideal</li>
                        <li>‚ö™ <strong>Regular messages</strong> = information about progress (loading, saving, etc.)</li>
                        <li>When reporting problems, <strong>always attach console screenshot</strong></li>
                        <li>Text from console can be copied (right-click ‚Üí Copy message)</li>
                    </ul>
                    <p style="text-align: right;"><a href="#help-toc" style="font-size: 12px; color: #1e88e5;">‚¨ÜÔ∏è Back to contents</a></p>
                </section>
                <!-- 15. TIPS -->
                <section id="help-tips">
                    <h2 style="color: #1e88e5; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; margin-top: 30px;">üí° Tips and recommendations</h2>
                    <ul>
                        <li>‚úÖ Use <strong>consistent naming</strong> across campaigns</li>
                        <li>‚úÖ Write values in <strong>lowercase</strong> without diacritics</li>
                        <li>‚úÖ Use <strong>underscores</strong> instead of spaces (happens automatically)</li>
                        <li>‚úÖ For long-term campaigns use <strong>utm_id</strong> for better tracking</li>
                        <li>‚úÖ Regularly <strong>backup your data</strong> to JSON file</li>
                    </ul>
                    <p style="text-align: right;"><a href="#help-toc" style="font-size: 12px; color: #1e88e5;">‚¨ÜÔ∏è Back to contents</a></p>
                </section>
            </div>
        </div>
    </div>
    
    <input type="file" id="restoreFile" accept=".json" style="display: none;">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
        // === APPLICATION VERSION ===
        const APP_VERSION = '1.0.0';
        const APP_BUILD_DATE = '2025-01-31';
        const STORAGE_VERSION = '1'; // For future data migrations
        // Log version to console
        console.log(`%cüöÄ UTM Generator v${APP_VERSION}`, 'color: #1e88e5; font-size: 16px; font-weight: bold;');
        console.log(`üìÖ Build: ${APP_BUILD_DATE}`);
        console.log(`üíæ Storage version: ${STORAGE_VERSION}`);
        // === END VERSION INFO ===
        // === BROWSER COMPATIBILITY CHECK ===
        (function checkBrowserCompatibility() {
            const incompatibilities = [];
            
            // 1. LocalStorage
            if (typeof(Storage) === "undefined") {
                incompatibilities.push("LocalStorage is not supported");
            }
            
            // 2. FileReader API (for backup/restore)
            if (typeof(FileReader) === "undefined") {
                incompatibilities.push("FileReader API is not supported (restore from backup won't work)");
            }
            
            // 3. URL API (for validation)
            try {
                new URL("https://example.com");
            } catch(e) {
                incompatibilities.push("URL API is not supported (URL validation won't work)");
            }
            
            // 4. Set object (for autocomplete)
            if (typeof(Set) === "undefined") {
                incompatibilities.push("Set object is not supported (autocomplete won't work)");
            }
            
            // 5. ES6 features
            try {
                eval("const test = () => {};");
                eval("const {test} = {test: 1};");
                eval("`template string`");
            } catch(e) {
                incompatibilities.push("Modern JavaScript (ES6) is not supported");
            }
            
            // 6. Fetch API (for future extensions)
            if (typeof(fetch) === "undefined") {
                incompatibilities.push("Fetch API is not supported (limited functionality)");
            }
            
            // If there are any issues, show warning
            if (incompatibilities.length > 0) {
                const warningDiv = document.createElement('div');
                warningDiv.id = 'browserCompatWarning';
                warningDiv.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    background: #d32f2f;
                    color: white;
                    padding: 15px 20px;
                    text-align: center;
                    font-weight: 600;
                    z-index: 999999;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                `;
                
                warningDiv.innerHTML = `
                    <div style="max-width: 1200px; margin: 0 auto;">
                        <strong>‚ö†Ô∏è Your browser is not fully compatible with this application!</strong><br>
                        <span style="font-size: 13px; opacity: 0.95;">
                            Issues: ${incompatibilities.join(', ')}
                        </span><br>
                        <span style="font-size: 12px; margin-top: 5px; display: inline-block;">
                            We recommend using: Chrome 90+, Firefox 88+, Edge 90+, Safari 14+
                        </span>
                    </div>
                `;
                
                // Add warning as soon as DOM is ready
                if (document.body) {
                    document.body.insertBefore(warningDiv, document.body.firstChild);
                } else {
                    document.addEventListener('DOMContentLoaded', function() {
                        document.body.insertBefore(warningDiv, document.body.firstChild);
                    });
                }
                
                console.error("Browser compatibility issues detected:", incompatibilities);
                
                // Log browser info
                console.log("User Agent:", navigator.userAgent);
            } else {
                console.log("‚úÖ Browser compatibility check passed!");
            }
        })();
        // === END BROWSER COMPATIBILITY CHECK ===
        // === OFFLINE/ONLINE INDICATOR ===
        (function setupNetworkMonitoring() {
            let isOnline = navigator.onLine;
            
            function showNetworkStatus(online) {
                // Remove old warning (if exists)
                const oldWarning = document.getElementById('networkWarning');
                if (oldWarning) oldWarning.remove();
                
                // If offline, show warning
                if (!online) {
                    const warningDiv = document.createElement('div');
                    warningDiv.id = 'networkWarning';
                    warningDiv.style.cssText = `
                        position: fixed;
                        top: 0;
                        left: 0;
                        right: 0;
                        background: #ff9800;
                        color: white;
                        padding: 10px 20px;
                        text-align: center;
                        font-weight: 600;
                        z-index: 99998;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
                        font-size: 14px;
                    `;
                    
                    warningDiv.innerHTML = `
                        <div style="max-width: 1200px; margin: 0 auto;">
                            üì° <strong>You are offline</strong> ‚Äì Excel export and QR codes won't work. Other features work normally.
                        </div>
                    `;
                    
                    // Add below browser compatibility warning (if exists)
                    const compatWarning = document.getElementById('browserCompatWarning');
                    if (compatWarning && document.body.contains(compatWarning)) {
                        compatWarning.parentNode.insertBefore(warningDiv, compatWarning.nextSibling);
                    } else if (document.body) {
                        document.body.insertBefore(warningDiv, document.body.firstChild);
                    }
                }
            }
            
            // Check on load
            if (document.body) {
                showNetworkStatus(isOnline);
            } else {
                document.addEventListener('DOMContentLoaded', function() {
                    showNetworkStatus(isOnline);
                });
            }
            
            // Listen for network status changes
            window.addEventListener('online', function() {
                isOnline = true;
                showNetworkStatus(true);
                showAlert('‚úÖ Connection restored! Excel export and QR codes are available again.', 'success');
            });
            
            window.addEventListener('offline', function() {
                isOnline = false;
                showNetworkStatus(false);
                showAlert('üì° Connection lost. Excel export and QR codes won\'t work.', 'info');
            });
        })();
        // === END OFFLINE/ONLINE INDICATOR ===
        // --- Global variables ---
        let rows = []; // Array of objects representing table rows
        let rowCounter = 0; // Global counter for unique row IDs
        // Object holding history for autocomplete (as Set for uniqueness)
        let autocompleteData = {
            utm_source: new Set(),
            utm_medium: new Set(),
            utm_campaign: new Set(),
            utm_term: new Set(),
            utm_content: new Set(),
            utm_source_platform: new Set(),
            utm_creative_format: new Set(),
            utm_marketing_tactic: new Set()
        };
        let currentAutocompleteInput = null; // Reference to input with active autocomplete
        let currentQRUrlForDownload = ''; // Base URL for QR code generation (without QR parameters)
        
        // Open developer console
        function openDevConsole() {
            alert('üí° To open Developer Console:\n\n' +
                'ü™ü Windows/Linux: F12 or Ctrl+Shift+I\n' +
                'üçé macOS: Cmd+Option+I\n\n' +
                'Then go to "Console" tab.\n\n' +
                'In console you will find all technical information, warnings and error messages.');
        }
        // Keys for localStorage (constants for clarity)
        const STORAGE_KEYS = {
            rows: 'storageUtmRows',
            counter: 'storageUtmRowCounter',
            autocomplete: 'storageUtmAutocomplete',
            toggleId: 'storageToggleUtmId',
            togglePlatform: 'storageTogglePlatform',
            toggleFormat: 'storageToggleFormat',
            toggleTactic: 'storageToggleTactic'
        };
        // --- Initialization after DOM load ---
        document.addEventListener('DOMContentLoaded', function() {
            loadFromLocalStorage(); // Load saved data
            if (rows.length === 0) { // If nothing was saved, add default rows
                addRow();
                addRow();
                addRow();
            }
            updateStats(); // Update statistics
            // Attach listener for file input (restore from backup)
            document.getElementById('restoreFile').addEventListener('change', handleRestoreFileSelect);
            document.body.dataset.loaded = "true"; // Mark loading as finished
            toggleUtmIdInputsUI(document.getElementById('toggleUtmId').checked); // Set UI for utm_id
            
             // Add listeners for Enter in hex inputs in QR modal
             document.getElementById('qrColorHex').addEventListener('keydown', handleHexEnter);
             document.getElementById('qrBgColorHex').addEventListener('keydown', handleHexEnter);
        });
        // --- UI Management and Settings ---
        // Visually toggles editability of all utm_id fields in table
        function toggleUtmIdInputsUI(isAuto) {
             const utmIdInputs = document.querySelectorAll('input[data-field="utmId"]');
             utmIdInputs.forEach(input => {
                 input.readOnly = isAuto;
                 input.placeholder = isAuto ? "Auto" : "Enter ID"; 
                 if (isAuto) {
                      input.style.backgroundColor = "#f5f5f5";
                      input.style.cursor = "not-allowed";
                 } else {
                      input.style.backgroundColor = "white";
                      input.style.cursor = "text";
                      input.placeholder = "Enter ID"; 
                 }
             });
        }
        
        // Function called when "Automatically generate utm_id" checkbox changes
        function toggleUtmIdGeneration() {
            const isAuto = document.getElementById('toggleUtmId').checked;
            toggleUtmIdInputsUI(isAuto);
            
            if (!isAuto) {
                // Simply clear ALL utm_id fields
                rows.forEach(row => {
                    row.utmId = ''; // Clear data
                    const tr = document.getElementById(`row-${row.id}`);
                    if (tr) {
                        const input = tr.querySelector('input[data-field="utmId"]');
                        if (input) {
                            input.value = ''; // Clear UI
                        }
                    }
                });
                regenerateAllUrls(); // Regenerate URLs without utm_id
            } else {
                regenerateAll(); // Regenerate everything including new utm_id
            }
            
            saveToLocalStorage();
        }
        
        // Updates visibility of advanced columns based on checkboxes
        function updateColumnVisibility() {
            document.body.classList.toggle('show-platform', document.getElementById('togglePlatform').checked);
            document.body.classList.toggle('show-format', document.getElementById('toggleFormat').checked);
            document.body.classList.toggle('show-tactic', document.getElementById('toggleTactic').checked);
            
             // Regenerate URLs and save settings, only if page was already loaded
             if (document.body.dataset.loaded === "true") {
                 regenerateAll(); // regenerateAll calls saveToLocalStorage
             }
        }
        // --- Table Row Manipulation ---
        // Adds new row to table and to `rows` array
        function addRow(prefillData = null) {
            rowCounter++; // Increase global counter for unique ID
            const tbody = document.getElementById('tableBody');
            const tr = document.createElement('tr');
            tr.id = `row-${rowCounter}`;
            tr.dataset.rowId = rowCounter;
            tr.dataset.displayNumber = getNextDisplayNumber(); // Get current sequential number
            const isUtmIdAuto = document.getElementById('toggleUtmId').checked; 
            // Create HTML for new row
            tr.innerHTML = `
                <td class="row-number">${tr.dataset.displayNumber}</td>
                <td><input type="url" data-field="baseUrl" placeholder="https://www.example.com" oninput="autoGenerateUTM(${rowCounter})" onchange="updateRow(${rowCounter})"></td>
                <td class="autocomplete-wrapper"><input type="text" data-field="utmSource" data-autocomplete="utm_source" placeholder="facebook" oninput="handleAutocomplete(this, ${rowCounter}); autoGenerateUTM(${rowCounter})" onchange="updateRow(${rowCounter})"></td>
                <td class="autocomplete-wrapper"><input type="text" data-field="utmMedium" data-autocomplete="utm_medium" placeholder="social" oninput="handleAutocomplete(this, ${rowCounter}); autoGenerateUTM(${rowCounter})" onchange="updateRow(${rowCounter})"></td>
                <td class="autocomplete-wrapper"><input type="text" data-field="utmCampaign" data-autocomplete="utm_campaign" placeholder="summer_sale" oninput="handleAutocomplete(this, ${rowCounter}); autoGenerateUTM(${rowCounter})" onchange="updateRow(${rowCounter})"></td>
                <td class="autocomplete-wrapper"><input type="text" data-field="utmTerm" data-autocomplete="utm_term" placeholder="keywords" oninput="handleAutocomplete(this, ${rowCounter}); autoGenerateUTM(${rowCounter})" onchange="updateRow(${rowCounter})"></td>
                <td class="autocomplete-wrapper"><input type="text" data-field="utmContent" data-autocomplete="utm_content" placeholder="banner_01" oninput="handleAutocomplete(this, ${rowCounter}); autoGenerateUTM(${rowCounter})" onchange="updateRow(${rowCounter})"></td>
                <td><input type="text" data-field="utmId" placeholder="${isUtmIdAuto ? 'Auto' : 'Enter ID'}" ${isUtmIdAuto ? 'readonly style="background: #f5f5f5; cursor: not-allowed;"' : 'style="background: white; cursor: text;"'} oninput="autoGenerateUTM(${rowCounter})" onchange="updateRow(${rowCounter})"></td> 
                <td class="autocomplete-wrapper col-platform"><input type="text" data-field="utmSourcePlatform" data-autocomplete="utm_source_platform" placeholder="facebook_ads" oninput="handleAutocomplete(this, ${rowCounter}); autoGenerateUTM(${rowCounter})" onchange="updateRow(${rowCounter})"></td>
                <td class="autocomplete-wrapper col-format"><input type="text" data-field="utmCreativeFormat" data-autocomplete="utm_creative_format" placeholder="video" oninput="handleAutocomplete(this, ${rowCounter}); autoGenerateUTM(${rowCounter})" onchange="updateRow(${rowCounter})"></td>
                <td class="autocomplete-wrapper col-tactic"><input type="text" data-field="utmMarketingTactic" data-autocomplete="utm_marketing_tactic" placeholder="awareness" oninput="handleAutocomplete(this, ${rowCounter}); autoGenerateUTM(${rowCounter})" onchange="updateRow(${rowCounter})"></td>
                <td class="output-cell" data-field="finalUrl">-</td>
                <td class="status-pending" data-field="status">Waiting for data</td>
                <td><span data-field="qr">-</span></td>
                <td>
                    <div class="action-btns">
                        <button class="icon-btn copy" onclick="copyToClipboard(${rowCounter})" title="Copy Final URL">üìÑ</button>
                        <button class="icon-btn duplicate" onclick="duplicateRow(${rowCounter})" title="Duplicate row">‚ûï</button>
                        <button class="icon-btn delete" onclick="deleteRow(${rowCounter})" title="Delete row">üóëÔ∏è</button>
                    </div>
                </td>
            `;
            tbody.appendChild(tr); // Add row to DOM
            
            // Create object for row data
            const newRow = {
                id: rowCounter, 
                baseUrl: '', utmSource: '', utmMedium: '', utmCampaign: '', utmTerm: '', 
                utmContent: '', utmId: '', utmSourcePlatform: '', utmCreativeFormat: '', 
                utmMarketingTactic: '', finalUrl: '', status: 'pending', qrUrl: '' 
            };
            // If we have data for prefilling (e.g., from duplication or restore)
            if (prefillData) {
                Object.keys(prefillData).forEach(key => {
                    if (newRow.hasOwnProperty(key) && key !== 'id') { 
                        newRow[key] = prefillData[key];
                    }
                });
                
                // Fill inputs with values from prefillData
                Object.keys(newRow).forEach(key => {
                     if (key !== 'id') {
                         const input = tr.querySelector(`input[data-field="${key}"]`);
                         if (key === 'utmId') {
                             // Set value only if auto generation is NOT enabled
                             if (!isUtmIdAuto && input) { 
                                 input.value = newRow[key] || '';
                             } 
                         } else if (input && !input.readOnly) { 
                             input.value = newRow[key] || '';
                         }
                     }
                });
                // Trigger URL generation after short pause
                setTimeout(() => autoGenerateUTM(rowCounter), 50); 
            }
            // Add row data to global array (if not already there - safeguard for restore)
            if (!rows.some(r => r.id === newRow.id)) {
                 rows.push(newRow);
            }
            
            updateStats(); // Update statistics
            saveToLocalStorage(); // Save changes
            
            return rowCounter; // Return new row ID
        }
        // Returns next sequential number for row in table
        function getNextDisplayNumber() {
            const tbody = document.getElementById('tableBody');
            const existingRows = tbody.querySelectorAll('tr');
            return existingRows.length + 1;
        }
        // Renumbers all rows in table and updates `rowCounter`
        function renumberAllRows() {
            const tbody = document.getElementById('tableBody');
            const existingRows = tbody.querySelectorAll('tr');
            let maxId = 0; 
            const shouldGenerateUtmId = document.getElementById('toggleUtmId').checked; 
            existingRows.forEach((tr, index) => {
                const displayNumber = index + 1;
                tr.dataset.displayNumber = displayNumber; // Save number to attribute
                const numberCell = tr.querySelector('.row-number');
                if (numberCell) {
                    numberCell.textContent = displayNumber; // Display number in cell
                }
                
                const rowId = parseInt(tr.dataset.rowId);
                 maxId = Math.max(maxId, rowId); // Track highest existing ID
                
                const row = rows.find(r => r.id === rowId); // Find row data
                const utmIdInput = tr.querySelector('input[data-field="utmId"]'); 
                
                // If auto generation is enabled and we have campaign name, generate ID
                if (row && shouldGenerateUtmId && row.utmCampaign) { 
                    const date = new Date().toISOString().slice(0, 10).replace(/-/g, '');
                    row.utmId = `${date}_${String(displayNumber).padStart(3, '0')}`;
                    if (utmIdInput) {
                        utmIdInput.value = row.utmId; // Write to input
                    }
                } 
                // If auto generation is enabled but campaign is missing, clear ID
                else if (row && shouldGenerateUtmId) { 
                     row.utmId = ''; 
                     if (utmIdInput) utmIdInput.value = '';
                } 
                // If manual entry, ID doesn't change (will be loaded from input in autoGenerateUTM)
            });
             rowCounter = maxId; // Set global counter to highest ID
             toggleUtmIdInputsUI(shouldGenerateUtmId); // Ensure correct readonly/placeholder state
        }
        // --- UTM Generation ---
        // Normalizes and cleans UTM parameter
        function sanitizeUTMParam(value) {
            if (!value) return '';
            
            return value
                .trim()
                .toLowerCase() // Convert to lowercase
                .replace(/\s+/g, '_') // Spaces ‚Üí underscores (summer sale ‚Üí summer_sale)
                .replace(/[^a-z0-9_\-]/g, '') // Remove disallowed characters (only letters, numbers, _ and -)
                .replace(/_{2,}/g, '_') // Multiple underscores ‚Üí one
                .replace(/^[-_]+|[-_]+$/g, ''); // Remove _ and - at start/end
        }
        // Main function for generating UTM URL for given row
        function autoGenerateUTM(rowId) {
            const tr = document.getElementById(`row-${rowId}`);
            if (!tr) return; // Row doesn't exist
            const row = rows.find(r => r.id === rowId);
            if (!row) return; // Data for row doesn't exist
            const utmIdInput = tr.querySelector('input[data-field="utmId"]'); 
            const shouldGenerateUtmId = document.getElementById('toggleUtmId').checked;
            // 1. Load values from inputs to `row` object
            const inputs = tr.querySelectorAll('input[data-field]');
            inputs.forEach(input => {
                const field = input.dataset.field;
                let value = input.value.trim();
                
                // If manual ID entry, read value from input
                if (field === 'utmId' && !shouldGenerateUtmId) {
                    row[field] = value;
                } 
                // BaseUrl is NOT sanitized
                else if (field === 'baseUrl') {
                    row[field] = value;
                }
                // Other UTM fields - sanitize when saving to row, BUT DON'T CHANGE INPUT
                else if (field !== 'utmId') { 
                    row[field] = sanitizeUTMParam(value); // Sanitize only for data
                    // Leave INPUT UNCHANGED - user sees what they typed
                }
                
                // Add SANITIZED value to autocomplete history
                const autocompleteField = input.dataset.autocomplete;
                if (row[field] && autocompleteField && autocompleteData[autocompleteField]) {
                    autocompleteData[autocompleteField].add(row[field]);
                }
            });
            // 2. Generate utm_id if Auto is enabled and we have campaign
            if (shouldGenerateUtmId && row.utmCampaign) {
                const date = new Date().toISOString().slice(0, 10).replace(/-/g, '');
                const displayNumber = tr.dataset.displayNumber || '?'; 
                row.utmId = `${date}_${String(displayNumber).padStart(3, '0')}`;
                if (utmIdInput) utmIdInput.value = row.utmId; // Update input
            } else if (shouldGenerateUtmId) { // Auto, but without campaign
                 row.utmId = '';
                 if (utmIdInput) utmIdInput.value = '';
            } 
            // If not auto, `row.utmId` is already loaded from input
            // 3. Check required fields
            if (!row.baseUrl || !row.utmSource || !row.utmMedium || !row.utmCampaign) {
                row.finalUrl = '';
                row.status = 'pending';
                row.qrUrl = ''; 
                updateRowUI(tr, row); 
                saveToLocalStorage(); 
                return; 
            }
            // 4. Validate Base URL
            if (!validateURL(row.baseUrl)) {
                row.status = 'error';
                row.finalUrl = 'Invalid URL';
                row.qrUrl = ''; 
                updateRowUI(tr, row);
                saveToLocalStorage(); 
                return;
            }
            // 5. Visual indication of generation
            tr.classList.add('generating');
            setTimeout(() => tr.classList.remove('generating'), 300);
            // 6. Clean Base URL from old UTM and hash
            const cleanUrl = cleanURL(row.baseUrl);
            const params = new URLSearchParams();
            
            // 7. Build parameters
            if (row.utmSource) params.set('utm_source', row.utmSource);
            if (row.utmMedium) params.set('utm_medium', row.utmMedium);
            if (row.utmCampaign) params.set('utm_campaign', row.utmCampaign);
            if (row.utmTerm) params.set('utm_term', row.utmTerm);
            if (row.utmContent) params.set('utm_content', row.utmContent);
            if (row.utmId) params.set('utm_id', row.utmId); // Add auto or manual ID
            
            // Add advanced parameters only if their columns are visible
            if (document.getElementById('togglePlatform').checked && row.utmSourcePlatform) params.set('utm_source_platform', row.utmSourcePlatform);
            if (document.getElementById('toggleFormat').checked && row.utmCreativeFormat) params.set('utm_creative_format', row.utmCreativeFormat);
            if (document.getElementById('toggleTactic').checked && row.utmMarketingTactic) params.set('utm_marketing_tactic', row.utmMarketingTactic);
            // 8. Combine URL and parameters
            const separator = cleanUrl.includes('?') ? '&' : '?';
            const paramString = params.toString();
            row.finalUrl = cleanUrl + (paramString ? separator + paramString : ''); 
            // 9. Return original hash (anchor) if it existed
            const anchorMatch = row.baseUrl.match(/#.+$/);
            if (anchorMatch) {
                 row.finalUrl += anchorMatch[0]; 
            }
            // 10. Prepare base URL for QR code (without appearance specification)
            row.qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(row.finalUrl)}`;
            row.status = 'auto'; // Set status
            
            // 11. Update UI, statistics and save
            updateRowUI(tr, row);
            updateStats();
            saveToLocalStorage(); 
        }
        // --- UI Event Handlers ---
        // Duplicates row
        function duplicateRow(rowId) {
            const row = rows.find(r => r.id === rowId);
            if (!row) return;
            const newRowData = { ...row };
            delete newRowData.id; 
            delete newRowData.finalUrl;
            delete newRowData.status;
            delete newRowData.qrUrl;
             // Don't copy utmId if auto-generation is disabled
             if (!document.getElementById('toggleUtmId').checked) {
                 delete newRowData.utmId; 
             }
            // newRowData.baseUrl = ''; // Don't copy Base URL
            const newRowId = addRow(newRowData); // Add new row with data
            
            // Highlight and focus on new row
            const newTr = document.getElementById(`row-${newRowId}`);
            if (newTr) {
                newTr.scrollIntoView({ behavior: 'smooth', block: 'center' });
                newTr.style.background = '#e3f2fd';
                setTimeout(() => { newTr.style.background = ''; }, 1000);
                 const baseUrlInput = newTr.querySelector('input[data-field="baseUrl"]');
                 if (baseUrlInput) { baseUrlInput.focus(); }
            }
            showAlert('Row duplicated (without Base URL)', 'success');
        }
        // Show/hide autocomplete
        function handleAutocomplete(input, rowId = null) { 
            const field = input.dataset.autocomplete;
            if (!field) return; 
            const value = input.value.toLowerCase();
            closeAllAutocomplete(); // Close previous
            if (!value || value.length < 1) return; // No point searching for empty string
            const items = Array.from(autocompleteData[field] || []);
            const filtered = items.filter(item => item.toLowerCase().includes(value)).slice(0, 10); 
            if (filtered.length === 0) return; // Nothing found
            const wrapper = input.closest('.autocomplete-wrapper, .quick-fill-item'); 
            if (!wrapper) return; 
            const autocompleteDiv = document.createElement('div');
            autocompleteDiv.className = 'autocomplete-items';
            // Create list items
            filtered.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'autocomplete-item';
                // Highlight match
                try {
                    const regex = new RegExp(`(${value.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&')})`, 'gi');
                    itemDiv.innerHTML = item.replace(regex, '<strong>$1</strong>');
                } catch (e) { itemDiv.textContent = item; } // Fallback
                // Listener for clicking on item
                itemDiv.addEventListener('click', function() {
                    input.value = item; // Fill input
                    if (rowId !== null) { // If in table
                         autoGenerateUTM(rowId); // Regenerate row
                    } else { // If in Quick Fill
                         if (autocompleteData[field]) { // Add value to history
                             autocompleteData[field].add(item);
                             saveToLocalStorage(); 
                         }
                    }
                    closeAllAutocomplete(); // Close list
                    input.focus(); // Return focus
                });
                autocompleteDiv.appendChild(itemDiv);
            });
            wrapper.style.position = 'relative'; // Necessary for absolute positioning
            wrapper.appendChild(autocompleteDiv); // Add list to DOM
            currentAutocompleteInput = input; // Mark active input
        }
        // Close all open autocompletes
        function closeAllAutocomplete() {
            document.querySelectorAll('.autocomplete-items').forEach(el => el.remove());
            currentAutocompleteInput = null; 
        }
        // Global listener for closing autocomplete by clicking outside
        document.addEventListener('click', function(e) {
             if (!e.target.closest('.autocomplete-wrapper, .quick-fill-item') || !e.target.matches('input[data-autocomplete]')) {
                 if (!e.target.closest('.autocomplete-item')) { 
                    closeAllAutocomplete();
                 }
            }
        });
        // Global listener for keyboard control of autocomplete
        document.addEventListener('keydown', function(e) {
            if (!currentAutocompleteInput) return; // No active autocomplete
            const wrapper = currentAutocompleteInput.closest('.autocomplete-wrapper, .quick-fill-item');
            if (!wrapper) return;
            const autocompleteDiv = wrapper.querySelector('.autocomplete-items');
            if (!autocompleteDiv) return; // No open list
            const items = autocompleteDiv.querySelectorAll('.autocomplete-item');
            if (items.length === 0) return; // No suggestions
            let currentFocusIndex = -1;
            items.forEach((item, index) => {
                if (item.classList.contains('autocomplete-active')) {
                    currentFocusIndex = index;
                }
            });
            // Key responses
            if (e.key === 'ArrowDown') { 
                e.preventDefault(); 
                currentFocusIndex++;
                if (currentFocusIndex >= items.length) currentFocusIndex = 0; 
                addActive(items, currentFocusIndex);
            } else if (e.key === 'ArrowUp') { 
                e.preventDefault(); 
                currentFocusIndex--;
                if (currentFocusIndex < 0) currentFocusIndex = items.length - 1; 
                addActive(items, currentFocusIndex);
            } else if (e.key === 'Enter') { 
                e.preventDefault(); 
                if (currentFocusIndex > -1 && items[currentFocusIndex]) {
                    items[currentFocusIndex].click(); // Simulate click
                } else {
                     closeAllAutocomplete(); // Just close
                }
            } else if (e.key === 'Escape') { 
                closeAllAutocomplete(); // Close
            }
        });
        // Add active class and style to autocomplete item
        function addActive(items, index) {
            removeActive(items); 
            if (index >= 0 && index < items.length) {
                items[index].classList.add('autocomplete-active');
                items[index].style.background = '#e3f2fd'; 
                 items[index].scrollIntoView({ block: 'nearest', inline: 'nearest' });
            }
        }
        // Remove active class and style from all autocomplete items
        function removeActive(items) {
            items.forEach(item => {
                item.classList.remove('autocomplete-active');
                item.style.background = ''; 
            });
        }
        // Called on `onchange` on table inputs (only for saving, doesn't generate)
        function updateRow(rowId) {
            saveToLocalStorage();
            updateStats();
        }
        // Apply Quick Fill values to empty rows
        function applyQuickFill() {
            const quickData = {
                baseUrl: document.getElementById('quickBaseUrl').value.trim(), 
                utmSource: document.getElementById('quickSource').value.trim(),
                utmMedium: document.getElementById('quickMedium').value.trim(),
                utmCampaign: document.getElementById('quickCampaign').value.trim(),
                utmTerm: document.getElementById('quickTerm').value.trim(),
                utmContent: document.getElementById('quickContent').value.trim(),
                utmSourcePlatform: document.getElementById('quickPlatform').value.trim(),
                utmCreativeFormat: document.getElementById('quickFormat').value.trim(),
                utmMarketingTactic: document.getElementById('quickTactic').value.trim()
            };
            let filledCount = 0;
            rows.forEach(row => {
                const tr = document.getElementById(`row-${row.id}`);
                if (!tr) return;
                let rowChanged = false;
                Object.keys(quickData).forEach(key => {
                    const isAdvanced = ['utmSourcePlatform', 'utmCreativeFormat', 'utmMarketingTactic'].includes(key);
                    const isVisible = isAdvanced ? document.getElementById(`toggle${key.replace('utmSourcePlatform', 'Platform').replace('utmCreativeFormat', 'Format').replace('utmMarketingTactic', 'Tactic')}`).checked : true;
                    // Fill if QuickFill has value, row field is empty and column is visible
                    if (quickData[key] && !row[key] && isVisible) {
                        row[key] = quickData[key]; 
                        const input = tr.querySelector(`input[data-field="${key}"]`);
                        if (input) {
                            input.value = quickData[key]; 
                            rowChanged = true;
                        }
                    }
                });
                if (rowChanged) { // If something was filled, regenerate URL
                    autoGenerateUTM(row.id);
                    filledCount++;
                }
            });
            if (filledCount > 0) {
                showAlert(`Filled and generated ${filledCount} rows`, 'success');
            } else {
                showAlert('No empty fields to fill (in visible columns).', 'info');
            }
        }
        // --- Bulk Operations ---
        // Regenerate only URLs of all rows (without renumbering)
        function regenerateAllUrls() {
             let regeneratedCount = 0;
             rows.forEach(row => {
                 autoGenerateUTM(row.id); 
                 if (row.status === 'auto') { 
                     regeneratedCount++;
                 }
             });
             updateStats(); 
        }
        // Renumber rows and regenerate all URLs
        function regenerateAll() {
            renumberAllRows(); // First renumber (also updates auto IDs)
            regenerateAllUrls(); // Then regenerate all URLs with current data
        }
        // Delete row from table and data
        function deleteRow(rowId) {
            if (confirm('Are you sure you want to delete this row?')) {
                const tr = document.getElementById(`row-${rowId}`);
                if (tr) tr.remove(); // Remove from DOM
                
                rows = rows.filter(r => r.id !== rowId); // Remove from data
                
                regenerateAll(); // Renumber and regenerate the rest
                
                showAlert('Row deleted', 'success');
            }
        }
        // Update row appearance (URL, status, QR link)
        function updateRowUI(tr, row) {
            const finalUrlCell = tr.querySelector('[data-field="finalUrl"]');
            const statusCell = tr.querySelector('[data-field="status"]');
            const qrCell = tr.querySelector('[data-field="qr"]');
            if (row.status === 'auto') {
                finalUrlCell.innerHTML = `<a href="${row.finalUrl}" target="_blank" title="${row.finalUrl}">${row.finalUrl}</a>`;
                statusCell.textContent = 'üîÑ Auto';
                statusCell.className = 'status-auto';
                 // For showQRModal use only final URL, details will be set in modal
                qrCell.innerHTML = `<a href="#" class="qr-link" onclick="showQRModal('${row.finalUrl}'); return false;">Show</a>`;
            } else if (row.status === 'error') {
                finalUrlCell.textContent = row.finalUrl; // Display "Invalid URL"
                statusCell.textContent = '‚ùå Error';
                statusCell.className = 'status-error';
                qrCell.textContent = '-';
            } else { // pending
                finalUrlCell.textContent = '-';
                statusCell.textContent = 'Waiting for data';
                statusCell.className = 'status-pending';
                qrCell.textContent = '-';
            }
        }
        // --- URL Validation and Cleaning ---
        // Check if URL has valid format and http/https protocol
        function validateURL(url) {
            try {
                if (!url || typeof url !== 'string' || url.trim().length < 3) return false;
                
                let testUrl = url.trim();
                
                // Check that URL contains at least a dot (domain)
                if (!testUrl.includes('.')) return false;
                
                // Check basic unsupported protocols
                const invalidProtocols = ['javascript:', 'data:', 'file:', 'ftp:', 'ftps:'];
                if (invalidProtocols.some(proto => testUrl.toLowerCase().startsWith(proto))) {
                    return false;
                }
                
                // If URL contains "://" but is NOT http/https, reject
                if (testUrl.includes('://')) {
                    if (!testUrl.startsWith('http://') && !testUrl.startsWith('https://')) {
                        return false; // Invalid protocol like htp:// or ht://
                    }
                } else {
                    // If protocol is missing, add https:// for validation
                    testUrl = 'https://' + testUrl;
                }
                
                // Try to create URL object
                const urlObj = new URL(testUrl);
                
                // Final checks
                if (urlObj.protocol !== 'http:' && urlObj.protocol !== 'https:') return false;
                if (!urlObj.hostname || urlObj.hostname.length < 3) return false;
                if (!urlObj.hostname.includes('.')) return false; // Must have TLD (.com, .cz, etc.)
                
                return true;
            } catch (e) {
                return false; // If URL constructor fails
            }
        }
        // Remove existing UTM parameters and hash (#) from URL
        function cleanURL(url) {
            let clean = url.trim();
            
            // 1. FIRST separate and remove hash
            const hashIndex = clean.indexOf('#');
            if (hashIndex !== -1) {
                clean = clean.substring(0, hashIndex);
            }
            
            try {
                let tempUrl = clean;
                let hadProtocol = tempUrl.match(/^https?:\/\//i);
                
                // Add protocol for parsing if missing
                if (!hadProtocol) { 
                    tempUrl = 'https://' + tempUrl;
                }
                // If URL contains UTM parameters, clean them
                if (tempUrl.toLowerCase().includes('utm_')) {
                    const urlObj = new URL(tempUrl);
                    const params = new URLSearchParams(urlObj.search);
                    
                    // Delete all UTM parameters
                    ['utm_source', 'utm_medium', 'utm_campaign', 'utm_term', 'utm_content', 
                    'utm_id', 'utm_source_platform', 'utm_creative_format', 'utm_marketing_tactic'].forEach(p => params.delete(p));
                    
                    // Rebuild URL
                    let baseUrl = urlObj.origin;
                    
                    // Add pathname only if not just '/' OR if original URL had slash
                    if (urlObj.pathname !== '/' || clean.match(/^[^?#]*\/($|\?|#)/)) {
                        baseUrl += urlObj.pathname;
                    }
                    
                    clean = baseUrl + (params.toString() ? '?' + params.toString() : '');
                } else {
                    // URL doesn't contain UTM - if protocol missing, add https://
                    if (!hadProtocol) {
                        clean = 'https://' + clean;
                    }
                }
            } catch (e) { 
                console.warn("Could not parse URL for cleaning:", clean, e);
                // On error - if protocol missing, add https://
                if (!clean.match(/^https?:\/\//i)) {
                    clean = 'https://' + clean;
                }
            }
            
            // Return cleaned URL WITHOUT hash (hash will be added later in autoGenerateUTM)
            return clean;
        }
        // --- QR Modal Functions ---
        // Show modal with QR code
        function showQRModal(finalUrl) {
            // Check online status
            if (!navigator.onLine) {
                showAlert('‚ùå QR code generation requires internet connection (generation API).', 'error');
                return;
            }
            currentQRUrlForDownload = finalUrl; // Save base URL
            document.getElementById('qrUrl').textContent = finalUrl;
            // Set default values for controls in modal
             document.getElementById('qrEccLevel').value = 'H';
             document.getElementById('qrMargin').value = 10;
             document.getElementById('qrColor').value = '#000000';
             document.getElementById('qrBgColor').value = '#ffffff';
             document.getElementById('qrColorHex').value = '#000000'; 
             document.getElementById('qrBgColorHex').value = '#ffffff'; 
            updateQRPreview(); // Generate QR code with these values
            document.getElementById('qrModal').style.display = 'block'; // Show modal
        }
        // Close QR modal
        function closeQRModal() {
            document.getElementById('qrModal').style.display = 'none';
            document.getElementById('qrImage').src = ''; // Clear image
        }
        // Validate if string is valid 6-digit hex code with #
        function isValidHexColor(hex) {
            return /^#?([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/.test(hex.trim());
        }
        // Convert 3-digit hex to 6-digit (e.g., #F00 -> #FF0000)
        // and ensure it always has # and uppercase letters.
        // Returns '#000000' for invalid hex or empty input.
        function expandHexColor(hex) {
            let cleanHex = hex.trim().startsWith('#') ? hex.trim().substring(1) : hex.trim();
            if (cleanHex.length === 3) {
                // Expand 3-digit hex (e.g., F00 -> FF0000)
                return '#' + cleanHex[0] + cleanHex[0] + cleanHex[1] + cleanHex[1] + cleanHex[2] + cleanHex[2];
            } else if (cleanHex.length === 6) {
                // Ensure 6-digit hex always starts with # and is uppercase
                return '#' + cleanHex.toUpperCase();
            }
            // If not a valid 3 or 6 digit hex, return a default or original if specific behavior needed
            // For our purpose, if isValidHexColor already passed, this should always return a valid value.
            // If it got an invalid value, isValidHexColor would have prevented this call.
            return '#000000'; // Fallback for safety, though isValidHexColor should prevent reaching here with truly invalid hexes
        }
        // Function called when QR code settings change in modal
        function updateQRPreview() {
            if (!currentQRUrlForDownload) return; // If we don't have URL
            const ecc = document.getElementById('qrEccLevel').value;
            const margin = document.getElementById('qrMargin').value;
            // Get colors from text fields and validate
            let colorHexRaw = document.getElementById('qrColorHex').value;
            let bgColorHexRaw = document.getElementById('qrBgColorHex').value;
            let colorHex = '#000000'; // Default
            let bgColorHex = '#ffffff'; // Default
            // --- Processing code color (qrColorHex) ---
            if (isValidHexColor(colorHexRaw)) {
                colorHex = expandHexColor(colorHexRaw);
                document.getElementById('qrColorHex').value = colorHex; // <<-- Update text field with expanded value
            } else {
                // If input is invalid, return text field to current color picker value
                // (which should be last valid color or default).
                colorHex = document.getElementById('qrColor').value;
                document.getElementById('qrColorHex').value = colorHex;
            }
            document.getElementById('qrColor').value = colorHex; // Sync color picker
            // --- Processing background color (qrBgColorHex) ---
            if (isValidHexColor(bgColorHexRaw)) {
                bgColorHex = expandHexColor(bgColorHexRaw);
                document.getElementById('qrBgColorHex').value = bgColorHex; // <<-- Update text field with expanded value
            } else {
                bgColorHex = document.getElementById('qrBgColor').value;
                document.getElementById('qrBgColorHex').value = bgColorHex;
            }
            document.getElementById('qrBgColor').value = bgColorHex; // Sync color picker
            // Convert for API (without #)
            const color = colorHex.substring(1);
            const bgColor = bgColorHex.substring(1);
            // Build URL for API server
            const encodedUrl = encodeURIComponent(currentQRUrlForDownload);
            const apiUrl = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodedUrl}&ecc=${ecc}&margin=${margin}&color=${color}&bgcolor=${bgColor}`;
            // Set image source in modal
            document.getElementById('qrImage').src = apiUrl;
        }
        
        // Sync color picker during live typing in hex field, without changing text field
        function handleHexInput(textInput, colorInputId) {
            const colorInput = document.getElementById(colorInputId);
            let hexValue = textInput.value.trim();
            // If entered value is valid hex code (3 or 6 digit), update color picker
            if (isValidHexColor(hexValue)) {
                // For color picker, 6-digit code is better
                colorInput.value = expandHexColor(hexValue);
            }
            // IMPORTANT: NEVER change textInput.value here. That's done only in updateQRPreview()
            // this way user can freely type without text changing under their hands.
        }
         
        // Update QR on Enter press in hex field
        function handleHexEnter(event) {
            if (event.key === 'Enter') {
                event.preventDefault(); // Prevent possible form submission
                updateQRPreview(); // Force preview update
            }
        }
        // Download QR code in requested format with current settings
        function downloadQR(format) {
            const ecc = document.getElementById('qrEccLevel').value;
            const margin = document.getElementById('qrMargin').value;
            let colorHexRaw = document.getElementById('qrColorHex').value;
            let bgColorHexRaw = document.getElementById('qrBgColorHex').value;
            // Validation and fallback (in case they left field with invalid value)
            let colorHex = '#000000';
            let bgColorHex = '#ffffff';
            if (isValidHexColor(colorHexRaw)) colorHex = expandHexColor(colorHexRaw); else colorHex = document.getElementById('qrColor').value;
            if (isValidHexColor(bgColorHexRaw)) bgColorHex = expandHexColor(bgColorHexRaw); else bgColorHex = document.getElementById('qrBgColor').value;
            const color = colorHex.substring(1);
            const bgColor = bgColorHex.substring(1);
            let url = '';
            const encodedUrl = encodeURIComponent(currentQRUrlForDownload); 
            // Larger size for download + current parameters
            const baseApiUrl = `https://api.qrserver.com/v1/create-qr-code/?size=600x600&ecc=${ecc}&margin=${margin}&color=${color}&bgcolor=${bgColor}`; 
            
            // Build URL according to format
            switch(format) {
                case 'png': url = `${baseApiUrl}&format=png&data=${encodedUrl}`; break;
                case 'jpeg': url = `${baseApiUrl}&format=jpg&data=${encodedUrl}`; break;
                case 'svg': url = `${baseApiUrl}&format=svg&data=${encodedUrl}`; break;
                case 'eps': url = `${baseApiUrl}&format=eps&data=${encodedUrl}`; break;
                default: showAlert('Unknown format for QR code download.', 'error'); return;
            }
            // Create link and simulate click
            const link = document.createElement('a');
            link.href = url;
            link.target = '_blank'; // Opens SVG/EPS in new window if can't download
            link.download = `qr-code-${Date.now()}.${format}`; 
            document.body.appendChild(link); 
            link.click();
            document.body.removeChild(link); // Clean up link
            showAlert(`QR code ${format.toUpperCase()} is downloading...`, 'success');
        }
        // --- End QR Modal Functions ---
        // --- Export Functions ---
        function exportToCSV() {
            const headers = ['#', 'Base URL', 'utm_source', 'utm_medium', 'utm_campaign', 'utm_term', 
                            'utm_content', 'utm_id', 'utm_source_platform', 'utm_creative_format', 
                            'utm_marketing_tactic', 'Final UTM URL', 'Status'];
            
            let csv = headers.join(',') + '\n';
            
            rows.forEach((row, index) => { 
                const rowData = [
                    index + 1, 
                    `"${row.baseUrl || ''}"`, `"${row.utmSource || ''}"`, `"${row.utmMedium || ''}"`,
                    `"${row.utmCampaign || ''}"`, `"${row.utmTerm || ''}"`, `"${row.utmContent || ''}"`,
                    `"${row.utmId || ''}"`, `"${row.utmSourcePlatform || ''}"`, `"${row.utmCreativeFormat || ''}"`,
                    `"${row.utmMarketingTactic || ''}"`, `"${row.finalUrl || ''}"`, `"${row.status || 'pending'}"`
                ];
                csv += rowData.join(',') + '\n';
            });
            // Create and download file
            const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' }); // \uFEFF for UTF-8 BOM (Excel)
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.href = url;
            link.download = `utm-links-${new Date().toISOString().slice(0,10)}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url); // Free memory
            showAlert('CSV file downloaded', 'success');
        }
        function exportToExcel() {
             if (!navigator.onLine) {
                showAlert('‚ùå Excel export requires internet connection (loading SheetJS library).', 'error');
                return;
             }
             // Check if SheetJS (XLSX) library is loaded
             if (typeof XLSX === 'undefined') {
                 showAlert('Error: Library for Excel export was not loaded. Check internet connection and try reloading the page.', 'error');
                 return;
             }
        
            // Prepare data for SheetJS (array of arrays)
            const data = [
                ['#', 'Base URL', 'utm_source', 'utm_medium', 'utm_campaign', 'utm_term', 
                 'utm_content', 'utm_id', 'utm_source_platform', 'utm_creative_format', 
                 'utm_marketing_tactic', 'Final UTM URL', 'Status']
            ];
            rows.forEach((row, index) => { 
                 data.push([
                    index + 1, row.baseUrl, row.utmSource, row.utmMedium, row.utmCampaign, row.utmTerm, 
                    row.utmContent, row.utmId, row.utmSourcePlatform, row.utmCreativeFormat, 
                    row.utmMarketingTactic, row.finalUrl, row.status
                ]);
            });
            // Create workbook and sheet
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(data);
            
            // Set column widths (approximately)
            ws['!cols'] = [
                {wch: 5}, {wch: 40}, {wch: 15}, {wch: 15}, {wch: 25}, {wch: 15}, 
                {wch: 15}, {wch: 20}, {wch: 20}, {wch: 20}, {wch: 20}, {wch: 60}, {wch: 10} 
            ];
            XLSX.utils.book_append_sheet(wb, ws, 'UTM Links'); // Add sheet to workbook
            
            // Try to download file
            try {
                 XLSX.writeFile(wb, `utm-links-${new Date().toISOString().slice(0,10)}.xlsx`);
                 showAlert('Excel file downloaded', 'success');
            } catch (error) {
                 console.error("Excel export error:", error);
                 showAlert('Failed to export to Excel.', 'error');
            }
        }
        // --- Data Management Functions ---
        // Delete all rows from table and data
        function clearAll() { 
            if (confirm('Are you sure you want to delete all rows? Autocomplete history and settings will be preserved.')) {
                document.getElementById('tableBody').innerHTML = ''; // Clear DOM
                rows = []; // Clear data
                rowCounter = 0; // Reset counter for new rows
                
                // Add default empty rows
                addRow();
                addRow();
                addRow();
                
                updateStats(); // Update statistics
                saveToLocalStorage(); // Save empty state
                showAlert('All rows deleted', 'info');
            }
        }
        
        // Clear autocomplete history
        function clearAutocompleteHistory() {
             if (confirm('Are you sure you want to clear entire autocomplete history? Row data will remain unchanged.')) {
                 // Reset history object
                 autocompleteData = {
                    utm_source: new Set(), utm_medium: new Set(), utm_campaign: new Set(), utm_term: new Set(), 
                    utm_content: new Set(), utm_source_platform: new Set(), utm_creative_format: new Set(), 
                    utm_marketing_tactic: new Set()
                };
                saveToLocalStorage(); // Save empty history
                showAlert('Autocomplete history cleared.', 'success');
             }
        }
        
        // Delete all data from localStorage and reload page
        function resetApplicationState() {
             if (confirm('WARNING: Are you sure you want to delete ALL saved data (rows, autocomplete history and column settings) and reset application to default state? This action is irreversible!')) {
                 if (confirm('FINAL WARNING: Are you absolutely sure? All data will be lost.')) {
                     try {
                         // Go through all defined keys and delete them
                         Object.values(STORAGE_KEYS).forEach(key => {
                             localStorage.removeItem(key);
                         });
                         
                         showAlert('Application reset. Page will reload.', 'success');
                         
                         // Reload page after short pause
                         setTimeout(() => { location.reload(); }, 1500);
                     } catch (error) {
                         console.error("Reset error:", error);
                         showAlert('Failed to reset application.', 'error');
                     }
                 }
             }
        }
        // --- Utility Functions ---
        // Update displayed statistics (row count, generated, errors)
        function updateStats() {
            document.getElementById('totalRows').textContent = rows.length;
            document.getElementById('generatedRows').textContent = rows.filter(r => r.status === 'auto').length;
            document.getElementById('errorRows').textContent = rows.filter(r => r.status === 'error').length;
        }
        // Show temporary notification at top of page
        function showAlert(message, type = 'info') {
            const alertBox = document.getElementById('alertBox');
            // If alert is already shown, cancel its timeout
            if (alertBox.dataset.timeoutId) {
                clearTimeout(parseInt(alertBox.dataset.timeoutId));
            }
            // Set text and class (color)
            alertBox.textContent = message;
            alertBox.className = `alert alert-${type} show`;
            
            // Set new timeout for hiding
            const timeoutId = setTimeout(() => {
                 if (alertBox.classList.contains('show')) { // Hide only if still visible
                    alertBox.classList.remove('show');
                 }
                 delete alertBox.dataset.timeoutId; // Clean up timeout ID
            }, 5000);
            alertBox.dataset.timeoutId = timeoutId.toString(); // Save timeout ID
        }
        // --- Local Storage Handling ---
        // Show persistent warning about localStorage issues
        function showStorageWarning(message) {
            let warningBar = document.getElementById('storageWarningBar');
            
            // If warning doesn't exist yet, create it
            if (!warningBar) {
                warningBar = document.createElement('div');
                warningBar.id = 'storageWarningBar';
                warningBar.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    background: #ff9800;
                    color: white;
                    padding: 12px 20px;
                    text-align: center;
                    font-weight: 600;
                    z-index: 99999;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    gap: 15px;
                `;
                
                const closeBtn = document.createElement('button');
                closeBtn.textContent = '‚úï';
                closeBtn.style.cssText = `
                    background: rgba(255,255,255,0.3);
                    border: none;
                    color: white;
                    padding: 4px 10px;
                    border-radius: 3px;
                    cursor: pointer;
                    font-size: 16px;
                    font-weight: bold;
                `;
                closeBtn.onclick = () => warningBar.style.display = 'none';
                
                warningBar.innerHTML = `<span>‚ö†Ô∏è ${message}</span>`;
                warningBar.appendChild(closeBtn);
                
                document.body.insertBefore(warningBar, document.body.firstChild);
            } else {
                // Update text and show
                warningBar.querySelector('span').innerHTML = `‚ö†Ô∏è ${message}`;
                warningBar.style.display = 'flex';
            }
        }
        // Hide localStorage warning
        function hideStorageWarning() {
            const warningBar = document.getElementById('storageWarningBar');
            if (warningBar) {
                warningBar.style.display = 'none';
            }
        }
        
        // Save current state (rows, history, settings) to localStorage
        function saveToLocalStorage() {
            try {
                localStorage.setItem(STORAGE_KEYS.rows, JSON.stringify(rows));
                localStorage.setItem(STORAGE_KEYS.counter, rowCounter.toString()); 
                
                const autocompleteToSave = {};
                for (const key in autocompleteData) {
                    if (autocompleteData.hasOwnProperty(key)) {
                        autocompleteToSave[key] = Array.from(autocompleteData[key]);
                    }
                }
                localStorage.setItem(STORAGE_KEYS.autocomplete, JSON.stringify(autocompleteToSave));
                
                localStorage.setItem(STORAGE_KEYS.toggleId, document.getElementById('toggleUtmId').checked.toString());
                localStorage.setItem(STORAGE_KEYS.togglePlatform, document.getElementById('togglePlatform').checked.toString());
                localStorage.setItem(STORAGE_KEYS.toggleFormat, document.getElementById('toggleFormat').checked.toString());
                localStorage.setItem(STORAGE_KEYS.toggleTactic, document.getElementById('toggleTactic').checked.toString());
                
                hideStorageWarning();
                
            } catch (error) {
                // Only log, NEVER use throw or alert here
                console.error("Error saving to localStorage:", error);
                
                // Show warning asynchronously so it doesn't block
                setTimeout(() => {
                    if (error.name === 'QuotaExceededError') {
                        showStorageWarning('Browser storage is full!');
                    } else {
                        showStorageWarning('Error saving data.');
                    }
                }, 100);
            }
        }
        // Load saved state from localStorage
        function loadFromLocalStorage() {
            // Check data version (for future migrations)
            const savedStorageVersion = localStorage.getItem('utm_storage_version');
            if (savedStorageVersion && savedStorageVersion !== STORAGE_VERSION) {
                console.warn(`Storage version mismatch: saved=${savedStorageVersion}, current=${STORAGE_VERSION}`);
            }
            // Save current version
            localStorage.setItem('utm_storage_version', STORAGE_VERSION);
            // Test localStorage on startup
            try {
                if (typeof(Storage) === "undefined") {
                    showStorageWarning('LocalStorage is not supported. Data won\'t be saved between sessions!');
                }
            } catch (e) {
                showStorageWarning('Problem accessing browser storage.');
            }
            // Load checkbox settings
            const savedToggleUtmId = localStorage.getItem(STORAGE_KEYS.toggleId);
            const savedTogglePlatform = localStorage.getItem(STORAGE_KEYS.togglePlatform);
            const savedToggleFormat = localStorage.getItem(STORAGE_KEYS.toggleFormat);
            const savedToggleTactic = localStorage.getItem(STORAGE_KEYS.toggleTactic);
            // Apply saved or default checkbox values
            if (savedToggleUtmId !== null) document.getElementById('toggleUtmId').checked = (savedToggleUtmId === 'true');
            if (savedTogglePlatform !== null) document.getElementById('togglePlatform').checked = (savedTogglePlatform === 'true');
            if (savedToggleFormat !== null) document.getElementById('toggleFormat').checked = (savedToggleFormat === 'true');
            if (savedToggleTactic !== null) document.getElementById('toggleTactic').checked = (savedToggleTactic === 'true');
            
            updateColumnVisibility(); // Set column visibility BEFORE loading rows
            // Load autocomplete history
            const savedAutocomplete = localStorage.getItem(STORAGE_KEYS.autocomplete);
            if (savedAutocomplete) {
                try {
                    const data = JSON.parse(savedAutocomplete);
                    // Reset and fill Set objects
                    autocompleteData = { utm_source: new Set(), utm_medium: new Set(), utm_campaign: new Set(), utm_term: new Set(), utm_content: new Set(), utm_source_platform: new Set(), utm_creative_format: new Set(), utm_marketing_tactic: new Set() }; 
                    Object.keys(data).forEach(key => {
                        if (autocompleteData.hasOwnProperty(key) && Array.isArray(data[key])) {
                             autocompleteData[key] = new Set(data[key]);
                        }
                    });
                } catch (e) { console.error("Error parsing autocomplete data:", e); }
            }
            // Load rows and counter
            const savedCounter = localStorage.getItem(STORAGE_KEYS.counter);
            rowCounter = parseInt(savedCounter) || 0; 
            
            const savedRows = localStorage.getItem(STORAGE_KEYS.rows);
            rows = []; // Always reset rows array
            document.getElementById('tableBody').innerHTML = ''; // Clear table DOM
            let maxIdFound = 0; // Track highest ID to set rowCounter
            if (savedRows) {
                 try {
                    const data = JSON.parse(savedRows);
                    if (Array.isArray(data)) { 
                        // Go through saved data and create rows in table
                        data.forEach(rowData => {
                             if (rowData && typeof rowData === 'object' && rowData.id != null) { 
                                maxIdFound = Math.max(maxIdFound, rowData.id); // Update max ID
                                const rowId = rowData.id; 
                                
                                const tbody = document.getElementById('tableBody');
                                const tr = document.createElement('tr');
                                tr.id = `row-${rowId}`;
                                tr.dataset.rowId = rowId;
                                const isUtmIdAutoOnLoad = document.getElementById('toggleUtmId').checked; 
                                // Create row HTML (same as in addRow, including logic for readonly utmId)
                                tr.innerHTML = `
                                    <td class="row-number"></td> <td><input type="url" data-field="baseUrl" placeholder="https://www.example.com" oninput="autoGenerateUTM(${rowId})" onchange="updateRow(${rowId})"></td> <td class="autocomplete-wrapper"><input type="text" data-field="utmSource" data-autocomplete="utm_source" placeholder="facebook" oninput="handleAutocomplete(this, ${rowId}); autoGenerateUTM(${rowId})" onchange="updateRow(${rowId})"></td> <td class="autocomplete-wrapper"><input type="text" data-field="utmMedium" data-autocomplete="utm_medium" placeholder="social" oninput="handleAutocomplete(this, ${rowId}); autoGenerateUTM(${rowId})" onchange="updateRow(${rowId})"></td> <td class="autocomplete-wrapper"><input type="text" data-field="utmCampaign" data-autocomplete="utm_campaign" placeholder="summer_sale" oninput="handleAutocomplete(this, ${rowId}); autoGenerateUTM(${rowId})" onchange="updateRow(${rowId})"></td> <td class="autocomplete-wrapper"><input type="text" data-field="utmTerm" data-autocomplete="utm_term" placeholder="keywords" oninput="handleAutocomplete(this, ${rowId}); autoGenerateUTM(${rowId})" onchange="updateRow(${rowId})"></td> <td class="autocomplete-wrapper"><input type="text" data-field="utmContent" data-autocomplete="utm_content" placeholder="banner_01" oninput="handleAutocomplete(this, ${rowId}); autoGenerateUTM(${rowId})" onchange="updateRow(${rowId})"></td> <td><input type="text" data-field="utmId" placeholder="${isUtmIdAutoOnLoad ? 'Auto' : 'Enter ID'}" ${isUtmIdAutoOnLoad ? 'readonly style="background: #f5f5f5; cursor: not-allowed;"' : 'style="background: white; cursor: text;"'} oninput="autoGenerateUTM(${rowId})" onchange="updateRow(${rowId})"></td> <td class="autocomplete-wrapper col-platform"><input type="text" data-field="utmSourcePlatform" data-autocomplete="utm_source_platform" placeholder="facebook_ads" oninput="handleAutocomplete(this, ${rowId}); autoGenerateUTM(${rowId})" onchange="updateRow(${rowId})"></td> <td class="autocomplete-wrapper col-format"><input type="text" data-field="utmCreativeFormat" data-autocomplete="utm_creative_format" placeholder="video" oninput="handleAutocomplete(this, ${rowId}); autoGenerateUTM(${rowId})" onchange="updateRow(${rowId})"></td> <td class="autocomplete-wrapper col-tactic"><input type="text" data-field="utmMarketingTactic" data-autocomplete="utm_marketing_tactic" placeholder="awareness" oninput="handleAutocomplete(this, ${rowId}); autoGenerateUTM(${rowId})" onchange="updateRow(${rowId})"></td> <td class="output-cell" data-field="finalUrl">-</td> <td class="status-pending" data-field="status">Waiting for data</td> <td><span data-field="qr">-</span></td> <td> <div class="action-btns"> <button class="icon-btn copy" onclick="copyToClipboard(${rowId})" title="Copy Final URL">üìÑ</button> <button class="icon-btn duplicate" onclick="duplicateRow(${rowId})" title="Duplicate row">‚ûï</button> <button class="icon-btn delete" onclick="deleteRow(${rowId})" title="Delete row">üóëÔ∏è</button> </div> </td>
                                `;
                                tbody.appendChild(tr);
                                // Create row object and add to `rows` array
                                const newRow = { id: rowId, ...rowData }; 
                                rows.push(newRow); 
                                // Fill inputs with values from loaded data
                                Object.keys(newRow).forEach(key => {
                                     if (key !== 'id') {
                                         const input = tr.querySelector(`input[data-field="${key}"]`);
                                         if (key === 'utmId') {
                                              // If not auto, set saved value
                                              if (!isUtmIdAutoOnLoad && input) {
                                                   input.value = newRow[key] || '';
                                              }
                                              // If auto, value will be generated later in regenerateAll
                                         } else if (input && !input.readOnly) {
                                             input.value = newRow[key] || '';
                                         }
                                     }
                                });
                             } else { console.warn("Skipping invalid row data:", rowData); }
                        });
                        
                        // Set `rowCounter` to highest found ID (or to saved counter if higher)
                        rowCounter = Math.max(rowCounter, maxIdFound); 
                        if (rows.length > 0) { // If we loaded any rows
                            regenerateAll(); // Renumber and regenerate all loaded rows
                        } 
                    } else { console.error("Saved rows data is not an array:", data); }
                 } catch (e) { console.error("Error parsing rows data:", e); }
            } 
            
            // If after all loading attempts we still don't have any rows in `rows` array
            if (rows.length === 0) {
                 addRow(); addRow(); addRow(); // Add default empty rows
            }
            // If after all loading attempts we still don't have any rows in `rows` array
            if (rows.length === 0) {
                addRow(); addRow(); addRow(); // Add default empty rows
            }
            
            // === STATISTICS TO CONSOLE (ADD THIS SECTION) ===
            console.log('%cüìä Loaded data statistics', 'color: #1e88e5; font-size: 14px; font-weight: bold;');
            console.log(`üìù Number of rows: ${rows.length}`);
            console.log(`‚úÖ Generated: ${rows.filter(r => r.status === 'auto').length}`);
            console.log(`‚è≥ Pending: ${rows.filter(r => r.status === 'pending').length}`);
            console.log(`‚ùå Errors: ${rows.filter(r => r.status === 'error').length}`);
            
            // Autocomplete history statistics
            const totalAutocompleteItems = Object.values(autocompleteData).reduce((sum, set) => sum + set.size, 0);
            console.log(`üîç Autocomplete history: ${totalAutocompleteItems} items`);
            
            // Detailed breakdown by fields
            console.log('%c   Breakdown by fields:', 'color: #757575; font-size: 12px;');
            Object.keys(autocompleteData).forEach(key => {
                const count = autocompleteData[key].size;
                if (count > 0) {
                    console.log(`   ‚Ä¢ ${key}: ${count} values`);
                }
            });
            
            // Info about saved checkbox state
            console.log(`‚öôÔ∏è Settings:`);
            console.log(`   ‚Ä¢ Auto utm_id: ${document.getElementById('toggleUtmId').checked ? 'YES' : 'NO'}`);
            console.log(`   ‚Ä¢ Advanced columns: Platform=${document.getElementById('togglePlatform').checked}, Format=${document.getElementById('toggleFormat').checked}, Tactic=${document.getElementById('toggleTactic').checked}`);
            
            // Data size in localStorage (approximately)
            try {
                const dataSize = JSON.stringify(rows).length + JSON.stringify(Array.from(autocompleteData)).length;
                const dataSizeKB = (dataSize / 1024).toFixed(2);
                console.log(`üíæ Approximate data size: ${dataSizeKB} KB`);
            } catch(e) {
                console.log(`üíæ Data size: cannot determine`);
            }
            
            console.log('%c' + '‚îÄ'.repeat(50), 'color: #e0e0e0;'); // Separator
            // === END STATISTICS ===
        }
        // --- Backup / Restore ---
        // Create and download JSON backup
        function backupData() {
            try {
                // Convert Set objects in autocompleteData to arrays for JSON serialization
                const autocompleteToSave = {};
                for (const key in autocompleteData) {
                    if (autocompleteData.hasOwnProperty(key)) {
                        autocompleteToSave[key] = Array.from(autocompleteData[key]);
                    }
                }
                // Create backup object containing rows and history
                const backupObject = { 
                    version: APP_VERSION,
                    storageVersion: STORAGE_VERSION,
                    exportDate: new Date().toISOString(),
                    rows: rows, 
                    autocompleteData: autocompleteToSave 
                };
                // Convert to JSON with indentation for better readability
                const jsonString = JSON.stringify(backupObject, null, 2); 
                // Create Blob (binary data)
                const blob = new Blob([jsonString], { type: 'application/json;charset=utf-8;' });
                // Create temporary download link
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob); // Create URL for Blob
                link.setAttribute("href", url);
                const today = new Date().toISOString().slice(0, 10); // Date for filename
                link.setAttribute("download", `utm_backup_${today}.json`); // Filename
                link.style.visibility = 'hidden'; // Hide link
                document.body.appendChild(link); // Add to page
                link.click(); // Simulate click
                document.body.removeChild(link); // Remove link
                URL.revokeObjectURL(url); // Free URL object from memory
                showAlert('Data backup successfully downloaded.', 'success');
            } catch (error) {
                console.error("Backup error:", error);
                showAlert('Failed to create backup.', 'error');
            }
        }
        // Start data restore process (trigger click on hidden input)
        function restoreData() {
             if (confirm('Are you sure you want to restore data from backup? All current data (rows and autocomplete history) will be overwritten!')) {
                 document.getElementById('restoreFile').click();
             }
        }
        
        // Process selected file for restore
        function handleRestoreFileSelect(event) {
            const file = event.target.files[0];
            
            if (!file) {
                showAlert('No file selected.', 'error');
                return;
            }
            
            // Type check - JSON can have various MIME types
            const validTypes = ['application/json', 'text/plain', ''];
            if (!validTypes.includes(file.type) && !file.name.endsWith('.json')) {
                showAlert('Error: Selected file is not a valid JSON file.', 'error');
                event.target.value = null;
                return;
            }
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    const backupObject = JSON.parse(content);
                    // === VERSION CHECK (informative) ===
                    if (backupObject.version) {
                        console.log(`üì¶ Restoring backup from version ${backupObject.version} (current: ${APP_VERSION})`);
                        if (backupObject.version !== APP_VERSION) {
                            console.warn(`‚ö†Ô∏è Different versions: backup=${backupObject.version}, application=${APP_VERSION}`);
                        }
                    } else {
                        console.log('üì¶ Restoring backup (no version info - older format)');
                    }
                    // === END VERSION CHECK ===
                    
                    // Structure validation
                    if (!backupObject || typeof backupObject !== 'object') {
                        throw new Error('File does not contain valid object');
                    }
                    if (!Array.isArray(backupObject.rows)) {
                        throw new Error('Missing "rows" field or not an array');
                    }
                    if (!backupObject.autocompleteData || typeof backupObject.autocompleteData !== 'object') {
                        throw new Error('Missing "autocompleteData"');
                    }
                    
                    // Delete existing data
                    rows = [];
                    document.getElementById('tableBody').innerHTML = '';
                    
                    // Restore autocomplete
                    autocompleteData = {
                        utm_source: new Set(),
                        utm_medium: new Set(),
                        utm_campaign: new Set(),
                        utm_term: new Set(),
                        utm_content: new Set(),
                        utm_source_platform: new Set(),
                        utm_creative_format: new Set(),
                        utm_marketing_tactic: new Set()
                    };
                    
                    Object.keys(backupObject.autocompleteData).forEach(key => {
                        if (autocompleteData.hasOwnProperty(key) && Array.isArray(backupObject.autocompleteData[key])) {
                            autocompleteData[key] = new Set(backupObject.autocompleteData[key]);
                        }
                    });
                    
                    // Check if auto-generation of utm_id is enabled
                    const isUtmIdAuto = document.getElementById('toggleUtmId').checked;
                    const tbody = document.getElementById('tableBody');
                    // Restore rows - create HTML directly
                    let maxId = 0;
                    backupObject.rows.forEach((rowData, index) => {
                        if (rowData && rowData.id != null) {
                            maxId = Math.max(maxId, rowData.id);
                            const rowId = rowData.id;
                            
                            // Create HTML row directly
                            const tr = document.createElement('tr');
                            tr.id = `row-${rowId}`;
                            tr.dataset.rowId = rowId;
                            tr.dataset.displayNumber = index + 1;
                            
                            tr.innerHTML = `
                                <td class="row-number">${index + 1}</td>
                                <td><input type="url" data-field="baseUrl" value="${rowData.baseUrl || ''}" placeholder="https://www.example.com" oninput="autoGenerateUTM(${rowId})" onchange="updateRow(${rowId})"></td>
                                <td class="autocomplete-wrapper"><input type="text" data-field="utmSource" data-autocomplete="utm_source" value="${rowData.utmSource || ''}" placeholder="facebook" oninput="handleAutocomplete(this, ${rowId}); autoGenerateUTM(${rowId})" onchange="updateRow(${rowId})"></td>
                                <td class="autocomplete-wrapper"><input type="text" data-field="utmMedium" data-autocomplete="utm_medium" value="${rowData.utmMedium || ''}" placeholder="social" oninput="handleAutocomplete(this, ${rowId}); autoGenerateUTM(${rowId})" onchange="updateRow(${rowId})"></td>
                                <td class="autocomplete-wrapper"><input type="text" data-field="utmCampaign" data-autocomplete="utm_campaign" value="${rowData.utmCampaign || ''}" placeholder="summer_sale" oninput="handleAutocomplete(this, ${rowId}); autoGenerateUTM(${rowId})" onchange="updateRow(${rowId})"></td>
                                <td class="autocomplete-wrapper"><input type="text" data-field="utmTerm" data-autocomplete="utm_term" value="${rowData.utmTerm || ''}" placeholder="keywords" oninput="handleAutocomplete(this, ${rowId}); autoGenerateUTM(${rowId})" onchange="updateRow(${rowId})"></td>
                                <td class="autocomplete-wrapper"><input type="text" data-field="utmContent" data-autocomplete="utm_content" value="${rowData.utmContent || ''}" placeholder="banner_01" oninput="handleAutocomplete(this, ${rowId}); autoGenerateUTM(${rowId})" onchange="updateRow(${rowId})"></td>
                                <td><input type="text" data-field="utmId" value="${!isUtmIdAuto && rowData.utmId ? rowData.utmId : ''}" placeholder="${isUtmIdAuto ? 'Auto' : 'Enter ID'}" ${isUtmIdAuto ? 'readonly style="background: #f5f5f5; cursor: not-allowed;"' : 'style="background: white; cursor: text;"'} oninput="autoGenerateUTM(${rowId})" onchange="updateRow(${rowId})"></td>
                                <td class="autocomplete-wrapper col-platform"><input type="text" data-field="utmSourcePlatform" data-autocomplete="utm_source_platform" value="${rowData.utmSourcePlatform || ''}" placeholder="facebook_ads" oninput="handleAutocomplete(this, ${rowId}); autoGenerateUTM(${rowId})" onchange="updateRow(${rowId})"></td>
                                <td class="autocomplete-wrapper col-format"><input type="text" data-field="utmCreativeFormat" data-autocomplete="utm_creative_format" value="${rowData.utmCreativeFormat || ''}" placeholder="video" oninput="handleAutocomplete(this, ${rowId}); autoGenerateUTM(${rowId})" onchange="updateRow(${rowId})"></td>
                                <td class="autocomplete-wrapper col-tactic"><input type="text" data-field="utmMarketingTactic" data-autocomplete="utm_marketing_tactic" value="${rowData.utmMarketingTactic || ''}" placeholder="awareness" oninput="handleAutocomplete(this, ${rowId}); autoGenerateUTM(${rowId})" onchange="updateRow(${rowId})"></td>
                                <td class="output-cell" data-field="finalUrl">-</td>
                                <td class="status-pending" data-field="status">Waiting for data</td>
                                <td><span data-field="qr">-</span></td>
                                <td>
                                    <div class="action-btns">
                                        <button class="icon-btn copy" onclick="copyToClipboard(${rowId})" title="Copy Final URL">üìÑ</button>
                                        <button class="icon-btn duplicate" onclick="duplicateRow(${rowId})" title="Duplicate row">‚ûï</button>
                                        <button class="icon-btn delete" onclick="deleteRow(${rowId})" title="Delete row">üóëÔ∏è</button>
                                    </div>
                                </td>
                            `;
                            
                            tbody.appendChild(tr);
                            rows.push(rowData);
                        }
                    });
                    rowCounter = maxId;
                    regenerateAll();
                    saveToLocalStorage();
                    
                    showAlert('Data successfully restored! Number of rows: ' + backupObject.rows.length, 'success');
                    
                } catch (error) {
                    console.error('Restore error:', error);
                    showAlert('Error restoring data: ' + error.message, 'error');
                    loadFromLocalStorage();
                } finally {
                    event.target.value = null;
                }
            };
            
            reader.onerror = function(e) {
                console.error('File reading error:', e);
                showAlert('Error reading file.', 'error');
                event.target.value = null;
            };
            
            reader.readAsText(file);
        }
        // --- End Backup / Restore ---
        // --- Other Functions ---
        // Show help modal
        function showHelp() {
            document.getElementById('helpModal').style.display = 'block';
        }
        // Close help modal
        function closeHelpModal() {
            document.getElementById('helpModal').style.display = 'none';
        }
        // Global listener for closing modals by clicking outside
        window.onclick = function(event) {
            const qrModal = document.getElementById('qrModal');
            const helpModal = document.getElementById('helpModal');
            if (event.target == qrModal) { // If we click on QR modal background
                closeQRModal();
            }
            if (event.target == helpModal) { // If we click on Help modal background
                 closeHelpModal();
            }
        }
        // Copy Final URL to clipboard
        function copyToClipboard(rowId) {
            const row = rows.find(r => r.id === rowId);
            if (!row || !row.finalUrl || row.status !== 'auto') {
                showAlert('Nothing to copy. Generate UTM link first.', 'error');
                return;
            }
            
            // Modern Clipboard API (works in most browsers)
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(row.finalUrl)
                    .then(() => {
                        // Visual feedback
                        const btn = document.querySelector(`#row-${rowId} .icon-btn.copy`);
                        if (btn) {
                            const originalText = btn.textContent;
                            btn.classList.add('copied');
                            btn.textContent = '‚úì';
                            
                            setTimeout(() => {
                                btn.classList.remove('copied');
                                btn.textContent = originalText;
                            }, 1500);
                        }
                        showAlert('URL copied to clipboard!', 'success');
                    })
                    .catch(err => {
                        console.error('Clipboard error:', err);
                        fallbackCopyToClipboard(row.finalUrl, rowId);
                    });
            } else {
                // Fallback for older browsers
                fallbackCopyToClipboard(row.finalUrl, rowId);
            }
        }
        // Fallback method for copying (older browsers)
        function fallbackCopyToClipboard(text, rowId) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    const btn = document.querySelector(`#row-${rowId} .icon-btn.copy`);
                    if (btn) {
                        const originalText = btn.textContent;
                        btn.classList.add('copied');
                        btn.textContent = '‚úì';
                        setTimeout(() => {
                            btn.classList.remove('copied');
                            btn.textContent = originalText;
                        }, 1500);
                    }
                    showAlert('URL copied to clipboard!', 'success');
                } else {
                    showAlert('Failed to copy URL. Try manually.', 'error');
                }
            } catch (err) {
                console.error('Fallback copy error:', err);
                showAlert('Copying not supported in this browser.', 'error');
            } finally {
                document.body.removeChild(textarea);
            }
        }
    </script>
</body>
</html>
