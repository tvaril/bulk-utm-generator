<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üîó</text></svg>">
    <title>UTM Bulk Generator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 100%;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1e88e5 0%, #1565c0 100%);
            color: white;
            padding: 20px 30px;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .version-badge {
            display: inline-block;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 14px;
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: 500;
            margin-left: 10px;
            vertical-align: middle;
        }

        .toolbar {
            background: #fafafa;
            padding: 15px 30px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            position: relative;
            z-index: 5;
            align-items: center;
        }

        button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }

        .settings-block button.btn-small {
            padding: 4px 8px;
            font-size: 12px;
        }

        .btn-primary {
            background: #1e88e5;
            color: white;
        }

        .btn-primary:hover {
            background: #1565c0;
        }

        .btn-success {
            background: #43a047;
            color: white;
        }

        .btn-success:hover {
            background: #2e7d32;
        }

        .btn-secondary {
            background: #757575;
            color: white;
        }

        .btn-secondary:hover {
            background: #616161;
        }

        .btn-danger {
            background: #e53935;
            color: white;
        }

        .btn-danger:hover {
            background: #c62828;
        }

        .btn-info {
            background: #00acc1;
            color: white;
        }

        .btn-info:hover {
            background: #00838f;
        }

        .btn-warning {
            background: #ffa726;
            color: white;
        }

        .btn-warning:hover {
            background: #fb8c00;
        }

        .table-container {
            overflow-x: auto;
            padding: 20px 30px;
            position: relative;
            z-index: 10;
        }

        table {
            border-collapse: collapse;
            table-layout: fixed;
        }

        th, td {
            white-space: nowrap;
        }

        th {
            background: #1e88e5;
            color: white;
            padding: 12px 8px;
            text-align: left;
            font-size: 12px;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 100;
            cursor: help;
        }

        th.required::after {
            content: ' *';
            color: #ffeb3b;
        }

        .tooltip-container {
            position: relative;
            display: inline-block;
        }

        .tooltip-icon {
            display: inline-block;
            width: 16px;
            height: 16px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            text-align: center;
            line-height: 16px;
            font-size: 11px;
            margin-left: 4px;
            cursor: help;
            vertical-align: middle;
        }

        .tooltip-text {
            visibility: hidden;
            width: 280px;
            background-color: #333;
            color: #fff;
            text-align: left;
            border-radius: 6px;
            padding: 12px;
            position: absolute;
            z-index: 9999;
            top: 100%;
            left: 50%;
            margin-left: -140px;
            margin-top: 10px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
            line-height: 1.5;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            white-space: normal;
        }

        .tooltip-text::before {
            content: "";
            position: absolute;
            bottom: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: transparent transparent #333 transparent;
        }

        th:hover .tooltip-text,
        .tooltip-icon:hover + .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        .tooltip-example {
            color: #90caf9;
            font-style: italic;
            display: block;
            margin-top: 6px;
            font-size: 11px;
        }

        td {
            padding: 4px;
            border-bottom: 1px solid #e0e0e0;
            position: relative;
        }

        .col-platform, .col-format, .col-tactic {
            display: none;
        }
        .quick-fill-item.col-platform,
        .quick-fill-item.col-format,
        .quick-fill-item.col-tactic {
            display: none;
        }

        body.show-platform th.col-platform,
        body.show-platform td.col-platform {
            display: table-cell;
        }
        body.show-platform .quick-fill-item.col-platform {
            display: flex;
        }

        body.show-format th.col-format,
        body.show-format td.col-format {
            display: table-cell;
        }
        body.show-format .quick-fill-item.col-format {
            display: flex;
        }

        body.show-tactic th.col-tactic,
        body.show-tactic td.col-tactic {
            display: table-cell;
        }
        body.show-tactic .quick-fill-item.col-tactic {
            display: flex;
        }

        tr:hover {
            background: #f5f5f5;
        }

        tr.generating {
            background: #e3f2fd;
            animation: pulse 0.3s;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        input[type="text"], input[type="url"], input[type="number"], select {
            width: 100%;
            box-sizing: border-box;
            min-width: 0;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 11px;
            font-family: inherit;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        input[type="color"] {
            padding: 0;
            border: 1px solid #ddd;
            width: 40px;
            height: 36px;
            cursor: pointer;
            vertical-align: middle;
        }

        input[type="text"].hex-input {
            width: calc(100% - 50px);
            display: inline-block;
            vertical-align: middle;
            margin-left: 5px;
            font-family: monospace;
        }

        input:focus {
            outline: none;
            border-color: #1e88e5;
            box-shadow: 0 0 0 2px rgba(30, 136, 229, 0.1);
        }

        input[readonly] {
            background: #f5f5f5;
            cursor: not-allowed;
        }

        input[data-field="utmId"]:not([readonly]) {
            background: white;
            cursor: text;
        }

        .row-number {
            text-align: center;
            color: #757575;
            font-weight: 500;
            width: 40px;
            min-width: 40px;
        }

        .action-btns {
            display: flex;
            gap: 4px;
        }

        .icon-btn {
            padding: 4px 8px;
            font-size: 16px;
            background: #1e88e5;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            line-height: 1;
        }

        .icon-btn:hover {
            background: #1565c0;
        }

        .icon-btn.duplicate {
            background: #00acc1;
        }

        .icon-btn.duplicate:hover {
            background: #00838f;
        }

        .icon-btn.delete {
            background: #e53935;
        }

        .icon-btn.delete:hover {
            background: #c62828;
        }

        .icon-btn.copy {
            background: #00acc1;
            font-size: 14px;
        }

        .icon-btn.copy:hover {
            background: #00838f;
        }

        .icon-btn.copy.copied {
            background: #43a047;
            animation: copySuccess 0.3s;
        }

        @keyframes copySuccess {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .output-cell {
            font-size: 11px;
            color: #424242;
            max-width: 300px;
            min-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .status-success {
            color: #43a047;
            font-weight: 600;
            font-size: 12px;
        }

        .status-error {
            color: #e53935;
            font-weight: 600;
            font-size: 12px;
        }

        .status-pending {
            color: #fb8c00;
            font-weight: 600;
            font-size: 12px;
        }

        .status-auto {
            color: #1e88e5;
            font-weight: 600;
            font-size: 12px;
        }

        .qr-link {
            color: #1e88e5;
            text-decoration: none;
            font-size: 12px;
        }

        .qr-link:hover {
            text-decoration: underline;
        }

        .stats {
            background: #fafafa;
            padding: 15px 30px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 30px;
        }

        .stat {
            display: flex;
            flex-direction: column;
        }

        .stat-label {
            font-size: 12px;
            color: #757575;
            margin-bottom: 4px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 600;
            color: #1e88e5;
        }

        .autocomplete-wrapper {
            position: relative;
        }

        .autocomplete-items {
            position: absolute;
            border: 1px solid #ddd;
            border-top: none;
            z-index: 999;
            background: white;
            max-height: 200px;
            overflow-y: auto;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            left: 4px;
            right: 4px;
            top: 100%;
        }

        .quick-fill-item .autocomplete-items {
            left: 0;
            right: 0;
        }

        .autocomplete-item {
            padding: 10px;
            cursor: pointer;
            font-size: 11px;
            border-bottom: 1px solid #f0f0f0;
        }

        .autocomplete-item:hover {
            background-color: #e3f2fd;
        }

        .autocomplete-item strong {
            color: #1e88e5;
        }

        .alert {
            padding: 12px 30px;
            margin: 0;
            display: none;
        }

        .alert.show {
            display: block;
        }

        .alert-success {
            background: #c8e6c9;
            color: #2e7d32;
        }

        .alert-error {
            background: #ffcdd2;
            color: #c62828;
        }

        .alert-info {
            background: #bbdefb;
            color: #1565c0;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 85vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .help-modal .modal-content {
            padding: 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .help-modal .modal-header {
            position: sticky;
            top: 0;
            background-color: white;
            z-index: 100;
            padding: 20px 30px 15px 30px;
            margin-bottom: 0;
            border-bottom: 1px solid #e0e0e0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            flex-shrink: 0;
        }

        .help-modal .help-content {
            padding: 20px 30px;
            overflow-y: auto;
            flex-grow: 1;
        }

        .help-content a {
            color: #1e88e5;
            text-decoration: none;
            transition: color 0.2s;
        }

        .help-content a:hover {
            color: #1565c0;
            text-decoration: underline;
        }

        .help-toc ol {
            padding-left: 20px;
        }

        .help-toc a {
            font-weight: 500;
        }

        .help-content h2 {
            scroll-margin-top: 20px;
        }

        .help-content section {
            scroll-margin-top: 20px;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        #qrImage {
            max-width: 100%;
            max-height: 300px;
            margin: 10px auto;
            display: block;
            border: 1px solid #eee;
        }

        .qr-settings {
            display: grid;
            grid-template-columns: 35fr 15fr 25fr 25fr;
            gap: 15px;
            margin-top: 20px;
            margin-bottom: 20px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }

        .qr-settings-item {
            display: flex;
            flex-direction: column;
        }

        .qr-settings-item label {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 4px;
            color: #666;
        }

        .qr-settings-item select,
        .qr-settings-item input[type="number"] {
            padding: 6px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
            width: 100%;
        }

        .qr-settings-item .color-input-group {
            display: flex;
            align-items: center;
        }

        .qr-settings-item input[type="color"] {
            flex-shrink: 0;
        }

        .qr-settings-item input[type="text"].hex-input {
            flex-grow: 0;
            width: auto;
            max-width: 100px;
            min-width: 70px;
            margin-left: 5px;
            font-family: monospace;
        }

        .download-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 20px;
        }

        .download-buttons button {
            width: 100%;
            justify-content: center;
        }

        .settings-block {
            background: #fff3e0;
            padding: 15px 30px;
            border-bottom: 1px solid #e0e0e0;
            position: relative;
            z-index: 5;
        }

        .settings-block h3, .settings-block h4 {
            font-size: 14px;
            margin-bottom: 10px;
            color: #f57c00;
        }

        .quick-fill-block h3 {
            margin-top: 20px;
            border-top: 1px solid #fbe9e7;
            padding-top: 15px;
        }

        .quick-fill-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }

        .quick-fill-item {
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .quick-fill-item label {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 4px;
            color: #666;
        }

        .quick-fill-item input {
            padding: 6px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
        }

        .quick-fill-btn {
            grid-column: 1 / -1;
            margin-top: 10px;
        }

        .column-settings {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 10px;
            font-size: 14px;
        }

        .column-settings label {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
        }

        .data-management-settings {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #fbe9e7;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .data-management-settings h4 {
            width: 100%;
            margin-bottom: 5px;
        }

        .help-modal .modal-content {
            max-width: 700px;
        }

        .help-content {
            font-size: 14px;
            line-height: 1.6;
        }

        .help-content h3 {
            color: #1e88e5;
            margin-top: 20px;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .help-content h3:first-child {
            margin-top: 0;
        }

        .help-content ul {
            margin-left: 20px;
            margin-bottom: 15px;
        }

        .help-content li {
            margin-bottom: 8px;
        }

        .help-content strong {
            color: #333;
        }

        .help-content code {
            background: #f5f5f5;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }

        .auto-badge {
            display: inline-block;
            background: #4caf50;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 5px;
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .toolbar {
                flex-direction: column;
            }

            button {
                width: 100%;
            }

            .tooltip-text {
                width: 200px;
                margin-left: -100px;
            }

            .download-buttons {
                grid-template-columns: 1fr;
            }

            .data-management-settings button {
                width: 100%;
            }

            .qr-settings {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body class="">
    <div class="container">
        <div class="header">
            <h1>üöÄ UTM Bulk Generator <span class="version-badge">v1.0.0</span></h1>
            <p>Fast UTM link generator with automatic update <span class="auto-badge">AUTO</span></p>
        </div>

        <div class="alert" id="alertBox"></div>

        <div class="settings-block">
            <h4>‚öôÔ∏è Application Settings</h4>
            <div class="column-settings">
                <label>
                    <input type="checkbox" id="toggleUtmId" checked onchange="toggleUtmIdGeneration()">
                    Auto-generate utm_id
                </label>
                <label>
                    <input type="checkbox" id="togglePlatform" onchange="updateColumnVisibility()">
                    Show utm_source_platform
                </label>
                <label>
                    <input type="checkbox" id="toggleFormat" onchange="updateColumnVisibility()">
                    Show utm_creative_format
                </label>
                <label>
                    <input type="checkbox" id="toggleTactic" onchange="updateColumnVisibility()">
                    Show utm_marketing_tactic
                </label>
            </div>
            <div class="data-management-settings">
                <h4>üíæ Data Management</h4>
                <button class="btn-success btn-small" onclick="backupData()">Backup Data (JSON)</button>
                <button class="btn-warning btn-small" onclick="restoreData()">Restore Data (JSON)</button>
                <button class="btn-danger btn-small" onclick="clearAutocompleteHistory()">Clear Autocomplete History</button>
                <button class="btn-danger btn-small" onclick="resetApplicationState()" title="Deletes ALL data and resets the application to default state!">Reset Application</button>
                <button class="btn-secondary btn-small" onclick="openDevConsole()" title="Shows instructions for opening the console">üîß How to open console?</button>
            </div>
            <div class="quick-fill-block">
                <h3>‚ö° Quick Fill</h3>
                <div class="quick-fill-grid">
                    <div class="quick-fill-item autocomplete-wrapper">
                        <label>Base URL</label>
                        <input type="url" id="quickBaseUrl" placeholder="https://www.example.com">
                    </div>
                    <div class="quick-fill-item autocomplete-wrapper">
                        <label>utm_source</label>
                        <input type="text" id="quickSource" data-autocomplete="utm_source" placeholder="facebook" oninput="handleAutocomplete(this)">
                    </div>
                    <div class="quick-fill-item autocomplete-wrapper">
                        <label>utm_medium</label>
                        <input type="text" id="quickMedium" data-autocomplete="utm_medium" placeholder="social" oninput="handleAutocomplete(this)">
                    </div>
                    <div class="quick-fill-item autocomplete-wrapper">
                        <label>utm_campaign</label>
                        <input type="text" id="quickCampaign" data-autocomplete="utm_campaign" placeholder="summer_sale" oninput="handleAutocomplete(this)">
                    </div>
                    <div class="quick-fill-item autocomplete-wrapper">
                        <label>utm_term</label>
                        <input type="text" id="quickTerm" data-autocomplete="utm_term" placeholder="keyword" oninput="handleAutocomplete(this)">
                    </div>
                    <div class="quick-fill-item autocomplete-wrapper">
                        <label>utm_content</label>
                        <input type="text" id="quickContent" data-autocomplete="utm_content" placeholder="banner_01" oninput="handleAutocomplete(this)">
                    </div>
                    <div class="quick-fill-item col-platform autocomplete-wrapper">
                        <label>utm_source_platform</label>
                        <input type="text" id="quickPlatform" data-autocomplete="utm_source_platform" placeholder="facebook_ads" oninput="handleAutocomplete(this)">
                    </div>
                    <div class="quick-fill-item col-format autocomplete-wrapper">
                        <label>utm_creative_format</label>
                        <input type="text" id="quickFormat" data-autocomplete="utm_creative_format" placeholder="video" oninput="handleAutocomplete(this)">
                    </div>
                    <div class="quick-fill-item col-tactic autocomplete-wrapper">
                        <label>utm_marketing_tactic</label>
                        <input type="text" id="quickTactic" data-autocomplete="utm_marketing_tactic" placeholder="awareness" oninput="handleAutocomplete(this)">
                    </div>
                </div>
                <button class="btn-info quick-fill-btn" onclick="applyQuickFill()">‚ö° Apply to all empty rows</button>
            </div>
        </div>

        <div class="toolbar">
            <button class="btn-primary" onclick="addRow()">‚ûï Add Row</button>
            <button class="btn-primary" onclick="exportToCSV()">üíæ Export CSV</button>
            <button class="btn-primary" onclick="exportToExcel()">üìä Export Excel</button>
            <button class="btn-secondary" onclick="clearAll()" title="Clears all rows but keeps history and settings">üóëÔ∏è Clear Rows</button>
            <button class="btn-secondary" onclick="showHelp()">‚ùì Help</button>
        </div>

        <div class="table-container">
            <table id="utmTable">
                <thead>
                    <tr>
                        <th style="width: 20px;">#</th>
                        <th style="width: 250px;" class="required"> Base URL
                            <span class="tooltip-icon">?</span>
                            <span class="tooltip-text">
                                <strong>Base URL address</strong><br>
                                Full page address where you want to direct users. If you don't enter protocol (http:// or https://), https:// will be added automatically.
                                <span class="tooltip-example">Example: example.com ‚Üí https://example.com</span>
                                <span class="tooltip-example">https://www.example.com/products</span>
                                <span class="tooltip-example">www.example.com ‚Üí https://www.example.com</span>
                            </span>
                        </th>
                        <th style="width: 80px;" class="required"> utm_source
                            <span class="tooltip-icon">?</span>
                            <span class="tooltip-text">
                                <strong>Campaign source</strong><br>
                                Where the visitor comes from. Automatically converted to lowercase and spaces replaced with underscores.
                                <span class="tooltip-example">Example: facebook, google, newsletter</span>
                                <span class="tooltip-example">"Google Ads" ‚Üí google_ads</span>
                            </span>
                        </th>
                        <th style="width: 80px;" class="required"> utm_medium
                            <span class="tooltip-icon">?</span>
                            <span class="tooltip-text">
                                <strong>Campaign medium</strong><br>
                                Type of marketing channel. Automatically converted to lowercase and spaces replaced with underscores.
                                <span class="tooltip-example">Example: cpc, email, social, organic</span>
                                <span class="tooltip-example">"Social Media" ‚Üí social_media</span>
                            </span>
                        </th>
                        <th style="width: 80px;" class="required"> utm_campaign
                            <span class="tooltip-icon">?</span>
                            <span class="tooltip-text">
                                <strong>Campaign name</strong><br>
                                Specific name of your marketing campaign. Use consistent naming. Automatically converted to lowercase and spaces replaced with underscores.
                                <span class="tooltip-example">Example: summer_sale_2024, black_friday</span>
                                <span class="tooltip-example">"Summer Sale" ‚Üí summer_sale</span>
                            </span>
                        </th>
                        <th style="width: 100px;"> utm_term
                            <span class="tooltip-icon">?</span>
                            <span class="tooltip-text">
                                <strong>Keyword (optional)</strong><br>
                                Mainly used for paid advertising to identify keywords. Automatically converted to lowercase and spaces replaced with underscores.
                                <span class="tooltip-example">Example: running_shoes, best_laptop</span>
                                <span class="tooltip-example">"Running Shoes" ‚Üí running_shoes</span>
                            </span>
                        </th>
                        <th style="width: 80px;"> utm_content
                            <span class="tooltip-icon">?</span>
                            <span class="tooltip-text">
                                <strong>Content/variant (optional)</strong><br>
                                Differentiate similar links or ads within the same campaign. Automatically converted to lowercase and spaces replaced with underscores.
                                <span class="tooltip-example">Example: banner_01, text_link, button_blue</span>
                                <span class="tooltip-example">"Header CTA" ‚Üí header_cta</span>
                            </span>
                        </th>
                        <th style="width: 120px;"> utm_id
                            <span class="tooltip-icon">?</span>
                            <span class="tooltip-text">
                                <strong>Campaign ID (automatic/manual)</strong><br>
                                Unique campaign identifier. Can be auto-generated (format: YYYYMMDD_XXX) or entered manually if auto-generation is disabled in Settings.
                                <span class="tooltip-example">Example (auto): 20240323_001</span>
                                <span class="tooltip-example">Example (manual): my_campaign_2024</span>
                            </span>
                        </th>
                        <th style="width: 80px;" class="col-platform"> utm_source_platform
                            <span class="tooltip-icon">?</span>
                            <span class="tooltip-text">
                                <strong>Source platform (optional)</strong><br>
                                Specific advertising platform within the source. Automatically converted to lowercase and spaces replaced with underscores.
                                <span class="tooltip-example">Example: facebook_ads, google_ads</span>
                                <span class="tooltip-example">"LinkedIn Ads" ‚Üí linkedin_ads</span>
                                <br><strong style='color: #fb8c00;'>Requires custom setup in GA.</strong>
                            </span>
                        </th>
                        <th style="width: 80px;" class="col-format"> utm_creative_format
                            <span class="tooltip-icon">?</span>
                            <span class="tooltip-text">
                                <strong>Creative format (optional)</strong><br>
                                Type of ad format. Automatically converted to lowercase and spaces replaced with underscores.
                                <span class="tooltip-example">Example: video, banner, carousel, story</span>
                                <span class="tooltip-example">"Single Image" ‚Üí single_image</span>
                                <br><strong style='color: #fb8c00;'>Requires custom setup in GA.</strong>
                            </span>
                        </th>
                        <th style="width: 80px;" class="col-tactic"> utm_marketing_tactic
                            <span class="tooltip-icon">?</span>
                            <span class="tooltip-text">
                                <strong>Marketing tactic (optional)</strong><br>
                                Marketing funnel phase. Automatically converted to lowercase and spaces replaced with underscores.
                                <span class="tooltip-example">Example: awareness, consideration, conversion</span>
                                <span class="tooltip-example">"Brand Awareness" ‚Üí brand_awareness</span>
                                <br><strong style='color: #fb8c00;'>Requires custom setup in GA.</strong>
                            </span>
                        </th>
                        <th style="width: 100px;"> Final UTM URL <span class="auto-badge">AUTO</span>
                            <span class="tooltip-icon">?</span>
                            <span class="tooltip-text">
                                <strong>Final UTM link</strong><br>
                                Complete URL with added UTM parameters. Generated automatically when filling in fields. Use this link in your campaigns.
                            </span>
                        </th>
                        <th style="width: 60px;"> Status
                            <span class="tooltip-icon">?</span>
                            <span class="tooltip-text">
                                <strong>Generation status</strong><br>
                                üîÑ Auto = automatically generated<br>
                                ‚ùå Error = validation problem<br>
                                Waiting = waiting for required fields
                            </span>
                        </th>
                        <th style="width: 60px;"> QR Code
                            <span class="tooltip-icon">?</span>
                            <span class="tooltip-text">
                                <strong>QR code</strong><br>
                                Generate QR code for your UTM link. You can download it in various formats (PNG, JPEG, SVG, EPS). The window allows you to customize the appearance.
                            </span>
                        </th>
                        <th style="width: 60px; min-width: 80px;"> Actions
                            <span class="tooltip-icon">?</span>
                            <span class="tooltip-text">
                                <strong>Row actions</strong><br>
                                üìÑ = Copy to clipboard<br>
                                ‚ûï = Duplicate row<br>
                                üóëÔ∏è = Delete row
                            </span>
                        </th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                </tbody>
            </table>
        </div>

        <div class="stats">
            <div class="stat">
                <span class="stat-label">Total Rows</span>
                <span class="stat-value" id="totalRows">0</span>
            </div>
            <div class="stat">
                <span class="stat-label">Generated</span>
                <span class="stat-value" id="generatedRows">0</span>
            </div>
            <div class="stat">
                <span class="stat-label">Errors</span>
                <span class="stat-value" id="errorRows" style="color: #e53935;">0</span>
            </div>
        </div>
    </div>

    <!-- QR Modal -->
    <div id="qrModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>QR Code</h2>
                <span class="close" onclick="closeQRModal()">&times;</span>
            </div>
            <img id="qrImage" src="" alt="QR Code">
            <div class="qr-settings">
                <div class="qr-settings-item">
                    <label for="qrEccLevel">Error correction level:</label>
                    <select id="qrEccLevel" onchange="updateQRPreview()">
                        <option value="L">Low (L ~7%)</option>
                        <option value="M">Medium (M ~15%)</option>
                        <option value="Q">Quarter (Q ~25%)</option>
                        <option value="H" selected>High (H ~30%)</option>
                    </select>
                </div>
                <div class="qr-settings-item">
                    <label for="qrMargin">Margin (px):</label>
                    <input type="number" id="qrMargin" value="10" min="0" max="50" step="1" onchange="updateQRPreview()">
                </div>
                <div class="qr-settings-item">
                    <label for="qrColorHex">Code color:</label>
                    <div class="color-input-group">
                        <input type="color" id="qrColor" value="#000000" onchange="document.getElementById('qrColorHex').value = this.value; updateQRPreview()">
                        <input type="text" id="qrColorHex" class="hex-input" value="#000000" pattern="#?[0-9a-fA-F]{3,6}" maxlength="7" oninput="handleHexInput(this, 'qrColor')" onchange="updateQRPreview()" onblur="updateQRPreview()" onkeydown="handleHexEnter(event)">
                    </div>
                </div>
                <div class="qr-settings-item">
                    <label for="qrBgColorHex">Background color:</label>
                    <div class="color-input-group">
                        <input type="color" id="qrBgColor" value="#ffffff" onchange="document.getElementById('qrBgColorHex').value = this.value; updateQRPreview()">
                        <input type="text" id="qrBgColorHex" class="hex-input" value="#ffffff" pattern="#?[0-9a-fA-F]{3,6}" maxlength="7" oninput="handleHexInput(this, 'qrBgColor')" onchange="updateQRPreview()" onblur="updateQRPreview()" onkeydown="handleHexEnter(event)">
                    </div>
                </div>
            </div>
            <p id="qrUrl" style="word-break: break-all; font-size: 12px; color: #666; margin-top: 10px; text-align: center;"></p>
            <div class="download-buttons">
                <button class="btn-primary" onclick="downloadQR('png')">üíæ Download PNG</button>
                <button class="btn-primary" onclick="downloadQR('jpeg')">üíæ Download JPEG</button>
                <button class="btn-info" onclick="downloadQR('svg')">üíæ Download SVG</button>
                <button class="btn-info" onclick="downloadQR('eps')">üíæ Download EPS</button>
            </div>
        </div>
    </div>

    <!-- Help Modal -->
    <div id="helpModal" class="modal help-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìñ Help</h2>
                <span class="close" onclick="closeHelpModal()">&times;</span>
            </div>
            <div class="help-content">
                
                <!-- TABLE OF CONTENTS -->
                <nav id="help-toc" class="help-toc" style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 30px; border-left: 4px solid #1e88e5;">
                    <h3 style="margin-top: 0; color: #1e88e5;">üìë Table of Contents</h3>
                    <ol style="line-height: 2; margin: 10px 0;">
                        <li><a href="#help-version">Version and Changelog</a></li>
                        <li><a href="#help-how-to-use">How to Use UTM Bulk Generator</a></li>
                        <li><a href="#help-required-fields">Required Fields</a></li>
                        <li><a href="#help-auto-formatting">Automatic Text Formatting</a></li>
                        <li><a href="#help-utm-id">Auto-generating utm_id</a></li>
                        <li><a href="#help-advanced-params">Optional Advanced Parameters</a></li>
                        <li><a href="#help-quick-fill">Quick Fill</a></li>
                        <li><a href="#help-export">Export and Backup</a></li>
                        <li><a href="#help-storage">Data Storage</a></li>
                        <li><a href="#help-qr">QR Codes</a></li>
                        <li><a href="#help-autocomplete">Autocomplete</a></li>
                        <li><a href="#help-data-management">Data Management</a></li>
                        <li><a href="#help-compatibility">Compatibility and Limitations</a></li>
                        <li><a href="#help-debugging">Troubleshooting and Debugging</a></li>
                        <li><a href="#help-tips">Tips and Recommendations</a></li>
                    </ol>
                </nav>

                <!-- 1. VERSION AND CHANGELOG -->
                <section id="help-version">
                    <h2 style="color: #1e88e5; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; margin-top: 30px;">üìã Version and Changelog</h2>
                    <p><strong>Current version: <span style="color: #1e88e5;">1.0.0</span></strong> (January 31, 2025)</p>
                    <details style="margin-bottom: 20px; cursor: pointer;">
                        <summary style="font-weight: 600; padding: 10px; background: #f5f5f5; border-radius: 4px; user-select: none;">
                            üìú Show version history
                        </summary>
                        <div style="padding: 15px 10px; border-left: 3px solid #1e88e5; margin-top: 10px; background: #fafafa;">
                            <h4 style="margin-top: 0;">v1.0.0 (January 31, 2025) - Stable Release</h4>
                            <ul>
                                <li>‚úÖ Automatic UTM link generation with live preview</li>
                                <li>‚úÖ Parameter sanitization (lowercase, spaces‚Üíunderscores)</li>
                                <li>‚úÖ URL validation with automatic protocol addition</li>
                                <li>‚úÖ Proper handling of anchors (#) and query parameters</li>
                                <li>‚úÖ Export to CSV and Excel</li>
                                <li>‚úÖ QR code generation with settings</li>
                                <li>‚úÖ Data backup and restore (JSON)</li>
                                <li>‚úÖ Automatic/manual utm_id generation</li>
                                <li>‚úÖ Autocomplete with history</li>
                                <li>‚úÖ Advanced UTM parameters (platform, format, tactic)</li>
                                <li>‚úÖ Quick fill for empty rows</li>
                                <li>‚úÖ LocalStorage with problem warnings</li>
                                <li>‚úÖ Browser compatibility check</li>
                                <li>‚úÖ Offline indicator</li>
                                <li>‚úÖ Complete help and tooltips</li>
                            </ul>
                        </div>
                    </details>
                    <p style="text-align: right;"><a href="#help-toc" style="font-size: 12px; color: #1e88e5;">‚¨ÜÔ∏è Back to contents</a></p>
                </section>

                <!-- 2. HOW TO USE -->
                <section id="help-how-to-use">
                    <h2 style="color: #1e88e5; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; margin-top: 30px;">üéØ How to Use UTM Bulk Generator</h2>
                    <p>This tool helps you create tracked UTM links for your marketing campaigns. All data is stored locally in your browser.</p>
                    <p style="text-align: right;"><a href="#help-toc" style="font-size: 12px; color: #1e88e5;">‚¨ÜÔ∏è Back to contents</a></p>
                </section>

                <!-- 3. REQUIRED FIELDS -->
                <section id="help-required-fields">
                    <h2 style="color: #1e88e5; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; margin-top: 30px;">üìã Required Fields</h2>
                    <ul>
                        <li><strong>Base URL:</strong> Enter target address (e.g. <code>example.com</code> or <code>https://example.com/page</code>). Protocol https:// will be added automatically if not provided.</li>
                        <li><strong>utm_source:</strong> Traffic source (e.g. <code>facebook</code>, <code>google</code>, <code>newsletter</code>)</li>
                        <li><strong>utm_medium:</strong> Media type (e.g. <code>cpc</code>, <code>email</code>, <code>social</code>)</li>
                        <li><strong>utm_campaign:</strong> Campaign name (e.g. <code>summer_sale</code>, <code>black_friday</code>)</li>
                    </ul>
                    <p style="text-align: right;"><a href="#help-toc" style="font-size: 12px; color: #1e88e5;">‚¨ÜÔ∏è Back to contents</a></p>
                </section>

                <!-- 4. AUTO FORMATTING -->
                <section id="help-auto-formatting">
                    <h2 style="color: #1e88e5; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; margin-top: 30px;">‚úèÔ∏è Automatic Text Formatting</h2>
                    <p>All UTM parameters (except Base URL and utm_id) are automatically formatted:</p>
                    <ul>
                        <li>üî§ <strong>Convert to lowercase:</strong> "FaceBook" ‚Üí "facebook"</li>
                        <li>üîó <strong>Spaces ‚Üí underscores:</strong> "Summer Sale" ‚Üí "summer_sale"</li>
                        <li>üßπ <strong>Remove invalid characters:</strong> Only letters, numbers, hyphens (-) and underscores (_) are allowed</li>
                    </ul>
                    <div style="background: #fff3e0; border-left: 4px solid #ff9800; padding: 12px; margin: 15px 0; border-radius: 4px;">
                        <strong>üí° Note:</strong> Changes take effect after finishing typing (Tab or Enter).
                    </div>
                    <p style="text-align: right;"><a href="#help-toc" style="font-size: 12px; color: #1e88e5;">‚¨ÜÔ∏è Back to contents</a></p>
                </section>

                <!-- 5. AUTO UTM_ID -->
                <section id="help-utm-id">
                    <h2 style="color: #1e88e5; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; margin-top: 30px;">üî¢ Auto-generating utm_id</h2>
                    <p>In the ‚öôÔ∏è Settings section, you can enable/disable automatic <code>utm_id</code> generation:</p>
                    <ul>
                        <li><strong>‚úÖ Enabled (default):</strong> Generates ID in format <code>YYYYMMDD_XXX</code> (date + sequence number), e.g. <code>20240323_001</code></li>
                        <li><strong>‚úçÔ∏è Disabled:</strong> You can enter custom ID manually</li>
                    </ul>
                    <p style="text-align: right;"><a href="#help-toc" style="font-size: 12px; color: #1e88e5;">‚¨ÜÔ∏è Back to contents</a></p>
                </section>

                <!-- 6. ADVANCED PARAMS -->
                <section id="help-advanced-params">
                    <h2 style="color: #1e88e5; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; margin-top: 30px;">‚ûï Optional Advanced Parameters</h2>
                    <p>In the ‚öôÔ∏è Settings section, you can show additional columns:</p>
                    <ul>
                        <li><strong>utm_source_platform:</strong> Specific advertising platform (e.g. <code>facebook_ads</code>)</li>
                        <li><strong>utm_creative_format:</strong> Ad format (e.g. <code>video</code>, <code>banner</code>)</li>
                        <li><strong>utm_marketing_tactic:</strong> Campaign phase (e.g. <code>awareness</code>, <code>conversion</code>)</li>
                    </ul>
                    <div style="background: #fff3e0; border-left: 4px solid #fb8c00; padding: 12px; margin: 15px 0; border-radius: 4px;">
                        <strong>‚ö†Ô∏è Important:</strong> These parameters require custom setup in Google Analytics 4!
                    </div>
                    <p style="text-align: right;"><a href="#help-toc" style="font-size: 12px; color: #1e88e5;">‚¨ÜÔ∏è Back to contents</a></p>
                </section>

                <!-- 7. QUICK FILL -->
                <section id="help-quick-fill">
                    <h2 style="color: #1e88e5; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; margin-top: 30px;">‚ö° Quick Fill</h2>
                    <p>Want to fill all empty rows with the same values? Use the <strong>‚ö° Quick Fill</strong> section above the table.</p>
                    <p style="text-align: right;"><a href="#help-toc" style="font-size: 12px; color: #1e88e5;">‚¨ÜÔ∏è Back to contents</a></p>
                </section>

                <!-- 8. EXPORT AND BACKUP -->
                <section id="help-export">
                    <h2 style="color: #1e88e5; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; margin-top: 30px;">üì§ Export and Backup</h2>
                    <ul>
                        <li><strong>üíæ Export CSV:</strong> Download your UTM links to CSV file <span style="color: #4caf50;">(works offline ‚úÖ)</span></li>
                        <li><strong>üìä Export Excel:</strong> Download to XLSX format <span style="color: #ff9800;">(‚ö†Ô∏è requires internet)</span></li>
                        <li><strong>üíº Backup Data (JSON):</strong> Save complete backup including history <span style="color: #4caf50;">(works offline ‚úÖ)</span></li>
                        <li><strong>üì• Restore Data (JSON):</strong> Load previously saved backup <span style="color: #4caf50;">(works offline ‚úÖ)</span></li>
                    </ul>
                    <div style="background: #e3f2fd; border-left: 4px solid #1e88e5; padding: 12px; margin: 15px 0; border-radius: 4px;">
                        <strong>üí° Tip:</strong> If working without connection, use CSV export or JSON backup instead of Excel.
                    </div>
                    <p style="text-align: right;"><a href="#help-toc" style="font-size: 12px; color: #1e88e5;">‚¨ÜÔ∏è Back to contents</a></p>
                </section>

                <!-- 9. STORAGE -->
                <section id="help-storage">
                    <h2 style="color: #1e88e5; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; margin-top: 30px;">üóÇÔ∏è Data Storage</h2>
                    <p>All data is automatically saved to your browser's <strong>localStorage</strong>:</p>
                    <ul>
                        <li>‚úÖ Data persists after closing browser</li>
                        <li>‚úÖ Works offline</li>
                        <li>‚ö†Ô∏è Data is stored only in this browser</li>
                        <li>üí° We recommend regular backups (JSON)</li>
                    </ul>
                    <p style="text-align: right;"><a href="#help-toc" style="font-size: 12px; color: #1e88e5;">‚¨ÜÔ∏è Back to contents</a></p>
                </section>

                <!-- 10. QR CODES -->
                <section id="help-qr">
                    <h2 style="color: #1e88e5; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; margin-top: 30px;">üì± QR Codes</h2>
                    <p>For each generated UTM link, you can create a QR code with custom color settings, margin size, and error correction level. QR code can be downloaded in various formats (PNG, JPEG, SVG, EPS).</p>
                    <div style="background: #fff3e0; border-left: 4px solid #ff9800; padding: 12px; margin: 15px 0; border-radius: 4px;">
                        <strong>‚ö†Ô∏è Important:</strong> QR code generation requires internet connection (uses external API).
                    </div>
                    <p style="text-align: right;"><a href="#help-toc" style="font-size: 12px; color: #1e88e5;">‚¨ÜÔ∏è Back to contents</a></p>
                </section>

                <!-- 11. AUTOCOMPLETE -->
                <section id="help-autocomplete">
                    <h2 style="color: #1e88e5; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; margin-top: 30px;">üîç Autocomplete</h2>
                    <p>When typing in fields, history of previously used values is shown. History is saved automatically and can be cleared in ‚öôÔ∏è Settings ‚Üí üíæ Data Management.</p>
                    <p style="text-align: right;"><a href="#help-toc" style="font-size: 12px; color: #1e88e5;">‚¨ÜÔ∏è Back to contents</a></p>
                </section>

                <!-- 12. DATA MANAGEMENT -->
                <section id="help-data-management">
                    <h2 style="color: #1e88e5; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; margin-top: 30px;">üõ†Ô∏è Data Management</h2>
                    <ul>
                        <li><strong>üóëÔ∏è Clear Rows:</strong> Deletes all rows (keeps history and settings)</li>
                        <li><strong>üßπ Clear Autocomplete History:</strong> Deletes only autocomplete history</li>
                        <li><strong>üîÑ Reset Application:</strong> Returns application to completely clean state <span style="color: #e53935;">(‚ö†Ô∏è deletes EVERYTHING!)</span></li>
                    </ul>
                    <p style="text-align: right;"><a href="#help-toc" style="font-size: 12px; color: #1e88e5;">‚¨ÜÔ∏è Back to contents</a></p>
                </section>

                <!-- 13. COMPATIBILITY -->
                <section id="help-compatibility">
                    <h2 style="color: #1e88e5; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; margin-top: 30px;">‚ö†Ô∏è Compatibility and Limitations</h2>
                    
                    <h3 style="color: #424242; margin-top: 20px;">üì± Supported Browsers</h3>
                    <ul>
                        <li><strong>Recommended:</strong> Chrome 90+, Firefox 88+, Edge 90+, Safari 14+</li>
                        <li><strong>Minimum:</strong> Chrome 49+, Firefox 45+, Edge 14+, Safari 10+</li>
                        <li>‚ùå <strong>Not supported:</strong> Internet Explorer (any version)</li>
                    </ul>

                    <h3 style="color: #424242; margin-top: 20px;">üåê Features Requiring Internet</h3>
                    <ul>
                        <li><strong>üìä Excel Export:</strong> Requires loading external SheetJS library from CDN</li>
                        <li><strong>üì± QR Codes:</strong> Uses online API for generation (api.qrserver.com)</li>
                    </ul>

                    <h3 style="color: #424242; margin-top: 20px;">üîí What Happens with Problems</h3>
                    <ul>
                        <li><strong>Old browser:</strong> Red warning at top with problem description</li>
                        <li><strong>Connection loss:</strong> Orange warning and notice about limited features</li>
                        <li><strong>Full localStorage:</strong> Warning and recommendation to create backup</li>
                        <li><strong>Unsupported localStorage:</strong> Data won't be saved between sessions</li>
                    </ul>

                    <h3 style="color: #424242; margin-top: 20px;">üõ°Ô∏è What Always Works (even offline)</h3>
                    <ul>
                        <li>‚úÖ UTM link generation</li>
                        <li>‚úÖ URL validation and cleaning</li>
                        <li>‚úÖ UTM parameter sanitization</li>
                        <li>‚úÖ CSV export</li>
                        <li>‚úÖ Saving to localStorage (if supported)</li>
                        <li>‚úÖ JSON backup and restore</li>
                        <li>‚úÖ Autocomplete and history</li>
                    </ul>
                    <p style="text-align: right;"><a href="#help-toc" style="font-size: 12px; color: #1e88e5;">‚¨ÜÔ∏è Back to contents</a></p>
                </section>

                <!-- 14. DEBUGGING -->
                <section id="help-debugging">
                    <h2 style="color: #1e88e5; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; margin-top: 30px;">üîß Troubleshooting and Debugging</h2>
                    
                    <h3 style="color: #424242; margin-top: 20px;">üìä Developer Console</h3>
                    <p>All technical information, verification and error messages are logged to the <strong>browser console</strong>. This is useful for problem diagnostics.</p>

                    <h3 style="color: #424242; margin-top: 20px;">üñ•Ô∏è How to Open Console</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 15px 0;">
                        <div style="background: #f5f5f5; padding: 15px; border-radius: 4px;">
                            <strong>ü™ü Windows/Linux:</strong>
                            <ul style="margin: 10px 0 0 0; padding-left: 20px;">
                                <li><code>F12</code></li>
                                <li><code>Ctrl + Shift + I</code></li>
                                <li><code>Ctrl + Shift + J</code></li>
                                <li>Right-click ‚Üí Inspect ‚Üí Console</li>
                            </ul>
                        </div>
                        <div style="background: #f5f5f5; padding: 15px; border-radius: 4px;">
                            <strong>üçé macOS:</strong>
                            <ul style="margin: 10px 0 0 0; padding-left: 20px;">
                                <li><code>Cmd + Option + I</code></li>
                                <li><code>Cmd + Option + J</code></li>
                                <li>Right-click ‚Üí Inspect Element ‚Üí Console</li>
                            </ul>
                        </div>
                    </div>

                    <h3 style="color: #424242; margin-top: 20px;">üîç What You'll Find in Console</h3>
                    <ul>
                        <li>‚úÖ <strong>Version info:</strong> <code>üöÄ UTM Bulk Generator v1.0.0</code></li>
                        <li>‚úÖ <strong>Compatibility check:</strong> "Browser compatibility check passed!"</li>
                        <li>‚úÖ <strong>Backup info:</strong> "Restoring backup from version..."</li>
                        <li>‚ö†Ô∏è <strong>Warnings:</strong> localStorage problems, different backup versions, etc.</li>
                        <li>‚ùå <strong>Errors:</strong> Detailed information about URL parsing, validation problems, etc.</li>
                        <li>üìù <strong>Debug logs:</strong> Technical information about application running</li>
                    </ul>

                    <h3 style="color: #424242; margin-top: 20px;">üõ†Ô∏è Common Problems and Solutions</h3>
                    
                    <details style="margin: 10px 0; cursor: pointer;">
                        <summary style="font-weight: 600; padding: 10px; background: #f5f5f5; border-radius: 4px; user-select: none;">
                            ‚ùå Data not saving or backup not loading
                        </summary>
                        <div style="padding: 15px; border-left: 3px solid #e53935; margin-top: 5px; background: #ffebee;">
                            <p><strong>Possible causes:</strong></p>
                            <ul>
                                <li>LocalStorage is full or blocked</li>
                                <li>Using private mode (Incognito)</li>
                                <li>Browser blocks localStorage for local files</li>
                            </ul>
                            <p><strong>Solutions:</strong></p>
                            <ul>
                                <li>Open console (F12) and look for red errors</li>
                                <li>Check if orange warning is displayed at top</li>
                                <li>Clear browser data or use different browser</li>
                                <li>Use JSON backups for data transfer</li>
                            </ul>
                        </div>
                    </details>

                    <details style="margin: 10px 0; cursor: pointer;">
                        <summary style="font-weight: 600; padding: 10px; background: #f5f5f5; border-radius: 4px; user-select: none;">
                            ‚ùå URL not generating or validation error
                        </summary>
                        <div style="padding: 15px; border-left: 3px solid #ff9800; margin-top: 5px; background: #fff3e0;">
                            <p><strong>Possible causes:</strong></p>
                            <ul>
                                <li>Invalid URL format (missing domain or TLD)</li>
                                <li>Disallowed protocol (ftp://, javascript:, etc.)</li>
                                <li>Special characters in URL</li>
                            </ul>
                            <p><strong>Solutions:</strong></p>
                            <ul>
                                <li>Open console and check URL-related warnings</li>
                                <li>Make sure URL contains domain with TLD (e.g. <code>example.com</code>)</li>
                                <li>Protocol https:// will be added automatically if missing</li>
                                <li>Console will show: "Could not parse URL for cleaning: ..."</li>
                            </ul>
                        </div>
                    </details>

                    <details style="margin: 10px 0; cursor: pointer;">
                        <summary style="font-weight: 600; padding: 10px; background: #f5f5f5; border-radius: 4px; user-select: none;">
                            ‚ùå QR code or Excel export not working
                        </summary>
                        <div style="padding: 15px; border-left: 3px solid #1e88e5; margin-top: 5px; background: #e3f2fd;">
                            <p><strong>Possible causes:</strong></p>
                            <ul>
                                <li>You're offline (no internet connection)</li>
                                <li>External API or library didn't load</li>
                                <li>Third-party blocking (AdBlock, firewall)</li>
                            </ul>
                            <p><strong>Solutions:</strong></p>
                            <ul>
                                <li>Check internet connection</li>
                                <li>Look in console for red errors (e.g. "Failed to load resource")</li>
                                <li>Temporarily disable AdBlock or other extensions</li>
                                <li>Use CSV export (works offline) instead of Excel</li>
                            </ul>
                        </div>
                    </details>

                    <details style="margin: 10px 0; cursor: pointer;">
                        <summary style="font-weight: 600; padding: 10px; background: #f5f5f5; border-radius: 4px; user-select: none;">
                            ‚ùå Application is slow or unresponsive
                        </summary>
                        <div style="padding: 15px; border-left: 3px solid #9c27b0; margin-top: 5px; background: #f3e5f5;">
                            <p><strong>Possible causes:</strong></p>
                            <ul>
                                <li>Too many rows (hundreds)</li>
                                <li>Large autocomplete history</li>
                                <li>Full localStorage</li>
                            </ul>
                            <p><strong>Solutions:</strong></p>
                            <ul>
                                <li>Export data and delete old rows</li>
                                <li>Clear autocomplete history (‚öôÔ∏è Settings ‚Üí Clear history)</li>
                                <li>Create backup and reset application</li>
                                <li>In console you can check data size: <code>localStorage</code></li>
                            </ul>
                        </div>
                    </details>

                    <h3 style="color: #424242; margin-top: 20px;">üí° Debugging Tips</h3>
                    <ul>
                        <li>üî¥ <strong>Red messages</strong> = critical errors that stop functionality</li>
                        <li>üü° <strong>Yellow messages</strong> = warnings, app works but something isn't ideal</li>
                        <li>‚ö™ <strong>Regular messages</strong> = progress information (loading, saving, etc.)</li>
                        <li>When reporting problems, <strong>always attach console screenshot</strong></li>
                        <li>Text from console can be copied (right-click ‚Üí Copy message)</li>
                    </ul>
                    <p style="text-align: right;"><a href="#help-toc" style="font-size: 12px; color: #1e88e5;">‚¨ÜÔ∏è Back to contents</a></p>
                </section>

                <!-- 15. TIPS -->
                <section id="help-tips">
                    <h2 style="color: #1e88e5; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; margin-top: 30px;">üí° Tips and Recommendations</h2>
                    <ul>
                        <li>‚úÖ Use <strong>consistent naming</strong> across campaigns</li>
                        <li>‚úÖ Write values in <strong>lowercase</strong> without diacritics</li>
                        <li>‚úÖ Use <strong>underscores</strong> instead of spaces (happens automatically)</li>
                        <li>‚úÖ For long-term campaigns use <strong>utm_id</strong> for better tracking</li>
                        <li>‚úÖ Regularly <strong>backup your data</strong> to JSON file</li>
                    </ul>
                    <p style="text-align: right;"><a href="#help-toc" style="font-size: 12px; color: #1e88e5;">‚¨ÜÔ∏è Back to contents</a></p>
                </section>

            </div>
        </div>
    </div>
    
    <input type="file" id="restoreFile" accept=".json" style="display: none;">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script>
        // === APPLICATION VERSION ===
        const APP_VERSION = '1.0.0';
        const APP_BUILD_DATE = '2025-01-31';
        const STORAGE_VERSION = '1'; // For future data migrations

        // Log version to console
        console.log(`%cüöÄ UTM Bulk Generator v${APP_VERSION}`, 'color: #1e88e5; font-size: 16px; font-weight: bold;');
        console.log(`üìÖ Build: ${APP_BUILD_DATE}`);
        console.log(`üíæ Storage version: ${STORAGE_VERSION}`);
        // === END VERSION INFO ===

        // === BROWSER COMPATIBILITY CHECK ===
        (function checkBrowserCompatibility() {
            const incompatibilities = [];
            
            // 1. LocalStorage
            if (typeof(Storage) === "undefined") {
                incompatibilities.push("LocalStorage not supported");
            }
            
            // 2. FileReader API (for backup/restore)
            if (typeof(FileReader) === "undefined") {
                incompatibilities.push("FileReader API not supported (backup restore won't work)");
            }
            
            // 3. URL API (for validation)
            try {
                new URL("https://example.com");
            } catch(e) {
                incompatibilities.push("URL API not supported (URL validation won't work)");
            }
            
            // 4. Set object (for autocomplete)
            if (typeof(Set) === "undefined") {
                incompatibilities.push("Set object not supported (autocomplete won't work)");
            }
            
            // 5. ES6 features
            try {
                eval("const test = () => {};");
                eval("const {test} = {test: 1};");
                eval("`template string`");
            } catch(e) {
                incompatibilities.push("Modern JavaScript (ES6) not supported");
            }
            
            // 6. Fetch API (for future extensions)
            if (typeof(fetch) === "undefined") {
                incompatibilities.push("Fetch API not supported (limited functionality)");
            }
            
            // If there are problems, show warning
            if (incompatibilities.length > 0) {
                const warningDiv = document.createElement('div');
                warningDiv.id = 'browserCompatWarning';
                warningDiv.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    background: #d32f2f;
                    color: white;
                    padding: 15px 20px;
                    text-align: center;
                    font-weight: 600;
                    z-index: 999999;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                `;
                
                warningDiv.innerHTML = `
                    <div style="max-width: 1200px; margin: 0 auto;">
                        <strong>‚ö†Ô∏è Your browser is not fully compatible with this application!</strong><br>
                        <span style="font-size: 13px; opacity: 0.95;">
                            Issues: ${incompatibilities.join(', ')}
                        </span><br>
                        <span style="font-size: 12px; margin-top: 5px; display: inline-block;">
                            We recommend: Chrome 90+, Firefox 88+, Edge 90+, Safari 14+
                        </span>
                    </div>
                `;
                
                // Add warning as soon as DOM is ready
                if (document.body) {
                    document.body.insertBefore(warningDiv, document.body.firstChild);
                } else {
                    document.addEventListener('DOMContentLoaded', function() {
                        document.body.insertBefore(warningDiv, document.body.firstChild);
                    });
                }
                
                console.error("Browser compatibility issues detected:", incompatibilities);
                
                // Log browser info
                console.log("User Agent:", navigator.userAgent);
            } else {
                console.log("‚úÖ Browser compatibility check passed!");
            }
        })();
        // === END BROWSER COMPATIBILITY CHECK ===

        // === OFFLINE/ONLINE INDICATOR ===
        (function setupNetworkMonitoring() {
            let isOnline = navigator.onLine;
            
            function showNetworkStatus(online) {
                // Remove old warning (if exists)
                const oldWarning = document.getElementById('networkWarning');
                if (oldWarning) oldWarning.remove();
                
                // If offline, show warning
                if (!online) {
                    const warningDiv = document.createElement('div');
                    warningDiv.id = 'networkWarning';
                    warningDiv.style.cssText = `
                        position: fixed;
                        top: 0;
                        left: 0;
                        right: 0;
                        background: #ff9800;
                        color: white;
                        padding: 10px 20px;
                        text-align: center;
                        font-weight: 600;
                        z-index: 99998;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
                        font-size: 14px;
                    `;
                    
                    warningDiv.innerHTML = `
                        <div style="max-width: 1200px; margin: 0 auto;">
                            üì° <strong>You're offline</strong> ‚Äì Excel export and QR codes won't work. Other features work normally.
                        </div>
                    `;
                    
                    // Add below browser compatibility warning (if exists)
                    const compatWarning = document.getElementById('browserCompatWarning');
                    if (compatWarning && document.body.contains(compatWarning)) {
                        compatWarning.parentNode.insertBefore(warningDiv, compatWarning.nextSibling);
                    } else if (document.body) {
                        document.body.insertBefore(warningDiv, document.body.firstChild);
                    }
                }
            }
            
            // Check on load
            if (document.body) {
                showNetworkStatus(isOnline);
            } else {
                document.addEventListener('DOMContentLoaded', function() {
                    showNetworkStatus(isOnline);
                });
            }
            
            // Listen for network state changes
            window.addEventListener('online', function() {
                isOnline = true;
                showNetworkStatus(true);
                showAlert('‚úÖ Connection restored! Excel export and QR codes are available again.', 'success');
            });
            
            window.addEventListener('offline', function() {
                isOnline = false;
                showNetworkStatus(false);
                showAlert('üì° Connection lost. Excel export and QR codes won\'t work.', 'info');
            });
        })();
        // === END OFFLINE/ONLINE INDICATOR ===

        // --- Global Variables ---
        let rows = []; // Array of objects representing table rows
        let rowCounter = 0; // Global counter for unique row IDs
        // Object holding autocomplete history (as Set for uniqueness)
        let autocompleteData = {
            utm_source: new Set(),
            utm_medium: new Set(),
            utm_campaign: new Set(),
            utm_term: new Set(),
            utm_content: new Set(),
            utm_source_platform: new Set(),
            utm_creative_format: new Set(),
            utm_marketing_tactic: new Set()
        };
        let currentAutocompleteInput = null; // Reference to input with active autocomplete
        let currentQRUrlForDownload = ''; // Base URL for QR generation (without QR parameters)
        
        // Open developer console
        function openDevConsole() {
            alert('üí° To open Developer Console:\n\n' +
                'ü™ü Windows/Linux: F12 or Ctrl+Shift+I\n' +
                'üçé macOS: Cmd+Option+I\n\n' +
                'Then go to the "Console" tab.\n\n' +
                'In the console you\'ll find all technical information, warnings and error messages.');
        }

        // localStorage keys (constants for clarity)
        const STORAGE_KEYS = {
            rows: 'utmgenUtmRows',
            counter: 'utmgenUtmRowCounter',
            autocomplete: 'utmgenUtmAutocomplete',
            toggleId: 'utmgenToggleUtmId',
            togglePlatform: 'utmgenTogglePlatform',
            toggleFormat: 'utmgenToggleFormat',
            toggleTactic: 'utmgenToggleTactic'
        };

        // --- Initialization after DOM load ---
        document.addEventListener('DOMContentLoaded', function() {
            loadFromLocalStorage(); // Load saved data
            if (rows.length === 0) { // If nothing was saved, add default rows
                addRow();
                addRow();
                addRow();
            }
            updateStats(); // Update statistics
            // Attach listener for file input (restore from backup)
            document.getElementById('restoreFile').addEventListener('change', handleRestoreFileSelect);
            document.body.dataset.loaded = "true"; // Mark that loading finished
            toggleUtmIdInputsUI(document.getElementById('toggleUtmId').checked); // Set UI for utm_id
            
            // Add listeners for Enter in hex inputs of QR modal
            document.getElementById('qrColorHex').addEventListener('keydown', handleHexEnter);
            document.getElementById('qrBgColorHex').addEventListener('keydown', handleHexEnter);
        });

        // --- UI and Settings Management ---

        // Visually toggles editability of all utm_id fields in table
        function toggleUtmIdInputsUI(isAuto) {
            const utmIdInputs = document.querySelectorAll('input[data-field="utmId"]');
            utmIdInputs.forEach(input => {
                input.readOnly = isAuto;
                input.placeholder = isAuto ? "Auto" : "Enter ID";
                if (isAuto) {
                    input.style.backgroundColor = "#f5f5f5";
                    input.style.cursor = "not-allowed";
                } else {
                    input.style.backgroundColor = "white";
                    input.style.cursor = "text";
                    input.placeholder = "Enter ID";
                }
            });
        }
        
        // Function called when "Auto-generate utm_id" checkbox changes
        function toggleUtmIdGeneration() {
            const isAuto = document.getElementById('toggleUtmId').checked;
            toggleUtmIdInputsUI(isAuto);
            
            if (!isAuto) {
                // Simply clear ALL utm_id fields
                rows.forEach(row => {
                    row.utmId = ''; // Clear data
                    const tr = document.getElementById(`row-${row.id}`);
                    if (tr) {
                        const input = tr.querySelector('input[data-field="utmId"]');
                        if (input) {
                            input.value = ''; // Clear UI
                        }
                    }
                });
                regenerateAllUrls(); // Regenerate URLs without utm_id
            } else {
                regenerateAll(); // Regenerate everything including new utm_id
            }
            
            saveToLocalStorage();
        }
        
        // Updates visibility of advanced columns based on checkboxes
        function updateColumnVisibility() {
            document.body.classList.toggle('show-platform', document.getElementById('togglePlatform').checked);
            document.body.classList.toggle('show-format', document.getElementById('toggleFormat').checked);
            document.body.classList.toggle('show-tactic', document.getElementById('toggleTactic').checked);
            
            // Regenerate URLs and save settings, only if page was already loaded
            if (document.body.dataset.loaded === "true") {
                regenerateAll(); // regenerateAll calls saveToLocalStorage
            }
        }

        // --- Table Row Manipulation ---

        // Adds new row to table and to `rows` array
        function addRow(prefillData = null) {
            rowCounter++; // Increment global counter for unique ID
            const tbody = document.getElementById('tableBody');
            const tr = document.createElement('tr');
            tr.id = `row-${rowCounter}`;
            tr.dataset.rowId = rowCounter;
            tr.dataset.displayNumber = getNextDisplayNumber(); // Get current sequence number
            const isUtmIdAuto = document.getElementById('toggleUtmId').checked;

            // Create HTML for new row
            tr.innerHTML = `
                <td class="row-number">${tr.dataset.displayNumber}</td>
                <td><input type="url" data-field="baseUrl" placeholder="https://www.example.com" oninput="autoGenerateUTM(${rowCounter})" onchange="updateRow(${rowCounter})"></td>
                <td class="autocomplete-wrapper"><input type="text" data-field="utmSource" data-autocomplete="utm_source" placeholder="facebook" oninput="handleAutocomplete(this, ${rowCounter}); autoGenerateUTM(${rowCounter})" onchange="updateRow(${rowCounter})"></td>
                <td class="autocomplete-wrapper"><input type="text" data-field="utmMedium" data-autocomplete="utm_medium" placeholder="social" oninput="handleAutocomplete(this, ${rowCounter}); autoGenerateUTM(${rowCounter})" onchange="updateRow(${rowCounter})"></td>
                <td class="autocomplete-wrapper"><input type="text" data-field="utmCampaign" data-autocomplete="utm_campaign" placeholder="summer_sale" oninput="handleAutocomplete(this, ${rowCounter}); autoGenerateUTM(${rowCounter})" onchange="updateRow(${rowCounter})"></td>
                <td class="autocomplete-wrapper"><input type="text" data-field="utmTerm" data-autocomplete="utm_term" placeholder="keywords" oninput="handleAutocomplete(this, ${rowCounter}); autoGenerateUTM(${rowCounter})" onchange="updateRow(${rowCounter})"></td>
                <td class="autocomplete-wrapper"><input type="text" data-field="utmContent" data-autocomplete="utm_content" placeholder="banner_01" oninput="handleAutocomplete(this, ${rowCounter}); autoGenerateUTM(${rowCounter})" onchange="updateRow(${rowCounter})"></td>
                <td><input type="text" data-field="utmId" placeholder="${isUtmIdAuto ? 'Auto' : 'Enter ID'}" ${isUtmIdAuto ? 'readonly style="background: #f5f5f5; cursor: not-allowed;"' : 'style="background: white; cursor: text;"'} oninput="autoGenerateUTM(${rowCounter})" onchange="updateRow(${rowCounter})"></td>
                <td class="autocomplete-wrapper col-platform"><input type="text" data-field="utmSourcePlatform" data-autocomplete="utm_source_platform" placeholder="facebook_ads" oninput="handleAutocomplete(this, ${rowCounter}); autoGenerateUTM(${rowCounter})" onchange="updateRow(${rowCounter})"></td>
                <td class="autocomplete-wrapper col-format"><input type="text" data-field="utmCreativeFormat" data-autocomplete="utm_creative_format" placeholder="video" oninput="handleAutocomplete(this, ${rowCounter}); autoGenerateUTM(${rowCounter})" onchange="updateRow(${rowCounter})"></td>
                <td class="autocomplete-wrapper col-tactic"><input type="text" data-field="utmMarketingTactic" data-autocomplete="utm_marketing_tactic" placeholder="awareness" oninput="handleAutocomplete(this, ${rowCounter}); autoGenerateUTM(${rowCounter})" onchange="updateRow(${rowCounter})"></td>
                <td class="output-cell" data-field="finalUrl">-</td>
                <td class="status-pending" data-field="status">Waiting for data</td>
                <td><span data-field="qr">-</span></td>
                <td>
                    <div class="action-btns">
                        <button class="icon-btn copy" onclick="copyToClipboard(${rowCounter})" title="Copy Final URL">üìÑ</button>
                        <button class="icon-btn duplicate" onclick="duplicateRow(${rowCounter})" title="Duplicate row">‚ûï</button>
                        <button class="icon-btn delete" onclick="deleteRow(${rowCounter})" title="Delete row">üóëÔ∏è</button>
                    </div>
                </td>
            `;

            tbody.appendChild(tr); // Add row to DOM
            
            // Create object for row data
            const newRow = {
                id: rowCounter,
                baseUrl: '', utmSource: '', utmMedium: '', utmCampaign: '', utmTerm: '',
                utmContent: '', utmId: '', utmSourcePlatform: '', utmCreativeFormat: '',
                utmMarketingTactic: '', finalUrl: '', status: 'pending', qrUrl: ''
            };

            // If we have prefill data (e.g. from duplication or restore)
            if (prefillData) {
                Object.keys(prefillData).forEach(key => {
                    if (newRow.hasOwnProperty(key) && key !== 'id') {
                        newRow[key] = prefillData[key];
                    }
                });
                
                // Fill inputs with values from prefillData
                Object.keys(newRow).forEach(key => {
                    if (key !== 'id') {
                        const input = tr.querySelector(`input[data-field="${key}"]`);
                        if (key === 'utmId') {
                            // Set value only if auto-generation is OFF
                            if (!isUtmIdAuto && input) {
                                input.value = newRow[key] || '';
                            }
                        } else if (input && !input.readOnly) {
                            input.value = newRow[key] || '';
                        }
                    }
                });
                // Trigger URL generation after short pause
                setTimeout(() => autoGenerateUTM(rowCounter), 50);
            }

            // Add row data to global array (if not already there - safeguard for restore)
            if (!rows.some(r => r.id === newRow.id)) {
                rows.push(newRow);
            }
            
            updateStats(); // Update statistics
            saveToLocalStorage(); // Save changes
            
            return rowCounter; // Return ID of new row
        }

        // Returns next sequence number for row in table
        function getNextDisplayNumber() {
            const tbody = document.getElementById('tableBody');
            const existingRows = tbody.querySelectorAll('tr');
            return existingRows.length + 1;
        }

        // Renumbers all rows in table and updates `rowCounter`
        function renumberAllRows() {
            const tbody = document.getElementById('tableBody');
            const existingRows = tbody.querySelectorAll('tr');
            let maxId = 0;
            const shouldGenerateUtmId = document.getElementById('toggleUtmId').checked;

            existingRows.forEach((tr, index) => {
                const displayNumber = index + 1;
                tr.dataset.displayNumber = displayNumber; // Store number in attribute
                const numberCell = tr.querySelector('.row-number');
                if (numberCell) {
                    numberCell.textContent = displayNumber; // Display number in cell
                }
                
                const rowId = parseInt(tr.dataset.rowId);
                maxId = Math.max(maxId, rowId);
                
                // Find corresponding row in data
                const row = rows.find(r => r.id === rowId);
                
                // If auto utm_id is enabled, regenerate based on new position
                if (shouldGenerateUtmId && row) {
                    const newUtmId = generateUtmId(displayNumber);
                    row.utmId = newUtmId;
                    
                    const utmIdInput = tr.querySelector('input[data-field="utmId"]');
                    if (utmIdInput && utmIdInput.readOnly) {
                        utmIdInput.value = newUtmId;
                    }
                }
            });

            rowCounter = maxId; // Update global counter
        }

        // Duplicates row
        function duplicateRow(rowId) {
            const row = rows.find(r => r.id === rowId);
            if (!row) return;
            const newRowData = { ...row };
            delete newRowData.id;
            delete newRowData.finalUrl;
            delete newRowData.status;
            delete newRowData.qrUrl;
            // Don't copy utmId if auto-generation is OFF
            if (!document.getElementById('toggleUtmId').checked) {
                delete newRowData.utmId;
            }
            // newRowData.baseUrl = ''; // Don't copy Base URL (commented out - optional)
            const newRowId = addRow(newRowData); // Add new row with data
            
            // Highlight and focus on new row
            const newTr = document.getElementById(`row-${newRowId}`);
            if (newTr) {
                newTr.scrollIntoView({ behavior: 'smooth', block: 'center' });
                newTr.style.background = '#e3f2fd';
                setTimeout(() => { newTr.style.background = ''; }, 1000);
                const baseUrlInput = newTr.querySelector('input[data-field="baseUrl"]');
                if (baseUrlInput) { baseUrlInput.focus(); }
            }
            showAlert('Row duplicated', 'success');
        }

        // Deletes row from table and from `rows` array
        function deleteRow(rowId) {
            if (!confirm('Do you really want to delete this row?')) return;
            
            // Remove from DOM
            const tr = document.getElementById(`row-${rowId}`);
            if (tr) {
                tr.remove();
            }
            
            // Remove from data array
            rows = rows.filter(r => r.id !== rowId);
            
            renumberAllRows(); // Renumber remaining rows
            updateStats(); // Update statistics
            saveToLocalStorage(); // Save changes
            
            showAlert('Row deleted', 'success');
        }

        // Updates row data from input values
        function updateRow(rowId) {
            const row = rows.find(r => r.id === rowId);
            if (!row) return;
            
            const tr = document.getElementById(`row-${rowId}`);
            if (!tr) return;
            
            // Read all input values
            const inputs = tr.querySelectorAll('input[data-field]');
            inputs.forEach(input => {
                const field = input.dataset.field;
                if (field && row.hasOwnProperty(field)) {
                    row[field] = input.value.trim();
                }
            });
            
            // Save to autocomplete history (except baseUrl and utmId)
            Object.keys(row).forEach(key => {
                if (autocompleteData.hasOwnProperty(key) && row[key]) {
                    autocompleteData[key].add(row[key]);
                }
            });
            
            saveToLocalStorage();
        }

        // --- URL Generation ---

        // Auto-generates UTM URL for given row
        function autoGenerateUTM(rowId) {
            const row = rows.find(r => r.id === rowId);
            if (!row) return;
            
            const tr = document.getElementById(`row-${rowId}`);
            if (!tr) return;
            
            // Add visual effect
            tr.classList.add('generating');
            setTimeout(() => tr.classList.remove('generating'), 300);
            
            // Read current values from inputs
            const baseUrlInput = tr.querySelector('input[data-field="baseUrl"]');
            const utmSourceInput = tr.querySelector('input[data-field="utmSource"]');
            const utmMediumInput = tr.querySelector('input[data-field="utmMedium"]');
            const utmCampaignInput = tr.querySelector('input[data-field="utmCampaign"]');
            const utmTermInput = tr.querySelector('input[data-field="utmTerm"]');
            const utmContentInput = tr.querySelector('input[data-field="utmContent"]');
            const utmIdInput = tr.querySelector('input[data-field="utmId"]');
            const utmSourcePlatformInput = tr.querySelector('input[data-field="utmSourcePlatform"]');
            const utmCreativeFormatInput = tr.querySelector('input[data-field="utmCreativeFormat"]');
            const utmMarketingTacticInput = tr.querySelector('input[data-field="utmMarketingTactic"]');
            
            // Update row data
            row.baseUrl = baseUrlInput ? baseUrlInput.value.trim() : '';
            row.utmSource = utmSourceInput ? utmSourceInput.value.trim() : '';
            row.utmMedium = utmMediumInput ? utmMediumInput.value.trim() : '';
            row.utmCampaign = utmCampaignInput ? utmCampaignInput.value.trim() : '';
            row.utmTerm = utmTermInput ? utmTermInput.value.trim() : '';
            row.utmContent = utmContentInput ? utmContentInput.value.trim() : '';
            row.utmSourcePlatform = utmSourcePlatformInput ? utmSourcePlatformInput.value.trim() : '';
            row.utmCreativeFormat = utmCreativeFormatInput ? utmCreativeFormatInput.value.trim() : '';
            row.utmMarketingTactic = utmMarketingTacticInput ? utmMarketingTacticInput.value.trim() : '';
            
            // Handle utm_id (auto or manual)
            const isUtmIdAuto = document.getElementById('toggleUtmId').checked;
            if (isUtmIdAuto) {
                // Auto-generate utm_id based on row position
                const displayNumber = parseInt(tr.dataset.displayNumber);
                row.utmId = generateUtmId(displayNumber);
                if (utmIdInput) {
                    utmIdInput.value = row.utmId;
                }
            } else {
                // Manual utm_id from input
                row.utmId = utmIdInput ? utmIdInput.value.trim() : '';
            }
            
            // Check required fields
            if (!row.baseUrl || !row.utmSource || !row.utmMedium || !row.utmCampaign) {
                row.finalUrl = '';
                row.status = 'pending';
                updateRowUI(rowId);
                saveToLocalStorage();
                return;
            }
            
            // Validate and clean base URL
            const cleanedBaseUrl = cleanUrl(row.baseUrl);
            if (!cleanedBaseUrl) {
                row.finalUrl = '';
                row.status = 'error';
                updateRowUI(rowId);
                saveToLocalStorage();
                return;
            }
            
            // Build UTM parameters
            const params = new URLSearchParams();
            params.append('utm_source', sanitizeUtmParam(row.utmSource));
            params.append('utm_medium', sanitizeUtmParam(row.utmMedium));
            params.append('utm_campaign', sanitizeUtmParam(row.utmCampaign));
            
            if (row.utmTerm) params.append('utm_term', sanitizeUtmParam(row.utmTerm));
            if (row.utmContent) params.append('utm_content', sanitizeUtmParam(row.utmContent));
            if (row.utmId) params.append('utm_id', sanitizeUtmParam(row.utmId));
            
            // Advanced parameters (if visible)
            if (document.getElementById('togglePlatform').checked && row.utmSourcePlatform) {
                params.append('utm_source_platform', sanitizeUtmParam(row.utmSourcePlatform));
            }
            if (document.getElementById('toggleFormat').checked && row.utmCreativeFormat) {
                params.append('utm_creative_format', sanitizeUtmParam(row.utmCreativeFormat));
            }
            if (document.getElementById('toggleTactic').checked && row.utmMarketingTactic) {
                params.append('utm_marketing_tactic', sanitizeUtmParam(row.utmMarketingTactic));
            }
            
            // Construct final URL
            const separator = cleanedBaseUrl.includes('?') ? '&' : '?';
            row.finalUrl = `${cleanedBaseUrl}${separator}${params.toString()}`;
            row.status = 'auto';
            
            updateRowUI(rowId);
            saveToLocalStorage();
        }

        // Generates utm_id in format YYYYMMDD_XXX
        function generateUtmId(sequenceNumber) {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            const seq = String(sequenceNumber).padStart(3, '0');
            return `${year}${month}${day}_${seq}`;
        }

        // Cleans and validates URL
        function cleanUrl(url) {
            if (!url) return null;
            
            let cleanedUrl = url.trim();
            
            // Add protocol if missing
            if (!/^https?:\/\//i.test(cleanedUrl)) {
                cleanedUrl = 'https://' + cleanedUrl;
            }
            
            // Validate URL
            try {
                const urlObj = new URL(cleanedUrl);
                
                // Check for valid protocol
                if (!['http:', 'https:'].includes(urlObj.protocol)) {
                    console.error(`Invalid protocol: ${urlObj.protocol}`);
                    return null;
                }
                
                // Check for domain
                if (!urlObj.hostname || urlObj.hostname === '') {
                    console.error('Missing hostname');
                    return null;
                }
                
                // Remove existing UTM parameters
                const params = new URLSearchParams(urlObj.search);
                const utmParams = ['utm_source', 'utm_medium', 'utm_campaign', 'utm_term', 'utm_content', 'utm_id', 'utm_source_platform', 'utm_creative_format', 'utm_marketing_tactic'];
                utmParams.forEach(param => params.delete(param));
                
                // Rebuild URL
                urlObj.search = params.toString();
                let result = urlObj.origin + urlObj.pathname;
                if (urlObj.search) result += '?' + urlObj.search;
                if (urlObj.hash) result += urlObj.hash;
                
                return result;
            } catch (e) {
                console.error('Could not parse URL for cleaning:', e);
                return null;
            }
        }

        // Sanitizes UTM parameter (lowercase, underscores, remove invalid chars)
        function sanitizeUtmParam(value) {
            if (!value) return '';
            return value
                .toLowerCase()
                .replace(/\s+/g, '_')
                .replace(/[^a-z0-9_-]/g, '');
        }

        // Updates row UI (Final URL, Status, QR)
        function updateRowUI(rowId) {
            const row = rows.find(r => r.id === rowId);
            if (!row) return;
            
            const tr = document.getElementById(`row-${rowId}`);
            if (!tr) return;
            
            const finalUrlCell = tr.querySelector('td[data-field="finalUrl"]');
            const statusCell = tr.querySelector('td[data-field="status"]');
            const qrCell = tr.querySelector('span[data-field="qr"]');
            
            if (finalUrlCell) {
                if (row.finalUrl) {
                    finalUrlCell.textContent = row.finalUrl;
                    finalUrlCell.title = row.finalUrl;
                } else {
                    finalUrlCell.textContent = '-';
                    finalUrlCell.title = '';
                }
            }
            
            if (statusCell) {
                statusCell.className = ''; // Reset classes
                if (row.status === 'auto') {
                    statusCell.className = 'status-auto';
                    statusCell.textContent = 'üîÑ Auto';
                } else if (row.status === 'error') {
                    statusCell.className = 'status-error';
                    statusCell.textContent = '‚ùå Error';
                } else {
                    statusCell.className = 'status-pending';
                    statusCell.textContent = 'Waiting';
                }
            }
            
            if (qrCell) {
                if (row.finalUrl && row.status === 'auto') {
                    qrCell.innerHTML = `<a href="#" class="qr-link" onclick="showQRModal(${rowId}); return false;">Generate</a>`;
                } else {
                    qrCell.textContent = '-';
                }
            }
        }

        // Regenerates all URLs
        function regenerateAll() {
            renumberAllRows(); // First renumber (for utm_id)
            rows.forEach(row => {
                autoGenerateUTM(row.id);
            });
        }

        // Regenerates only URLs (without changing utm_id)
        function regenerateAllUrls() {
            rows.forEach(row => {
                autoGenerateUTM(row.id);
            });
        }

        // --- Statistics ---

        // Updates statistics (total rows, generated, errors)
        function updateStats() {
            const totalRows = rows.length;
            const generatedRows = rows.filter(r => r.status === 'auto').length;
            const errorRows = rows.filter(r => r.status === 'error').length;
            
            document.getElementById('totalRows').textContent = totalRows;
            document.getElementById('generatedRows').textContent = generatedRows;
            document.getElementById('errorRows').textContent = errorRows;
        }

        // --- Autocomplete ---

        // Handles autocomplete for input
        function handleAutocomplete(input, rowId = null) {
            const autocompleteType = input.dataset.autocomplete;
            if (!autocompleteType || !autocompleteData.hasOwnProperty(autocompleteType)) return;
            
            const value = input.value.trim().toLowerCase();
            
            // Close previous autocomplete if different input
            if (currentAutocompleteInput && currentAutocompleteInput !== input) {
                closeAutocomplete();
            }
            currentAutocompleteInput = input;
            
            // If empty, close autocomplete
            if (!value) {
                closeAutocomplete();
                return;
            }
            
            // Filter matching values
            const matches = Array.from(autocompleteData[autocompleteType])
                .filter(item => item.toLowerCase().includes(value))
                .slice(0, 10); // Max 10 suggestions
            
            if (matches.length === 0) {
                closeAutocomplete();
                return;
            }
            
            // Create or get autocomplete container
            let autocompleteDiv = input.parentElement.querySelector('.autocomplete-items');
            if (!autocompleteDiv) {
                autocompleteDiv = document.createElement('div');
                autocompleteDiv.className = 'autocomplete-items';
                input.parentElement.appendChild(autocompleteDiv);
            }
            
            // Clear previous content
            autocompleteDiv.innerHTML = '';
            
            // Add suggestions
            matches.forEach(match => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'autocomplete-item';
                
                // Highlight matching part
                const matchIndex = match.toLowerCase().indexOf(value);
                const before = match.substring(0, matchIndex);
                const matched = match.substring(matchIndex, matchIndex + value.length);
                const after = match.substring(matchIndex + value.length);
                
                itemDiv.innerHTML = `${before}<strong>${matched}</strong>${after}`;
                
                itemDiv.addEventListener('click', function() {
                    input.value = match;
                    closeAutocomplete();
                    if (rowId) {
                        autoGenerateUTM(rowId);
                    }
                });
                
                autocompleteDiv.appendChild(itemDiv);
            });
        }

        // Closes autocomplete
        function closeAutocomplete() {
            const autocompleteItems = document.querySelectorAll('.autocomplete-items');
            autocompleteItems.forEach(item => item.remove());
            currentAutocompleteInput = null;
        }

        // Close autocomplete when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.matches('input[data-autocomplete]')) {
                closeAutocomplete();
            }
        });

        // --- Quick Fill ---

        // Applies quick fill to all empty rows
        function applyQuickFill() {
            const quickBaseUrl = document.getElementById('quickBaseUrl').value.trim();
            const quickSource = document.getElementById('quickSource').value.trim();
            const quickMedium = document.getElementById('quickMedium').value.trim();
            const quickCampaign = document.getElementById('quickCampaign').value.trim();
            const quickTerm = document.getElementById('quickTerm').value.trim();
            const quickContent = document.getElementById('quickContent').value.trim();
            const quickPlatform = document.getElementById('quickPlatform').value.trim();
            const quickFormat = document.getElementById('quickFormat').value.trim();
            const quickTactic = document.getElementById('quickTactic').value.trim();
            
            let filledCount = 0;
            
            rows.forEach(row => {
                const tr = document.getElementById(`row-${row.id}`);
                if (!tr) return;
                
                let rowWasEmpty = false;
                
                // Check if row is empty (no baseUrl, source, medium, campaign)
                if (!row.baseUrl && !row.utmSource && !row.utmMedium && !row.utmCampaign) {
                    rowWasEmpty = true;
                }
                
                if (rowWasEmpty) {
                    // Fill inputs
                    if (quickBaseUrl) {
                        const input = tr.querySelector('input[data-field="baseUrl"]');
                        if (input) input.value = quickBaseUrl;
                        row.baseUrl = quickBaseUrl;
                    }
                    if (quickSource) {
                        const input = tr.querySelector('input[data-field="utmSource"]');
                        if (input) input.value = quickSource;
                        row.utmSource = quickSource;
                    }
                    if (quickMedium) {
                        const input = tr.querySelector('input[data-field="utmMedium"]');
                        if (input) input.value = quickMedium;
                        row.utmMedium = quickMedium;
                    }
                    if (quickCampaign) {
                        const input = tr.querySelector('input[data-field="utmCampaign"]');
                        if (input) input.value = quickCampaign;
                        row.utmCampaign = quickCampaign;
                    }
                    if (quickTerm) {
                        const input = tr.querySelector('input[data-field="utmTerm"]');
                        if (input) input.value = quickTerm;
                        row.utmTerm = quickTerm;
                    }
                    if (quickContent) {
                        const input = tr.querySelector('input[data-field="utmContent"]');
                        if (input) input.value = quickContent;
                        row.utmContent = quickContent;
                    }
                    if (quickPlatform) {
                        const input = tr.querySelector('input[data-field="utmSourcePlatform"]');
                        if (input) input.value = quickPlatform;
                        row.utmSourcePlatform = quickPlatform;
                    }
                    if (quickFormat) {
                        const input = tr.querySelector('input[data-field="utmCreativeFormat"]');
                        if (input) input.value = quickFormat;
                        row.utmCreativeFormat = quickFormat;
                    }
                    if (quickTactic) {
                        const input = tr.querySelector('input[data-field="utmMarketingTactic"]');
                        if (input) input.value = quickTactic;
                        row.utmMarketingTactic = quickTactic;
                    }
                    
                    filledCount++;
                    autoGenerateUTM(row.id);
                }
            });
            
            if (filledCount > 0) {
                showAlert(`‚úÖ Quick fill applied to ${filledCount} empty row(s)`, 'success');
            } else {
                showAlert('‚ö†Ô∏è No empty rows found', 'info');
            }
        }

        // --- Export Functions ---

        // Exports to CSV
        function exportToCSV() {
            if (rows.length === 0) {
                showAlert('No data to export', 'error');
                return;
            }
            
            const headers = ['#', 'Base URL', 'utm_source', 'utm_medium', 'utm_campaign', 'utm_term', 'utm_content', 'utm_id'];
            if (document.getElementById('togglePlatform').checked) headers.push('utm_source_platform');
            if (document.getElementById('toggleFormat').checked) headers.push('utm_creative_format');
            if (document.getElementById('toggleTactic').checked) headers.push('utm_marketing_tactic');
            headers.push('Final UTM URL', 'Status');
            
            let csv = headers.join(',') + '\n';
            
            rows.forEach((row, index) => {
                const rowData = [
                    index + 1,
                    `"${row.baseUrl.replace(/"/g, '""')}"`,
                    `"${row.utmSource.replace(/"/g, '""')}"`,
                    `"${row.utmMedium.replace(/"/g, '""')}"`,
                    `"${row.utmCampaign.replace(/"/g, '""')}"`,
                    `"${row.utmTerm.replace(/"/g, '""')}"`,
                    `"${row.utmContent.replace(/"/g, '""')}"`,
                    `"${row.utmId.replace(/"/g, '""')}"`
                ];
                
                if (document.getElementById('togglePlatform').checked) {
                    rowData.push(`"${row.utmSourcePlatform.replace(/"/g, '""')}"`);
                }
                if (document.getElementById('toggleFormat').checked) {
                    rowData.push(`"${row.utmCreativeFormat.replace(/"/g, '""')}"`);
                }
                if (document.getElementById('toggleTactic').checked) {
                    rowData.push(`"${row.utmMarketingTactic.replace(/"/g, '""')}"`);
                }
                
                rowData.push(`"${row.finalUrl.replace(/"/g, '""')}"`);
                
                const statusText = row.status === 'auto' ? 'Generated' : (row.status === 'error' ? 'Error' : 'Pending');
                rowData.push(`"${statusText}"`);
                
                csv += rowData.join(',') + '\n';
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            const today = new Date().toISOString().slice(0, 10);
            link.setAttribute('download', `utm_links_${today}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showAlert('CSV file exported successfully', 'success');
        }

        // Exports to Excel
        function exportToExcel() {
            if (rows.length === 0) {
                showAlert('No data to export', 'error');
                return;
            }
            
            if (typeof XLSX === 'undefined') {
                showAlert('Excel library not loaded. Please check your internet connection.', 'error');
                return;
            }
            
            const headers = ['#', 'Base URL', 'utm_source', 'utm_medium', 'utm_campaign', 'utm_term', 'utm_content', 'utm_id'];
            if (document.getElementById('togglePlatform').checked) headers.push('utm_source_platform');
            if (document.getElementById('toggleFormat').checked) headers.push('utm_creative_format');
            if (document.getElementById('toggleTactic').checked) headers.push('utm_marketing_tactic');
            headers.push('Final UTM URL', 'Status');
            
            const data = [headers];
            
            rows.forEach((row, index) => {
                const rowData = [
                    index + 1,
                    row.baseUrl,
                    row.utmSource,
                    row.utmMedium,
                    row.utmCampaign,
                    row.utmTerm,
                    row.utmContent,
                    row.utmId
                ];
                
                if (document.getElementById('togglePlatform').checked) {
                    rowData.push(row.utmSourcePlatform);
                }
                if (document.getElementById('toggleFormat').checked) {
                    rowData.push(row.utmCreativeFormat);
                }
                if (document.getElementById('toggleTactic').checked) {
                    rowData.push(row.utmMarketingTactic);
                }
                
                rowData.push(row.finalUrl);
                
                const statusText = row.status === 'auto' ? 'Generated' : (row.status === 'error' ? 'Error' : 'Pending');
                rowData.push(statusText);
                
                data.push(rowData);
            });
            
            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'UTM Links');
            
            const today = new Date().toISOString().slice(0, 10);
            XLSX.writeFile(wb, `utm_links_${today}.xlsx`);
            
            showAlert('Excel file exported successfully', 'success');
        }

        // --- localStorage Functions ---

        // Loads data from localStorage
        function loadFromLocalStorage() {
            try {
                // Load rows
                const savedRows = localStorage.getItem(STORAGE_KEYS.rows);
                if (savedRows) {
                    rows = JSON.parse(savedRows);
                    console.log(`üì¶ Loaded ${rows.length} rows from localStorage`);
                }
                
                // Load counter
                const savedCounter = localStorage.getItem(STORAGE_KEYS.counter);
                if (savedCounter) {
                    rowCounter = parseInt(savedCounter);
                    console.log(`üî¢ Loaded counter: ${rowCounter}`);
                }
                
                // Load autocomplete history
                const savedAutocomplete = localStorage.getItem(STORAGE_KEYS.autocomplete);
                if (savedAutocomplete) {
                    const parsed = JSON.parse(savedAutocomplete);
                    Object.keys(parsed).forEach(key => {
                        if (autocompleteData.hasOwnProperty(key)) {
                            autocompleteData[key] = new Set(parsed[key]);
                        }
                    });
                    console.log(`üìù Loaded autocomplete history`);
                }
                
                // Load toggle states
                const toggleId = localStorage.getItem(STORAGE_KEYS.toggleId);
                if (toggleId !== null) {
                    document.getElementById('toggleUtmId').checked = (toggleId === 'true');
                }
                
                const togglePlatform = localStorage.getItem(STORAGE_KEYS.togglePlatform);
                if (togglePlatform !== null) {
                    document.getElementById('togglePlatform').checked = (togglePlatform === 'true');
                }
                
                const toggleFormat = localStorage.getItem(STORAGE_KEYS.toggleFormat);
                if (toggleFormat !== null) {
                    document.getElementById('toggleFormat').checked = (toggleFormat === 'true');
                }
                
                const toggleTactic = localStorage.getItem(STORAGE_KEYS.toggleTactic);
                if (toggleTactic !== null) {
                    document.getElementById('toggleTactic').checked = (toggleTactic === 'true');
                }
                
                // Apply column visibility
                updateColumnVisibility();
                
                // Rebuild table from loaded data
                if (rows.length > 0) {
                    const tbody = document.getElementById('tableBody');
                    tbody.innerHTML = ''; // Clear existing rows
                    
                    rows.forEach(rowData => {
                        addRow(rowData);
                    });
                }
                
            } catch (error) {
                console.error('Error loading from localStorage:', error);
                showAlert('Error loading data from storage', 'error');
            }
        }

        // Saves data to localStorage
        function saveToLocalStorage() {
            try {
                // Save rows
                localStorage.setItem(STORAGE_KEYS.rows, JSON.stringify(rows));
                
                // Save counter
                localStorage.setItem(STORAGE_KEYS.counter, rowCounter.toString());
                
                // Save autocomplete history
                const autocompleteToSave = {};
                Object.keys(autocompleteData).forEach(key => {
                    autocompleteToSave[key] = Array.from(autocompleteData[key]);
                });
                localStorage.setItem(STORAGE_KEYS.autocomplete, JSON.stringify(autocompleteToSave));
                
                // Save toggle states
                localStorage.setItem(STORAGE_KEYS.toggleId, document.getElementById('toggleUtmId').checked.toString());
                localStorage.setItem(STORAGE_KEYS.togglePlatform, document.getElementById('togglePlatform').checked.toString());
                localStorage.setItem(STORAGE_KEYS.toggleFormat, document.getElementById('toggleFormat').checked.toString());
                localStorage.setItem(STORAGE_KEYS.toggleTactic, document.getElementById('toggleTactic').checked.toString());
                
            } catch (error) {
                console.error('Error saving to localStorage:', error);
                if (error.name === 'QuotaExceededError') {
                    showAlert('‚ö†Ô∏è Storage quota exceeded! Please create a backup and clear old data.', 'error');
                } else {
                    showAlert('Error saving data to storage', 'error');
                }
            }
        }

        // === STATISTICS TO CONSOLE ===
        function logAppStatistics() {
            console.log('%c' + '‚îÄ'.repeat(50), 'color: #e0e0e0;');
            console.log('%cüìä Application Statistics', 'color: #1e88e5; font-size: 14px; font-weight: bold;');
            console.log('%c' + '‚îÄ'.repeat(50), 'color: #e0e0e0;');
            
            // Basic stats
            console.log(`üìã Total rows: ${rows.length}`);
            console.log(`‚úÖ Generated URLs: ${rows.filter(r => r.status === 'auto').length}`);
            console.log(`‚ùå Errors: ${rows.filter(r => r.status === 'error').length}`);
            console.log(`‚è≥ Pending: ${rows.filter(r => r.status === 'pending').length}`);
            
            // Autocomplete stats
            let totalAutocompleteItems = 0;
            Object.keys(autocompleteData).forEach(key => {
                totalAutocompleteItems += autocompleteData[key].size;
            });
            console.log(`üîç Autocomplete history items: ${totalAutocompleteItems}`);
            
            // Settings
            console.log(`‚öôÔ∏è Auto utm_id: ${document.getElementById('toggleUtmId').checked}`);
            console.log(`‚öôÔ∏è Show platform: ${document.getElementById('togglePlatform').checked}`);
            console.log(`‚öôÔ∏è Show format: ${document.getElementById('toggleFormat').checked}`);
            console.log(`‚öôÔ∏è Show tactic: ${document.getElementById('toggleTactic').checked}`);
            
            // Data size in localStorage (approximate)
            try {
                const dataSize = JSON.stringify(rows).length + JSON.stringify(Array.from(autocompleteData)).length;
                const dataSizeKB = (dataSize / 1024).toFixed(2);
                console.log(`üíæ Approximate data size: ${dataSizeKB} KB`);
            } catch(e) {
                console.log(`üíæ Data size: cannot determine`);
            }
            
            console.log('%c' + '‚îÄ'.repeat(50), 'color: #e0e0e0;');
        }
        // === END STATISTICS ===

        // --- Backup / Restore ---

        // Creates and downloads JSON backup
        function backupData() {
            try {
                // Convert Set objects in autocompleteData to arrays for JSON serialization
                const autocompleteToSave = {};
                for (const key in autocompleteData) {
                    if (autocompleteData.hasOwnProperty(key)) {
                        autocompleteToSave[key] = Array.from(autocompleteData[key]);
                    }
                }
                // Create backup object containing rows and history
                const backupObject = {
                    version: APP_VERSION,
                    storageVersion: STORAGE_VERSION,
                    exportDate: new Date().toISOString(),
                    rows: rows,
                    autocompleteData: autocompleteToSave
                };
                // Convert to JSON with indentation for better readability
                const jsonString = JSON.stringify(backupObject, null, 2);
                // Create Blob (binary data)
                const blob = new Blob([jsonString], { type: 'application/json;charset=utf-8;' });
                // Create temporary download link
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                const today = new Date().toISOString().slice(0, 10);
                link.setAttribute("download", `utm_backup_${today}.json`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                showAlert('Data backup downloaded successfully', 'success');
            } catch (error) {
                console.error("Backup error:", error);
                showAlert('Failed to create backup', 'error');
            }
        }

        // Starts data restore process (triggers click on hidden input)
        function restoreData() {
            if (confirm('Do you really want to restore data from backup? All current data (rows and autocomplete history) will be overwritten!')) {
                document.getElementById('restoreFile').click();
            }
        }

        // Processes selected file for restore
        function handleRestoreFileSelect(event) {
            const file = event.target.files[0];
            
            if (!file) {
                showAlert('No file selected', 'error');
                return;
            }
            
            // Type check - JSON can have various MIME types
            const validTypes = ['application/json', 'text/plain', ''];
            if (!validTypes.includes(file.type) && !file.name.endsWith('.json')) {
                showAlert('Error: Selected file is not a valid JSON file', 'error');
                event.target.value = null;
                return;
            }
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    const backupObject = JSON.parse(content);

                    // === VERSION CHECK (informative) ===
                    if (backupObject.version) {
                        console.log(`üì¶ Restoring backup from version ${backupObject.version} (current: ${APP_VERSION})`);
                        if (backupObject.version !== APP_VERSION) {
                            console.warn(`‚ö†Ô∏è Different versions: backup=${backupObject.version}, app=${APP_VERSION}`);
                        }
                    } else {
                        console.log('üì¶ Restoring backup (no version info - older format)');
                    }
                    // === END VERSION CHECK ===
                    
                    // Structure validation
                    if (!backupObject || typeof backupObject !== 'object') {
                        throw new Error('File does not contain valid object');
                    }
                    if (!Array.isArray(backupObject.rows)) {
                        throw new Error('Missing "rows" field or not an array');
                    }
                    if (!backupObject.autocompleteData || typeof backupObject.autocompleteData !== 'object') {
                        throw new Error('Missing "autocompleteData"');
                    }
                    
                    // Delete existing data
                    rows = [];
                    document.getElementById('tableBody').innerHTML = '';
                    
                    // Restore autocomplete
                    autocompleteData = {
                        utm_source: new Set(),
                        utm_medium: new Set(),
                        utm_campaign: new Set(),
                        utm_term: new Set(),
                        utm_content: new Set(),
                        utm_source_platform: new Set(),
                        utm_creative_format: new Set(),
                        utm_marketing_tactic: new Set()
                    };
                    
                    Object.keys(backupObject.autocompleteData).forEach(key => {
                        if (autocompleteData.hasOwnProperty(key) && Array.isArray(backupObject.autocompleteData[key])) {
                            autocompleteData[key] = new Set(backupObject.autocompleteData[key]);
                        }
                    });
                    
                    // Check if utm_id auto-generation is enabled
                    const isUtmIdAuto = document.getElementById('toggleUtmId').checked;
                    const tbody = document.getElementById('tableBody');

                    // Restore rows - create HTML directly
                    let maxId = 0;
                    backupObject.rows.forEach((rowData, index) => {
                        if (rowData && rowData.id != null) {
                            maxId = Math.max(maxId, rowData.id);
                            const rowId = rowData.id;
                            
                            // Create HTML row directly
                            const tr = document.createElement('tr');
                            tr.id = `row-${rowId}`;
                            tr.dataset.rowId = rowId;
                            tr.dataset.displayNumber = index + 1;
                            
                            tr.innerHTML = `
                                <td class="row-number">${index + 1}</td>
                                <td><input type="url" data-field="baseUrl" value="${rowData.baseUrl || ''}" placeholder="https://www.example.com" oninput="autoGenerateUTM(${rowId})" onchange="updateRow(${rowId})"></td>
                                <td class="autocomplete-wrapper"><input type="text" data-field="utmSource" data-autocomplete="utm_source" value="${rowData.utmSource || ''}" placeholder="facebook" oninput="handleAutocomplete(this, ${rowId}); autoGenerateUTM(${rowId})" onchange="updateRow(${rowId})"></td>
                                <td class="autocomplete-wrapper"><input type="text" data-field="utmMedium" data-autocomplete="utm_medium" value="${rowData.utmMedium || ''}" placeholder="social" oninput="handleAutocomplete(this, ${rowId}); autoGenerateUTM(${rowId})" onchange="updateRow(${rowId})"></td>
                                <td class="autocomplete-wrapper"><input type="text" data-field="utmCampaign" data-autocomplete="utm_campaign" value="${rowData.utmCampaign || ''}" placeholder="summer_sale" oninput="handleAutocomplete(this, ${rowId}); autoGenerateUTM(${rowId})" onchange="updateRow(${rowId})"></td>
                                <td class="autocomplete-wrapper"><input type="text" data-field="utmTerm" data-autocomplete="utm_term" value="${rowData.utmTerm || ''}" placeholder="keywords" oninput="handleAutocomplete(this, ${rowId}); autoGenerateUTM(${rowId})" onchange="updateRow(${rowId})"></td>
                                <td class="autocomplete-wrapper"><input type="text" data-field="utmContent" data-autocomplete="utm_content" value="${rowData.utmContent || ''}" placeholder="banner_01" oninput="handleAutocomplete(this, ${rowId}); autoGenerateUTM(${rowId})" onchange="updateRow(${rowId})"></td>
                                <td><input type="text" data-field="utmId" value="${!isUtmIdAuto && rowData.utmId ? rowData.utmId : ''}" placeholder="${isUtmIdAuto ? 'Auto' : 'Enter ID'}" ${isUtmIdAuto ? 'readonly style="background: #f5f5f5; cursor: not-allowed;"' : 'style="background: white; cursor: text;"'} oninput="autoGenerateUTM(${rowId})" onchange="updateRow(${rowId})"></td>
                                <td class="autocomplete-wrapper col-platform"><input type="text" data-field="utmSourcePlatform" data-autocomplete="utm_source_platform" value="${rowData.utmSourcePlatform || ''}" placeholder="facebook_ads" oninput="handleAutocomplete(this, ${rowId}); autoGenerateUTM(${rowId})" onchange="updateRow(${rowId})"></td>
                                <td class="autocomplete-wrapper col-format"><input type="text" data-field="utmCreativeFormat" data-autocomplete="utm_creative_format" value="${rowData.utmCreativeFormat || ''}" placeholder="video" oninput="handleAutocomplete(this, ${rowId}); autoGenerateUTM(${rowId})" onchange="updateRow(${rowId})"></td>
                                <td class="autocomplete-wrapper col-tactic"><input type="text" data-field="utmMarketingTactic" data-autocomplete="utm_marketing_tactic" value="${rowData.utmMarketingTactic || ''}" placeholder="awareness" oninput="handleAutocomplete(this, ${rowId}); autoGenerateUTM(${rowId})" onchange="updateRow(${rowId})"></td>
                                <td class="output-cell" data-field="finalUrl">-</td>
                                <td class="status-pending" data-field="status">Waiting for data</td>
                                <td><span data-field="qr">-</span></td>
                                <td>
                                    <div class="action-btns">
                                        <button class="icon-btn copy" onclick="copyToClipboard(${rowId})" title="Copy Final URL">üìÑ</button>
                                        <button class="icon-btn duplicate" onclick="duplicateRow(${rowId})" title="Duplicate row">‚ûï</button>
                                        <button class="icon-btn delete" onclick="deleteRow(${rowId})" title="Delete row">üóëÔ∏è</button>
                                    </div>
                                </td>
                            `;
                            
                            tbody.appendChild(tr);
                            rows.push(rowData);
                        }
                    });

                    rowCounter = maxId;
                    regenerateAll();
                    saveToLocalStorage();
                    
                    showAlert('Data restored successfully! Number of rows: ' + backupObject.rows.length, 'success');
                    
                } catch (error) {
                    console.error('Restore error:', error);
                    showAlert('Error restoring data: ' + error.message, 'error');
                    loadFromLocalStorage();
                } finally {
                    event.target.value = null;
                }
            };
            
            reader.onerror = function(e) {
                console.error('File reading error:', e);
                showAlert('Error reading file', 'error');
                event.target.value = null;
            };
            
            reader.readAsText(file);
        }

        // --- End Backup / Restore ---

        // --- Other Functions ---

        // Shows help modal
        function showHelp() {
            document.getElementById('helpModal').style.display = 'block';
        }

        // Closes help modal
        function closeHelpModal() {
            document.getElementById('helpModal').style.display = 'none';
        }

        // Global listener for closing modals by clicking outside them
        window.onclick = function(event) {
            const qrModal = document.getElementById('qrModal');
            const helpModal = document.getElementById('helpModal');
            if (event.target == qrModal) {
                closeQRModal();
            }
            if (event.target == helpModal) {
                closeHelpModal();
            }
        }

        // Copies Final URL to clipboard
        function copyToClipboard(rowId) {
            const row = rows.find(r => r.id === rowId);
            if (!row || !row.finalUrl || row.status !== 'auto') {
                showAlert('Nothing to copy. Please generate UTM link first.', 'error');
                return;
            }
            
            // Modern Clipboard API (works in most browsers)
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(row.finalUrl)
                    .then(() => {
                        // Visual feedback
                        const btn = document.querySelector(`#row-${rowId} .icon-btn.copy`);
                        if (btn) {
                            const originalText = btn.textContent;
                            btn.classList.add('copied');
                            btn.textContent = '‚úì';
                            
                            setTimeout(() => {
                                btn.classList.remove('copied');
                                btn.textContent = originalText;
                            }, 1500);
                        }
                        showAlert('URL copied to clipboard!', 'success');
                    })
                    .catch(err => {
                        console.error('Clipboard error:', err);
                        fallbackCopyToClipboard(row.finalUrl, rowId);
                    });
            } else {
                // Fallback for older browsers
                fallbackCopyToClipboard(row.finalUrl, rowId);
            }
        }

        // Fallback method for copying (older browsers)
        function fallbackCopyToClipboard(text, rowId) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    const btn = document.querySelector(`#row-${rowId} .icon-btn.copy`);
                    if (btn) {
                        const originalText = btn.textContent;
                        btn.classList.add('copied');
                        btn.textContent = '‚úì';
                        setTimeout(() => {
                            btn.classList.remove('copied');
                            btn.textContent = originalText;
                        }, 1500);
                    }
                    showAlert('URL copied to clipboard!', 'success');
                } else {
                    showAlert('Failed to copy URL. Please try manually.', 'error');
                }
            } catch (err) {
                console.error('Fallback copy error:', err);
                showAlert('Copying not supported in this browser.', 'error');
            } finally {
                document.body.removeChild(textarea);
            }
        }

        // Clears all rows
        function clearAll() {
            if (!confirm('Do you really want to delete all rows? This action cannot be undone!\n\n(Autocomplete history and settings will be preserved)')) return;
            
            rows = [];
            document.getElementById('tableBody').innerHTML = '';
            rowCounter = 0;
            
            updateStats();
            saveToLocalStorage();
            
            showAlert('All rows deleted', 'success');
        }

        // Clears autocomplete history
        function clearAutocompleteHistory() {
            if (!confirm('Do you really want to clear autocomplete history? This action cannot be undone!')) return;
            
            autocompleteData = {
                utm_source: new Set(),
                utm_medium: new Set(),
                utm_campaign: new Set(),
                utm_term: new Set(),
                utm_content: new Set(),
                utm_source_platform: new Set(),
                utm_creative_format: new Set(),
                utm_marketing_tactic: new Set()
            };
            
            saveToLocalStorage();
            showAlert('Autocomplete history cleared', 'success');
        }

        // Resets application to default state
        function resetApplicationState() {
            if (!confirm('‚ö†Ô∏è WARNING!\n\nThis will delete ALL data including:\n- All rows\n- Autocomplete history\n- All settings\n\nThis action CANNOT be undone!\n\nDo you want to continue?')) return;
            
            if (!confirm('Are you ABSOLUTELY SURE? This is your last chance to cancel!')) return;
            
            // Clear all data
            rows = [];
            rowCounter = 0;
            autocompleteData = {
                utm_source: new Set(),
                utm_medium: new Set(),
                utm_campaign: new Set(),
                utm_term: new Set(),
                utm_content: new Set(),
                utm_source_platform: new Set(),
                utm_creative_format: new Set(),
                utm_marketing_tactic: new Set()
            };
            
            // Clear localStorage
            Object.values(STORAGE_KEYS).forEach(key => {
                localStorage.removeItem(key);
            });
            
            // Reset UI
            document.getElementById('tableBody').innerHTML = '';
            document.getElementById('toggleUtmId').checked = true;
            document.getElementById('togglePlatform').checked = false;
            document.getElementById('toggleFormat').checked = false;
            document.getElementById('toggleTactic').checked = false;
            
            updateColumnVisibility();
            updateStats();
            
            // Add default rows
            addRow();
            addRow();
            addRow();
            
            showAlert('‚úÖ Application reset to default state', 'success');
        }

        // Shows alert message
        function showAlert(message, type = 'info') {
            const alertBox = document.getElementById('alertBox');
            alertBox.className = 'alert show';
            
            if (type === 'success') {
                alertBox.className += ' alert-success';
            } else if (type === 'error') {
                alertBox.className += ' alert-error';
            } else {
                alertBox.className += ' alert-info';
            }
            
            alertBox.textContent = message;
            
            setTimeout(() => {
                alertBox.className = 'alert';
            }, 5000);
        }

        // --- QR Code Functions ---

        // Shows QR modal
        function showQRModal(rowId) {
            const row = rows.find(r => r.id === rowId);
            if (!row || !row.finalUrl) {
                showAlert('No URL to generate QR code', 'error');
                return;
            }
            
            currentQRUrlForDownload = row.finalUrl;
            document.getElementById('qrModal').style.display = 'block';
            updateQRPreview();
            
            // Show URL in modal
            document.getElementById('qrUrl').textContent = row.finalUrl;
        }

        // Closes QR modal
        function closeQRModal() {
            document.getElementById('qrModal').style.display = 'none';
            currentQRUrlForDownload = '';
        }

        // Updates QR preview
        function updateQRPreview() {
            if (!currentQRUrlForDownload) return;
            
            const size = 300;
            const margin = document.getElementById('qrMargin').value;
            const ecc = document.getElementById('qrEccLevel').value;
            const color = document.getElementById('qrColor').value.replace('#', '');
            const bgcolor = document.getElementById('qrBgColor').value.replace('#', '');
            
            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?data=${encodeURIComponent(currentQRUrlForDownload)}&size=${size}x${size}&margin=${margin}&ecc=${ecc}&color=${color}&bgcolor=${bgcolor}`;
            
            document.getElementById('qrImage').src = qrUrl;
        }

        // Downloads QR code
        function downloadQR(format) {
            if (!currentQRUrlForDownload) return;
            
            const size = 1000; // Higher resolution for download
            const margin = document.getElementById('qrMargin').value;
            const ecc = document.getElementById('qrEccLevel').value;
            const color = document.getElementById('qrColor').value.replace('#', '');
            const bgcolor = document.getElementById('qrBgColor').value.replace('#', '');
            
            let qrUrl = `https://api.qrserver.com/v1/create-qr-code/?data=${encodeURIComponent(currentQRUrlForDownload)}&size=${size}x${size}&margin=${margin}&ecc=${ecc}&color=${color}&bgcolor=${bgcolor}&format=${format}`;
            
            const link = document.createElement('a');
            link.href = qrUrl;
            link.download = `qr_code_${new Date().getTime()}.${format}`;
            link.target = '_blank';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showAlert(`QR code downloaded as ${format.toUpperCase()}`, 'success');
        }

        // Handles hex input for color picker
        function handleHexInput(input, colorPickerId) {
            let value = input.value.trim();
            
            // Add # if missing
            if (value && !value.startsWith('#')) {
                value = '#' + value;
            }
            
            // Validate hex color
            const hexRegex = /^#([0-9A-Fa-f]{3}){1,2}$/;
            if (hexRegex.test(value)) {
                document.getElementById(colorPickerId).value = value;
                input.value = value;
            }
        }

        // Handles Enter key in hex input
        function handleHexEnter(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                updateQRPreview();
            }
        }

        // Log statistics on page load (after everything is initialized)
        window.addEventListener('load', function() {
            setTimeout(logAppStatistics, 500);
        });
    </script>
</body>
</html>